<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VocalTune Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React & Libraries (UMD - Strict Version Control) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1c2333",
                        "surface-border": "#2e3440",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    boxShadow: { "glow": "0 0 20px rgba(19, 91, 236, 0.4)" }
                },
            },
        }
    </script>
    <style>
        body { background-color: #101622; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3b4354; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #135bec; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #135bec; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #3b4354; border-radius: 2px; }
        
        /* Layout utility */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="font-display antialiased text-slate-900 dark:text-white h-[100dvh] w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams, useLocation } = ReactRouterDOM;

        // --- CONSTANTS ---
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTE_FREQUENCIES = { "C1": 32.7, "C#1": 34.65, "D1": 36.71, "D#1": 38.89, "E1": 41.2, "F1": 43.65, "F#1": 46.25, "G1": 49, "G#1": 51.91, "A1": 55, "A#1": 58.27, "B1": 61.74, "C2": 65.41, "C#2": 69.3, "D2": 73.42, "D#2": 77.78, "E2": 82.41, "F2": 87.31, "F#2": 92.5, "G2": 98, "G#2": 103.83, "A2": 110, "A#2": 116.54, "B2": 123.47, "C3": 130.81, "C#3": 138.59, "D3": 146.83, "D#3": 155.56, "E3": 164.81, "F3": 174.61, "F#3": 185, "G3": 196, "G#3": 207.65, "A3": 220, "A#3": 233.08, "B3": 246.94, "C4": 261.63, "C#4": 277.18, "D4": 293.66, "D#4": 311.13, "E4": 329.63, "F4": 349.23, "F#4": 369.99, "G4": 392, "G#4": 415.3, "A4": 440, "A#4": 466.16, "B4": 493.88, "C5": 523.25, "C#5": 554.37, "D5": 587.33, "D#5": 622.25, "E5": 659.25, "F5": 698.46, "F#5": 739.99, "G5": 783.99, "G#5": 830.61, "A5": 880, "A#5": 932.33, "B5": 987.77, "C6": 1046.5, "C#6": 1108.73, "D6": 1174.66, "D#6": 1244.51, "E6": 1318.51, "F6": 1396.91, "F#6": 1479.98, "G6": 1567.98, "G#6": 1661.22, "A6": 1760, "A#6": 1864.66, "B6": 1975.53 };
        const SCALE_INTERVALS = { 'Mayor': [0, 2, 4, 5, 7, 9, 11, 12], 'Menor Natural': [0, 2, 3, 5, 7, 8, 10, 12], 'Menor': [0, 2, 3, 5, 7, 8, 10, 12], 'Cromática': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'Dórica': [0, 2, 3, 5, 7, 9, 10, 12], 'Flamenca': [0, 2, 3, 5, 7, 8, 11, 12], 'Flamenca 8va Descendente': [0, 12, 11, 8, 7, 5, 3, 2, 0], 'Aumentada': [0, 3, 4, 7, 8, 11, 12], 'Arpegio Mayor': [0, 4, 7, 12], 'Arpegio Menor': [0, 3, 7, 12], 'Arpegio Disminuido': [0, 3, 6, 9, 12], 'Rossini': [0, 4, 7, 12, 16, 19, 17, 14, 11, 7, 5, 2, 0], 'Progresión por Terceras': [0, 4, 2, 5, 4, 7, 5, 9, 7, 11, 9, 12, 11, 14, 12], 'Rossini Arpeggio': [0, 4, 7, 11, 12], 'Pentatónica Mayor': [0, 2, 4, 7, 9, 12], 'Pentatónica Menor': [0, 3, 5, 7, 10, 12], 'Blues': [0, 3, 5, 6, 7, 10, 12] };
        const HEALTH_TIPS = [{ id: 1, title: "Hidratación Inteligente", icon: "water_drop", content: "Las cuerdas vocales vibran mejor cuando están bien lubricadas. Bebe agua a lo largo del día...", source: "NIDCD", sourceUrl: "https://www.nidcd.nih.gov/" }, { id: 2, title: "Descanso Vocal", icon: "bedtime", content: "Si has cantado mucho, intenta periodos de 15-20 minutos de silencio...", source: "Duke Health", sourceUrl: "https://www.dukehealth.org/" }, { id: 3, title: "Evita el Carraspeo", icon: "do_not_touch", content: "Carraspear golpea violentamente las cuerdas vocales...", source: "Texas Voice Center", sourceUrl: "https://www.texasvoicecenter.com/" }, { id: 4, title: "Calentamiento", icon: "self_improvement", content: "Nunca cantes 'en frío'...", source: "British Voice Association", sourceUrl: "https://www.britishvoiceassociation.org.uk/" }, { id: 5, title: "Reflujo", icon: "restaurant", content: "El reflujo gastroesofágico puede quemar las cuerdas vocales...", source: "Cleveland Clinic", sourceUrl: "https://my.clevelandclinic.org/" }];
        
        // --- AUDIO SERVICE (FULL LOGIC) ---
        class PianoAudioService {
            constructor() { 
                this.ctx = null; 
                this.buffers = {}; 
                this.activeSources = []; 
                this.currentPlaybackId = 0; 
                this.noteMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb" }; 
                
                ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => 
                    document.addEventListener(evt, () => { 
                        this.initContext(); 
                    }, { once: true })
                ); 
            }

            initContext() { 
                if (!this.ctx) { 
                    const AudioContext = window.AudioContext || window.webkitAudioContext; 
                    if (AudioContext) { this.ctx = new AudioContext(); } 
                }
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume().catch(e => console.warn("Resume failed", e));
                }
            }

            async resume() {
                this.initContext();
                if (this.ctx?.state === 'suspended') {
                    await this.ctx.resume();
                }
            }

            stop() { 
                this.currentPlaybackId++; 
                this.activeSources.forEach(s => { 
                    try { s.stop(); s.disconnect(); } catch (e) {} 
                }); 
                this.activeSources = []; 
            }

            mapNoteToFileName(note) { 
                const match = note.match(/^([A-G][#]?)(-?\d+)$/); 
                if (!match) return note; 
                let [_, name, octave] = match; 
                if (this.noteMap[name]) name = this.noteMap[name]; 
                return `${name}${octave}`; 
            }

            async fetchSample(noteFile) { 
                const response = await fetch(`https://raw.githubusercontent.com/fuhton/piano-mp3/master/piano-mp3/${noteFile}.mp3`); 
                if (!response.ok) throw new Error(`Failed to load ${noteFile}`);
                const ab = await response.arrayBuffer(); 
                if (this.ctx) return await this.ctx.decodeAudioData(ab); 
                throw new Error("No ctx"); 
            }

            async preloadNotes(notes) { 
                this.initContext();
                const unique = [...new Set(notes)]; 
                await Promise.allSettled(unique.map(async (n) => { 
                    const f = this.mapNoteToFileName(n); 
                    if (!this.buffers[f]) { 
                        try { this.buffers[f] = await this.fetchSample(f); } catch (e) { console.warn("Sample load failed", e); } 
                    } 
                })); 
            }

            playBufferAt(buffer, startTime, duration, volume = 1.0) { 
                if (!this.ctx) return; 
                const s = this.ctx.createBufferSource(); 
                const g = this.ctx.createGain(); 
                s.buffer = buffer; 
                s.connect(g); 
                g.connect(this.ctx.destination); 
                
                g.gain.setValueAtTime(0, startTime); 
                g.gain.linearRampToValueAtTime(volume, startTime + 0.015); 
                g.gain.exponentialRampToValueAtTime(volume * 0.6, startTime + duration * 0.4); 
                g.gain.exponentialRampToValueAtTime(0.001, startTime + duration + 1.5); 
                
                s.start(startTime); 
                s.stop(startTime + duration + 2.0); 
                this.activeSources.push(s); 
                s.onended = () => { this.activeSources = this.activeSources.filter(x => x !== s); }; 
            }

            playSynthToneAt(freq, startTime, duration) { 
                if (!this.ctx) return; 
                const osc = this.ctx.createOscillator(); 
                const g = this.ctx.createGain(); 
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, startTime); 
                g.gain.setValueAtTime(0, startTime); 
                g.gain.linearRampToValueAtTime(0.3, startTime + 0.02); 
                g.gain.exponentialRampToValueAtTime(0.001, startTime + duration); 
                osc.connect(g); 
                g.connect(this.ctx.destination); 
                osc.start(startTime); 
                osc.stop(startTime + duration + 0.1); 
                this.activeSources.push(osc); 
                osc.onended = () => { this.activeSources = this.activeSources.filter(x => x !== osc); }; 
            }

            playClickAt(startTime) { 
                if (!this.ctx) return; 
                const osc = this.ctx.createOscillator(); 
                const g = this.ctx.createGain(); 
                osc.frequency.setValueAtTime(1000, startTime); 
                g.gain.setValueAtTime(0.3, startTime); 
                g.gain.exponentialRampToValueAtTime(0.001, startTime + 0.05); 
                osc.connect(g); 
                g.connect(this.ctx.destination); 
                osc.start(startTime); 
                osc.stop(startTime + 0.05); 
            }

            wait(s) { return new Promise(r => setTimeout(r, s * 1000)); }

            async playNote(note, duration = 0.5) { 
                await this.resume(); 
                if (!this.ctx) return; 
                if (typeof note === 'number') { this.playSynthToneAt(note, this.ctx.currentTime, duration); return; } 
                
                const f = this.mapNoteToFileName(note); 
                if (!this.buffers[f]) { try { this.buffers[f] = await this.fetchSample(f); } catch (e) {} }

                if (this.buffers[f]) { 
                    this.playBufferAt(this.buffers[f], this.ctx.currentTime, duration, 2.0); 
                } else { 
                    const freq = NOTE_FREQUENCIES[note] || 440; 
                    this.playSynthToneAt(freq, this.ctx.currentTime, duration); 
                } 
            }

            async playChord(rootAbs, scaleId, dur, runId) { 
                if (this.currentPlaybackId !== runId) return; 
                let intervals = [0, 4, 7]; 
                const lid = scaleId.toLowerCase(); 
                if (lid.includes('menor') || lid.includes('dórica') || lid.includes('blues')) intervals = [0, 3, 7]; 
                else if (lid.includes('disminuido')) intervals = [0, 3, 6]; 
                
                const notes = intervals.map(i => { 
                    const a = rootAbs + i; 
                    return `${NOTES[a % 12]}${Math.floor(a / 12)}`; 
                }); 
                
                const st = this.ctx.currentTime; 
                notes.forEach(n => { 
                    const f = this.mapNoteToFileName(n); 
                    if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur, 1.2); 
                    else this.playSynthToneAt(NOTE_FREQUENCIES[n] || 440, st, dur); 
                }); 
            }

            async playSequence(seq, bpm = 120, onStep) { 
                this.stop(); 
                await this.resume(); 
                if (!this.ctx) return; 
                const runId = ++this.currentPlaybackId; 
                const beat = 60 / bpm; 
                const durMap = { 'whole': beat * 4, 'half': beat * 2, 'quarter': beat, 'eighth': beat * 0.5 }; 
                
                await this.preloadNotes(seq.map(s => s.note)); 
                
                for (let i = 0; i < seq.length; i++) { 
                    if (this.currentPlaybackId !== runId) break; 
                    const item = seq[i]; 
                    const dur = durMap[item.duration]; 
                    const f = this.mapNoteToFileName(item.note); 
                    const st = this.ctx.currentTime; 
                    
                    if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur, 2.0); 
                    else this.playSynthToneAt(NOTE_FREQUENCIES[item.note] || 440, st, dur); 
                    
                    if (onStep) onStep(i); 
                    await this.wait(dur); 
                } 
            }

            async playCustomElasticScale(root, startOct, endOct, relSeq, bpm = 120) { 
                this.stop(); 
                await this.resume(); 
                if (!this.ctx) return; 
                
                const runId = ++this.currentPlaybackId; 
                const beat = 60 / bpm; 
                const durMap = { 'whole': beat * 4, 'half': beat * 2, 'quarter': beat, 'eighth': beat * 0.5 }; 
                const rootIdx = NOTES.indexOf(root); 
                const startAbs = (startOct * 12) + rootIdx; 
                const endAbs = (endOct * 12) + rootIdx; 
                
                const preload = []; 
                let curr = startAbs;
                while (curr <= endAbs) {
                    relSeq.forEach(item => {
                         const abs = curr + item.interval;
                         preload.push(`${NOTES[abs % 12]}${Math.floor(abs / 12)}`);
                    });
                    curr++;
                }
                await this.preloadNotes(preload); 
                
                curr = startAbs; 
                while (curr <= endAbs) { 
                    if (this.currentPlaybackId !== runId) return; 
                    for (let i = 0; i < relSeq.length; i++) { 
                        if (this.currentPlaybackId !== runId) return; 
                        const item = relSeq[i]; 
                        const abs = curr + item.interval; 
                        const full = `${NOTES[abs % 12]}${Math.floor(abs / 12)}`; 
                        const dur = durMap[item.duration]; 
                        const f = this.mapNoteToFileName(full); 
                        const st = this.ctx.currentTime; 
                        
                        if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur, 2.0); 
                        else this.playSynthToneAt(NOTE_FREQUENCIES[full] || 440, st, dur); 
                        
                        await this.wait(dur); 
                    } 
                    if (this.currentPlaybackId !== runId) return; 
                    await this.wait(1.0); 
                    curr++; 
                } 
            }

            async playScale(root, startOct, endOct, intervals, bpm = 100, useMetro = false, scaleId = 'Mayor', onStep) { 
                this.stop(); 
                await this.resume(); 
                if (!this.ctx) return; 
                
                const runId = ++this.currentPlaybackId; 
                const beat = 60 / bpm; 
                const rootIdx = NOTES.indexOf(root); 
                const startAbs = (startOct * 12) + rootIdx; 
                const endAbs = (endOct * 12) + rootIdx; 
                const actStart = Math.min(startAbs, endAbs); 
                const actEnd = Math.max(startAbs, endAbs); 
                
                const preload = []; 
                for (let i = actStart; i <= actEnd + 24; i++) preload.push(`${NOTES[i % 12]}${Math.floor(i / 12)}`); 
                await this.preloadNotes(preload); 
                
                let curr = actStart; 
                while (curr <= actEnd) { 
                    if (this.currentPlaybackId !== runId) return; 
                    let seq = []; 
                    let noteDur = beat * 0.5; 
                    if (scaleId === 'Rossini' || scaleId === 'Flamenca 8va Descendente') { 
                        noteDur = beat * 0.25; 
                        intervals.forEach(i => seq.push(`${NOTES[(curr + i) % 12]}${Math.floor((curr + i) / 12)}`)); 
                    } else { 
                        const notes = intervals.map(i => `${NOTES[(curr + i) % 12]}${Math.floor((curr + i) / 12)}`); 
                        seq = [...notes, ...[...notes].reverse().slice(1)]; 
                    } 
                    
                    for (let i = 0; i < seq.length; i++) { 
                        if (this.currentPlaybackId !== runId) return; 
                        const n = seq[i]; 
                        const st = this.ctx.currentTime; 
                        if (useMetro && i % 4 === 0) this.playClickAt(st); 
                        const f = this.mapNoteToFileName(n); 
                        
                        if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, noteDur, 2.0); 
                        else this.playSynthToneAt(NOTE_FREQUENCIES[n] || 440, st, noteDur); 
                        
                        if (onStep) onStep(i, seq.length); 
                        await this.wait(noteDur); 
                    } 
                    
                    if (this.currentPlaybackId !== runId) return; 
                    
                    // Pausa aumentada antes del acorde
                    await this.wait(beat * 1.2);

                    // --- ACORDES ---
                    if (useMetro) this.playClickAt(this.ctx.currentTime); 
                    await this.playChord(curr, scaleId, beat * 1.5, runId); 
                    
                    // Pausa ajustada a 1.3 tiempos
                    await this.wait(beat * 1.3); 

                    if (this.currentPlaybackId !== runId) return; 
                    
                    if (curr < actEnd) { 
                        const next = curr + 1; 
                        await this.playChord(next, scaleId, beat * 1.5, runId); 
                        await this.wait(beat * 1.5); 
                    } 
                    curr++; 
                } 
            }
        }
        const audioService = new PianoAudioService();

        // --- COMPONENTS ---
        const NavButton = ({ to, icon, label, active }) => (
            <Link to={to} className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${active ? 'text-primary scale-110' : 'text-slate-400 hover:text-slate-200'}`}>
                <span className={`material-symbols-outlined text-[24px] ${active ? 'fill-1' : ''}`}>{icon}</span>
                <span className="text-[10px] font-bold tracking-tight">{label}</span>
            </Link>
        );

        const BottomNav = () => {
          const location = useLocation();
          const path = location.pathname;
          
          if (path.includes('create-scale') || path.includes('edit-scale')) return null;

          return (
            <nav className="shrink-0 w-full bg-white dark:bg-[#151b26] border-t border-slate-200 dark:border-slate-800 shadow-[0_-4px_20px_rgba(0,0,0,0.3)] pb-safe z-[50]">
              <div className="flex items-center justify-around h-16 max-w-2xl mx-auto">
                <NavButton to="/" icon="home" label="Inicio" active={path === '/'} />
                <NavButton to="/scales" icon="library_music" label="Escalas" active={path === '/scales' || path.includes('scale')} />
                <NavButton to="/health" icon="health_and_safety" label="Salud" active={path === '/health'} />
                <NavButton to="/metronome" icon="timer" label="Tempo" active={path === '/metronome'} />
              </div>
            </nav>
          );
        };

        // --- SCREENS ---
        const HomeScreen = () => {
          const [selectedScaleId, setSelectedScaleId] = useState("Mayor");
          const [selectedNote, setSelectedNote] = useState("D");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);
          const [isMetronomeOn, setIsMetronomeOn] = useState(false);
          const [isPlaying, setIsPlaying] = useState(false);
          const [isDarkMode, setIsDarkMode] = useState(true);
          const isProcessingRef = useRef(false);

          useEffect(() => {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') { document.documentElement.classList.add('dark'); setIsDarkMode(true); } 
            else { document.documentElement.classList.remove('dark'); setIsDarkMode(false); }
          }, []);

          const toggleDarkMode = () => {
            const next = !isDarkMode;
            setIsDarkMode(next);
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', next ? 'dark' : 'light');
          };

          const handleStart = async () => {
            if (isPlaying) { audioService.stop(); setIsPlaying(false); return; }
            if (isProcessingRef.current) return;
            isProcessingRef.current = true;
            try {
              setIsPlaying(true);
              const intervals = SCALE_INTERVALS[selectedScaleId] || SCALE_INTERVALS['Mayor'];
              await audioService.playScale(selectedNote, startOctave, endOctave, intervals, bpm, isMetronomeOn, selectedScaleId);
              setIsPlaying(false);
            } catch (error) { console.error(error); setIsPlaying(false); } finally { isProcessingRef.current = false; }
          };

          const ScaleButton = ({ label }) => (
            <button onClick={() => setSelectedScaleId(label)} className={`flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg px-4 transition-all active:scale-95 border whitespace-nowrap ${selectedScaleId === label ? 'bg-primary text-white shadow-lg shadow-primary/20 border-transparent' : 'bg-surface-light dark:bg-surface-dark text-gray-700 dark:text-white border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}`}>
              <span className="text-sm font-semibold leading-normal">{label}</span>
            </button>
          );

          return (
            <div className="relative flex min-h-full w-full flex-col bg-background-light dark:bg-background-dark">
              <div className="sticky top-0 z-20 flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-200 dark:border-gray-800">
                <h1 className="text-gray-900 dark:text-white text-xl font-bold leading-tight flex-1">Vocalización</h1>
                <button onClick={toggleDarkMode} className="flex h-10 w-10 items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800"><span className="material-symbols-outlined">{isDarkMode ? 'light_mode' : 'dark_mode'}</span></button>
              </div>
              <div className="flex-1 px-4 lg:px-8 pb-32 pt-4 overflow-y-auto">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-screen-xl mx-auto">
                  <div className="flex flex-col gap-6">
                    <div className="flex flex-col">
                      <h2 className="text-gray-900 dark:text-white text-[22px] font-bold pb-4">Selecciona una escala</h2>
                      <div className="flex flex-col gap-6">
                        {[{ title: "Escalas Básicas", list: ["Mayor", "Menor Natural", "Cromática"] }, { title: "Modales y Variaciones", list: ["Dórica", "Flamenca", "Flamenca 8va Descendente", "Aumentada"] }, { title: "Arpegios", list: ["Arpegio Mayor", "Arpegio Menor", "Arpegio Disminuido"] }, { title: "Estilos", list: ["Rossini", "Progresión por Terceras", "Rossini Arpeggio", "Pentatónica Mayor", "Pentatónica Menor", "Blues"] }].map((group) => (
                          <div key={group.title} className="space-y-3">
                            <h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider ml-1 border-l-2 border-primary pl-2">{group.title}</h3>
                            <div className="flex flex-wrap gap-2 md:gap-3">{group.list.map(label => <ScaleButton key={label} label={label} />)}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex flex-col">
                      <h2 className="text-gray-900 dark:text-white text-[22px] font-bold pb-4">Elige la nota</h2>
                      <div className="grid grid-cols-4 sm:grid-cols-6 gap-3">
                        {NOTES.map((note) => (
                          <button key={note} onClick={() => { setSelectedNote(note); audioService.playNote(`${note}${startOctave}`, 0.3); }} className={`flex items-center justify-center rounded-xl h-14 text-lg font-bold transition-all active:scale-95 ${selectedNote === note ? 'bg-primary text-white shadow-lg' : 'bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700'}`}>{note}</button>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col gap-8">
                    <div className="grid grid-cols-2 gap-4">
                        {['Inicial', 'Final'].map((label, idx) => (
                            <div key={label} className="flex flex-col">
                                <label className="text-xs text-gray-500 font-bold uppercase mb-2">Octava {label}</label>
                                <select value={idx === 0 ? startOctave : endOctave} onChange={(e) => idx === 0 ? setStartOctave(Number(e.target.value)) : setEndOctave(Number(e.target.value))} className="w-full h-12 rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 px-4 font-bold">{[1,2,3,4,5,6].map(n => <option key={n} value={n}>{n}</option>)}</select>
                            </div>
                        ))}
                    </div>
                    <div className="w-full bg-surface-light dark:bg-surface-dark rounded-xl p-6 border border-gray-200 dark:border-gray-700">
                      <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3"><span className="material-symbols-outlined text-primary text-3xl">timer</span><h3 className="font-bold text-xl">Metrónomo</h3></div>
                        <input type="checkbox" checked={isMetronomeOn} onChange={() => setIsMetronomeOn(!isMetronomeOn)} className="w-6 h-6 rounded text-primary" />
                      </div>
                      <div className="flex flex-col gap-4">
                        <div className="flex justify-between items-center"><span className="text-base font-medium">Velocidad</span><div className="text-primary font-bold text-lg">{bpm} BPM</div></div>
                        <input type="range" min="40" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div className="fixed bottom-[6rem] left-0 right-0 z-40 flex justify-center px-4 pointer-events-none">
                <div className="pointer-events-auto shadow-2xl rounded-full overflow-hidden max-w-sm w-full mx-auto">
                  <button onClick={handleStart} className={`w-full h-16 font-black text-xl flex items-center justify-center gap-4 transition-all active:scale-[0.97] hover:brightness-110 border-2 ${isPlaying ? 'bg-red-500 text-white border-red-400' : 'bg-primary text-white border-blue-400'}`}>
                    <span className={`material-symbols-outlined text-4xl ${isPlaying ? '' : 'filled'}`}>{isPlaying ? 'stop' : 'play_circle'}</span>
                    <span className="tracking-tight">{isPlaying ? 'Detener' : 'Comenzar Ensayo'}</span>
                  </button>
                </div>
              </div>
            </div>
          );
        };

        const MetronomeScreen = () => {
          const navigate = useNavigate();
          const [bpm, setBpm] = useState(120);
          const [isPlaying, setIsPlaying] = useState(false);
          const [beat, setBeat] = useState(0);
          const [isMuted, setIsMuted] = useState(false);
          const [timeSignature, setTimeSignature] = useState('4/4');
          const [tapTimes, setTapTimes] = useState([]);
          const timerRef = useRef(null);
          const audioCtxRef = useRef(null);
          
          const getTempoName = (b) => { if(b<=60)return'Largo'; if(b<=76)return'Adagio'; if(b<=108)return'Andante'; if(b<=120)return'Moderato'; if(b<=156)return'Allegro'; if(b<=176)return'Vivace'; return'Presto'; };
          
          const playClick = () => {
             if (isMuted) return;
             if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
             const ctx = audioCtxRef.current;
             if (ctx.state === 'suspended') ctx.resume();
             const osc = ctx.createOscillator();
             const gain = ctx.createGain();
             osc.type = 'sine';
             osc.frequency.setValueAtTime(beat === 0 ? 1000 : 500, ctx.currentTime);
             gain.gain.setValueAtTime(0.4, ctx.currentTime);
             gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
             osc.connect(gain);
             gain.connect(ctx.destination);
             osc.start();
             osc.stop(ctx.currentTime + 0.1);
          };
          
          const handleTap = () => {
             const now = Date.now();
             const newTimes = [...tapTimes, now].slice(-4);
             setTapTimes(newTimes);
             if (newTimes.length >= 2) {
                 const intervals = [];
                 for(let i=1; i<newTimes.length; i++) intervals.push(newTimes[i]-newTimes[i-1]);
                 const avg = intervals.reduce((a,b)=>a+b)/intervals.length;
                 const newBpm = Math.round(60000/avg);
                 if(newBpm>=40 && newBpm<=220) setBpm(newBpm);
             }
          };
          
          useEffect(() => {
             if (isPlaying) {
                 const beats = timeSignature==='4/4'?4:timeSignature==='3/4'?3:6;
                 if(timerRef.current) clearInterval(timerRef.current);
                 timerRef.current = setInterval(() => {
                     setBeat(p => (p+1)%beats);
                     playClick();
                 }, (60/bpm)*1000);
             } else {
                 if(timerRef.current) clearInterval(timerRef.current);
                 setBeat(0);
             }
             return () => clearInterval(timerRef.current);
          }, [isPlaying, bpm, beat, timeSignature, isMuted]);

          return (
            <div className="bg-[#0b0f17] font-display antialiased text-white min-h-screen flex flex-col relative w-full overflow-hidden pb-24 landscape:pb-0">
              <div className="absolute top-[-10%] left-0 right-0 h-[50%] bg-gradient-to-b from-[#1a2542] to-transparent opacity-30 pointer-events-none"></div>

              <header className="flex items-center justify-between p-4 z-10 max-w-screen-2xl mx-auto w-full shrink-0 h-[70px]">
                <button onClick={() => navigate(-1)} className="p-2 rounded-2xl active:bg-white/10 transition-colors hover:bg-white/5">
                  <span className="material-symbols-outlined text-[28px]">arrow_back</span>
                </button>
                <h2 className="text-lg font-black tracking-tight uppercase">METRÓNOMO</h2>
                <button onClick={() => setIsMuted(!isMuted)} className="p-2 rounded-2xl active:bg-white/10 transition-colors hover:bg-white/5">
                  <span className="material-symbols-outlined text-[28px]">
                    {isMuted ? 'volume_off' : 'volume_up'}
                  </span>
                </button>
              </header>

              <main className="flex-1 w-full px-6 max-w-screen-2xl mx-auto relative z-10 overflow-y-auto scrollbar-hide flex items-center">
                <div className="flex flex-col landscape:flex-row items-center justify-around landscape:justify-between w-full h-full landscape:px-8 landscape:gap-16 py-2">
                  
                  {/* DIAL SECTION */}
                  <div className="relative flex items-center justify-center shrink-0 landscape:flex-1">
                    <svg className="rotate-[-90deg] w-[70vw] h-[70vw] max-w-[280px] max-h-[280px] landscape:w-[50vh] landscape:h-[50vh] landscape:max-w-[500px] landscape:max-h-[500px] transition-all duration-300">
                      <circle cx="50%" cy="50%" r="46%" fill="transparent" stroke="#1a2333" strokeWidth="6" />
                      <circle
                        cx="50%"
                        cy="50%"
                        r="46%"
                        fill="transparent"
                        stroke="#135bec"
                        strokeWidth="6"
                        strokeDasharray="1000"
                        strokeDashoffset={isPlaying ? (1000 - (1000 * (beat + 1)) / (timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6)) : 1000}
                        className="transition-all duration-150 ease-out"
                        strokeLinecap="round"
                        style={{ filter: 'drop-shadow(0 0 12px rgba(19, 91, 236, 0.8))' }}
                      />
                    </svg>

                    <div className="absolute inset-0 m-auto rounded-full bg-[#111622] border-[4px] border-[#1a2333] shadow-[0_0_60px_rgba(0,0,0,0.7)] flex flex-col items-center justify-center z-10 w-[62vw] h-[62vw] max-w-[250px] max-h-[250px] landscape:w-[42vh] landscape:h-[42vh] landscape:max-w-[420px] landscape:max-h-[420px]">
                      <h1 className="text-6xl md:text-8xl landscape:text-8xl lg:text-9xl font-black tracking-tighter leading-none mb-1 drop-shadow-lg transition-all">{bpm}</h1>
                      <p className="text-primary font-black text-[9px] md:text-xs tracking-[0.3em] uppercase opacity-90 text-center px-4">Beats Per Minute</p>
                      
                      <button onClick={() => setBpm(b => Math.max(40, b - 1))} className="absolute left-[-15px] md:left-[-25px] landscape:left-[-30px] size-10 md:size-14 landscape:size-16 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-2xl border-2 border-white/5 hover:bg-[#252c3c] z-20"><span className="material-symbols-outlined text-xl md:text-3xl landscape:text-3xl">remove</span></button>
                      <button onClick={() => setBpm(b => Math.min(220, b + 1))} className="absolute right-[-15px] md:right-[-25px] landscape:right-[-30px] size-10 md:size-14 landscape:size-16 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-2xl border-2 border-white/5 hover:bg-[#252c3c] z-20"><span className="material-symbols-outlined text-xl md:text-3xl landscape:text-3xl">add</span></button>
                    </div>
                  </div>

                  {/* CONTROLS SECTION */}
                  <div className="flex flex-col w-full max-w-md gap-6 landscape:gap-8 justify-center landscape:flex-1 landscape:max-w-lg">
                    
                    {/* Nomenclatura & Slider */}
                    <div className="space-y-4 bg-[#111622]/50 p-4 rounded-3xl border border-white/5 landscape:border-0 landscape:bg-transparent landscape:p-0">
                      <div className="flex items-end justify-between px-2 landscape:mb-2">
                        <span className="text-xs font-black text-gray-500 uppercase tracking-[0.2em]">Nomenclatura</span>
                        <span className="text-lg md:text-2xl font-black text-primary uppercase tracking-widest drop-shadow-sm">{getTempoName(bpm)}</span>
                      </div>
                      <div className="w-full px-1">
                        <input type="range" min="40" max="220" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-3 bg-[#1c2333] rounded-full appearance-none cursor-pointer accent-primary" style={{ background: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(220-40)*100}%, #1c2333 ${(bpm-40)/(220-40)*100}%, #1c2333 100%)` }} />
                        <div className="flex justify-between mt-3 text-[9px] md:text-[10px] font-black text-gray-600 tracking-[0.2em] uppercase"><span>Adagio</span><span>Andante</span><span>Presto</span></div>
                      </div>
                    </div>

                    {/* Buttons: TAP & Time Sig */}
                    <div className="flex gap-4 w-full h-14 md:h-16 landscape:h-18">
                      <button onClick={handleTap} className="flex-1 bg-[#111622] border-2 border-white/5 rounded-2xl flex items-center justify-center gap-2 active:bg-[#1a2333] transition-all shadow-lg hover:border-primary/20">
                          <span className="material-symbols-outlined text-primary text-2xl">back_hand</span>
                          <span className="text-xs font-black tracking-[0.2em]">TAP</span>
                      </button>
                      <div className="flex-[1.5] bg-[#111622] border-2 border-white/5 rounded-2xl flex items-center p-1 shadow-lg">
                        {(['4/4', '3/4', '6/8']).map((sig) => (
                          <button key={sig} onClick={() => setTimeSignature(sig)} className={`flex-1 h-full rounded-xl text-[10px] md:text-xs font-black transition-all ${timeSignature === sig ? 'bg-primary text-white shadow-md' : 'text-gray-500 hover:text-gray-300'}`}>{sig}</button>
                        ))}
                      </div>
                    </div>

                    {/* Play Button */}
                    <div className="flex justify-center landscape:justify-end pt-2 landscape:pt-4">
                      <button onClick={() => setIsPlaying(!isPlaying)} className={`size-20 md:size-24 landscape:size-28 rounded-full flex items-center justify-center transition-all active:scale-95 shadow-2xl hover:scale-105 ${isPlaying ? 'bg-white text-black' : 'bg-primary text-white shadow-primary/40'}`}>
                          <span className="material-symbols-outlined text-[40px] md:text-[48px] landscape:text-[56px] filled">{isPlaying ? 'pause' : 'play_arrow'}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </main>
              
              <div className="block landscape:hidden">
                 <BottomNav />
              </div>
            </div>
          );
        };

        const HealthScreen = () => {
          return (
            <div className="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 h-full overflow-y-auto">
              <header className="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 pt-4 pb-3">
                <div className="max-w-screen-2xl mx-auto flex flex-col">
                  <div className="flex items-center justify-between mb-4"><Link to="/" className="p-2 -ml-2"><span className="material-symbols-outlined text-[28px]">arrow_back</span></Link></div>
                  <h1 className="text-3xl font-black tracking-tight">Salud Vocal</h1>
                  <p className="text-sm text-slate-500 mt-1">Guía profesional para el cuidado de tu instrumento.</p>
                </div>
              </header>
              <main className="max-w-screen-2xl mx-auto px-6 pt-8 space-y-12 pb-32">
                <section className="bg-surface-light dark:bg-surface-dark p-8 rounded-[40px] border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden relative">
                  <div className="flex items-center gap-8 relative z-10">
                    <div className="h-20 w-20 rounded-3xl bg-primary/10 flex items-center justify-center text-primary shrink-0 rotate-3 border-2 border-primary/20"><span className="material-symbols-outlined text-4xl">medical_services</span></div>
                    <div><h2 className="text-2xl font-black mb-3">Cuidado Clínico</h2><p className="text-base text-slate-600 dark:text-slate-300">Recomendaciones basadas en medicina foniátrica.</p></div>
                  </div>
                </section>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  {HEALTH_TIPS.map(tip => (
                    <div key={tip.id} className="bg-white dark:bg-[#1c2333] p-8 rounded-[32px] border border-gray-200 dark:border-gray-800 shadow-lg flex flex-col h-full">
                      <div className="flex items-center gap-4 mb-6"><div className="h-12 w-12 rounded-2xl bg-primary text-white flex items-center justify-center"><span className="material-symbols-outlined text-2xl">{tip.icon}</span></div><h3 className="text-xl font-black">{tip.title}</h3></div>
                      <p className="text-base text-slate-600 dark:text-slate-300 mb-8 flex-1">{tip.content}</p>
                      <div className="flex items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-6 mt-auto"><span className="text-[10px] font-black text-slate-400 uppercase">Fuente Médica</span><span className="text-xs font-black text-primary">{tip.source}</span></div>
                    </div>
                  ))}
                </div>
              </main>
            </div>
          );
        };

        const ScalesScreen = () => {
          const navigate = useNavigate();
          const [customScales, setCustomScales] = useState([]);
          const [playingId, setPlayingId] = useState(null);
          const [scaleToDelete, setScaleToDelete] = useState(null);
          const [selectedNote, setSelectedNote] = useState("C");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);

          useEffect(() => {
            try {
              const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (Array.isArray(saved)) setCustomScales(saved.map(s => ({ ...s, id: s.id.toString() })).sort((a,b)=>b.createdAt-a.createdAt));
            } catch (e) { console.error(e); }
          }, []);

          const playCustom = async (e, scale) => {
            e.preventDefault(); e.stopPropagation();
            if (playingId === scale.id) { audioService.stop(); setPlayingId(null); return; }
            if (playingId) audioService.stop();
            setPlayingId(scale.id);
            if (scale.relativeNotes?.length > 0) await audioService.playCustomElasticScale(selectedNote, startOctave, endOctave, scale.relativeNotes, bpm);
            else await audioService.playSequence(scale.notes, bpm);
            setPlayingId(null);
          };

          const confirmDelete = () => {
            if (!scaleToDelete) return;
            const updated = customScales.filter(s => s.id !== scaleToDelete);
            localStorage.setItem('vocal_scales', JSON.stringify(updated));
            setCustomScales(updated);
            setScaleToDelete(null);
          };

          return (
            <div className="bg-[#0b0f17] text-white h-full relative font-display flex flex-col">
              <header className="px-6 pt-10 pb-6 border-b border-gray-800 shrink-0"><h1 className="text-3xl font-black">Biblioteca Vocal</h1></header>
              <div className="bg-[#111622] border-b border-gray-800 px-6 py-6 shrink-0 shadow-2xl z-10">
                <div className="flex flex-col gap-2">
                   <div className="flex gap-2"><select value={selectedNote} onChange={(e)=>setSelectedNote(e.target.value)} className="bg-[#1c2333] h-10 rounded-lg px-3">{NOTES.map(n=><option key={n} value={n}>{n}</option>)}</select><select value={startOctave} onChange={(e)=>setStartOctave(Number(e.target.value))} className="bg-[#1c2333] h-10 rounded-lg px-3">{[2,3,4,5].map(n=><option key={n} value={n}>Oct {n}</option>)}</select><input type="range" min="40" max="240" value={bpm} onChange={(e)=>setBpm(Number(e.target.value))} className="h-10 w-24" /></div>
                </div>
              </div>
              <main className="flex-1 px-6 py-10 overflow-y-auto space-y-4">
                {customScales.length===0 ? <div className="text-center py-20 opacity-50"><span className="material-symbols-outlined text-6xl">music_off</span><p>Sin escalas guardadas</p></div> : 
                 customScales.map(scale => (
                   <div key={scale.id} className={`bg-[#1c2333] p-6 rounded-[32px] border-2 transition-all ${playingId===scale.id?'border-primary shadow-glow':'border-gray-800'}`}>
                     <div onClick={(e)=>playCustom(e, scale)} className="flex items-center gap-4 cursor-pointer">
                        <div className={`size-14 rounded-2xl flex items-center justify-center ${playingId===scale.id?'bg-red-500':'bg-primary/10 text-primary'}`}><span className="material-symbols-outlined text-3xl">{playingId===scale.id?'stop':'play_arrow'}</span></div>
                        <div className="flex-1"><h3 className="font-black text-lg">{scale.name}</h3></div>
                     </div>
                     <div className="flex gap-2 mt-4"><button onClick={()=>navigate(`/edit-scale/${scale.id}`)} className="flex-1 bg-blue-500/10 text-blue-500 rounded-xl h-10 font-bold">Editar</button><button onClick={()=>setScaleToDelete(scale.id)} className="w-12 bg-red-500/10 text-red-500 rounded-xl"><span className="material-symbols-outlined">delete</span></button></div>
                   </div>
                 ))
                }
              </main>
              <button onClick={()=>navigate('/create-scale')} className="fixed bottom-24 right-8 size-16 rounded-3xl bg-primary text-white shadow-glow flex items-center justify-center z-20"><span className="material-symbols-outlined text-4xl">add</span></button>
              {scaleToDelete && <div className="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4"><div className="bg-[#161c27] p-8 rounded-3xl max-w-sm w-full"><h3 className="text-xl font-bold mb-4">¿Eliminar?</h3><div className="flex gap-2"><button onClick={confirmDelete} className="flex-1 bg-red-500 h-12 rounded-xl font-bold">Si, eliminar</button><button onClick={()=>setScaleToDelete(null)} className="flex-1 bg-gray-700 h-12 rounded-xl font-bold">Cancelar</button></div></div></div>}
            </div>
          );
        };

        const CreateScaleScreen = () => {
            const navigate = useNavigate();
            const { id } = useParams();
            const [scaleName, setScaleName] = useState('');
            const [selectedDuration, setSelectedDuration] = useState('quarter');
            const [sequence, setSequence] = useState([]);
            const [currentOctave, setCurrentOctave] = useState(4);
            
            useEffect(() => {
                if(id) {
                    const saved = JSON.parse(localStorage.getItem('vocal_scales')||'[]');
                    const found = saved.find(s=>s.id.toString()===id);
                    if(found){ setScaleName(found.name); setSequence(found.notes); }
                }
            }, [id]);

            const addNote = (note) => {
                setSequence([...sequence, {note, duration: selectedDuration}]);
                audioService.playNote(note, 0.4);
            };
            const undo = () => setSequence(p=>p.slice(0,-1));
            const getNoteValue = (n) => {
                const m = n.match(/^([A-G][#]?)(-?\d+)$/);
                return m ? (parseInt(m[2])*12)+NOTES.indexOf(m[1]) : 0;
            };
            const handleSave = () => {
                if(!scaleName.trim() || sequence.length===0) return alert('Nombre y notas requeridos');
                const root = getNoteValue(sequence[0].note);
                const relatives = sequence.map(s=>({interval: getNoteValue(s.note)-root, duration: s.duration}));
                const saved = JSON.parse(localStorage.getItem('vocal_scales')||'[]');
                const newScale = {id: id||Date.now().toString(), name: scaleName, notes: sequence, relativeNotes: relatives, createdAt: Date.now()};
                if(id) {
                    const idx = saved.findIndex(s=>s.id.toString()===id);
                    saved[idx] = newScale;
                } else saved.push(newScale);
                localStorage.setItem('vocal_scales', JSON.stringify(saved));
                navigate('/scales');
            };
            
            const keys = [...['C','D','E','F','G','A','B'].map(n=>`${n}${currentOctave}`), `C${currentOctave+1}`];
            const blacks = [{n:'C#',l:'8.5%'},{n:'D#',l:'21%'},{n:'F#',l:'46%'},{n:'G#',l:'58.5%'},{n:'A#',l:'71%'}];
            
            return (
                <div className="flex flex-col h-full bg-[#0b0f17] text-white">
                    <header className="flex items-center justify-between p-4 border-b border-white/5 shrink-0">
                        <button onClick={()=>navigate('/scales')}><span className="material-symbols-outlined">close</span></button>
                        <h1 className="font-bold">{id?'EDITAR':'NUEVA'}</h1>
                        <button onClick={handleSave} className="text-primary font-black text-xs uppercase bg-primary/10 px-4 py-2 rounded-lg">Guardar</button>
                    </header>
                    <main className="flex-1 overflow-y-auto p-6 space-y-6">
                        <input value={scaleName} onChange={e=>setScaleName(e.target.value)} placeholder="Nombre de la escala..." className="w-full bg-[#161c27] p-4 rounded-xl border border-gray-800 text-lg" />
                        <div className="flex bg-[#1c1f27] p-1 rounded-xl">{['quarter','eighth','half','whole'].map(d=><button key={d} onClick={()=>setSelectedDuration(d)} className={`flex-1 h-10 rounded-lg text-xs font-black uppercase ${selectedDuration===d?'bg-[#32394a] text-primary':'text-gray-500'}`}>{d}</button>)}</div>
                        <div className="bg-[#111620] h-32 rounded-3xl border border-gray-800 flex items-center px-4 overflow-x-auto gap-4">
                            {sequence.map((s,i)=><div key={i} className="flex-shrink-0 flex flex-col items-center gap-2"><div className="size-10 bg-[#32394a] rounded-full flex items-center justify-center text-xs font-bold">{s.note}</div><span className="text-[10px] text-gray-500 uppercase">{s.duration}</span></div>)}
                        </div>
                    </main>
                    <div className="h-72 bg-[#151921] border-t border-gray-800 flex flex-col shrink-0">
                        <div className="flex justify-between p-4 items-center">
                            <button onClick={()=>audioService.playSequence(sequence)} className="text-primary"><span className="material-symbols-outlined text-4xl">play_circle</span></button>
                            <div className="flex gap-1">{[3,4,5].map(o=><button key={o} onClick={()=>setCurrentOctave(o)} className={`h-8 w-10 rounded text-xs font-bold ${currentOctave===o?'bg-primary':'bg-gray-800'}`}>C{o}</button>)}</div>
                            <button onClick={undo}><span className="material-symbols-outlined">undo</span></button>
                        </div>
                        <div className="flex-1 relative flex">
                            {keys.map(k=><div key={k} onClick={()=>addNote(k)} className="flex-1 bg-white border-r border-gray-300 flex items-end justify-center pb-2 active:bg-gray-200 text-black font-bold text-xs">{k}</div>)}
                            {blacks.map(b=><div key={`${b.n}${currentOctave}`} onClick={()=>addNote(`${b.n}${currentOctave}`)} style={{left:b.l}} className="absolute top-0 w-[10%] h-[60%] bg-black rounded-b-lg active:bg-gray-800"></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => (
            <HashRouter>
                <div className="max-w-md md:max-w-4xl mx-auto bg-background-light dark:bg-background-dark h-full shadow-2xl relative border-x border-gray-200 dark:border-gray-800 flex flex-col overflow-hidden">
                    <div className="flex-1 overflow-y-auto no-scrollbar relative w-full">
                        <Routes>
                            <Route path="/" element={<HomeScreen />} />
                            <Route path="/metronome" element={<MetronomeScreen />} />
                            <Route path="/health" element={<HealthScreen />} />
                            <Route path="/scales" element={<ScalesScreen />} />
                            <Route path="/create-scale" element={<CreateScaleScreen />} />
                            <Route path="/edit-scale/:id" element={<CreateScaleScreen />} />
                        </Routes>
                    </div>
                    <BottomNav />
                </div>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>