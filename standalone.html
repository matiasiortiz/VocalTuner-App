<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VocalTune Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React & Libraries (UMD Version - Robust for Standalone) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1c2333",
                        "surface-border": "#2e3440",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    boxShadow: {
                        "glow": "0 0 20px rgba(19, 91, 236, 0.4)",
                    }
                },
            },
        }
    </script>
    <style>
        body { background-color: #101622; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #135bec; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #3b4354; border-radius: 2px; }
    </style>
</head>
<body class="font-display antialiased text-slate-900 dark:text-white">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams } = ReactRouterDOM;

        // --- CONSTANTS ---
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTE_FREQUENCIES = { 
            "C1": 32.70, "C#1": 34.65, "D1": 36.71, "D#1": 38.89, "E1": 41.20, "F1": 43.65, "F#1": 46.25, "G1": 49.00, "G#1": 51.91, "A1": 55.00, "A#1": 58.27, "B1": 61.74,
            "C2": 65.41, "C#2": 69.30, "D2": 73.42, "D#2": 77.78, "E2": 82.41, "F2": 87.31, "F#2": 92.50, "G2": 98.00, "G#2": 103.83, "A2": 110.00, "A#2": 116.54, "B2": 123.47,
            "C3": 130.81, "C#3": 138.59, "D3": 146.83, "D#3": 155.56, "E3": 164.81, "F3": 174.61, "F#3": 185.00, "G3": 196.00, "G#3": 207.65, "A3": 220.00, "A#3": 233.08, "B3": 246.94,
            "C4": 261.63, "C#4": 277.18, "D4": 293.66, "D#4": 311.13, "E4": 329.63, "F4": 349.23, "F#4": 369.99, "G4": 392.00, "G#4": 415.30, "A4": 440.00, "A#4": 466.16, "B4": 493.88,
            "C5": 523.25, "C#5": 554.37, "D5": 587.33, "D#5": 622.25, "E5": 659.25, "F5": 698.46, "F#5": 739.99, "G5": 783.99, "G#5": 830.61, "A5": 880.00, "A#5": 932.33, "B5": 987.77,
            "C6": 1046.50, "C#6": 1108.73, "D6": 1174.66, "D#6": 1244.51, "E6": 1318.51, "F6": 1396.91, "F#6": 1479.98, "G6": 1567.98, "G#6": 1661.22, "A6": 1760.00, "A#6": 1864.66, "B6": 1975.53 
        };
        const SCALE_INTERVALS = {
          'Mayor': [0, 2, 4, 5, 7, 9, 11, 12],
          'Menor Natural': [0, 2, 3, 5, 7, 8, 10, 12],
          'Menor': [0, 2, 3, 5, 7, 8, 10, 12],
          'Cromática': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
          'Dórica': [0, 2, 3, 5, 7, 9, 10, 12],
          'Flamenca': [0, 2, 3, 5, 7, 8, 11, 12], 
          'Flamenca 8va Descendente': [0, 12, 11, 8, 7, 5, 3, 2, 0],
          'Aumentada': [0, 3, 4, 7, 8, 11, 12],
          'Arpegio Mayor': [0, 4, 7, 12],
          'Arpegio Menor': [0, 3, 7, 12],
          'Arpegio Disminuido': [0, 3, 6, 9, 12],
          'Rossini': [0, 4, 7, 12, 16, 19, 17, 14, 11, 7, 5, 2, 0],
          'Progresión por Terceras': [0, 4, 2, 5, 4, 7, 5, 9, 7, 11, 9, 12, 11, 14, 12],
          'Rossini Arpeggio': [0, 4, 7, 11, 12], 
          'Pentatónica Mayor': [0, 2, 4, 7, 9, 12],
          'Pentatónica Menor': [0, 3, 5, 7, 10, 12],
          'Blues': [0, 3, 5, 6, 7, 10, 12],
        };

        const HEALTH_TIPS = [
          { 
            id: 1, 
            title: "Hidratación Inteligente", 
            icon: "water_drop",
            content: "Las cuerdas vocales vibran mejor cuando están bien lubricadas. Bebe agua a lo largo del día, no solo durante el ensayo. Evita bebidas muy frías o muy calientes justo antes de cantar.",
            source: "NIDCD (Instituto Nacional de la Sordera)",
            sourceUrl: "https://www.nidcd.nih.gov/health/taking-care-your-voice"
          },
          { 
            id: 2, 
            title: "Descanso Vocal (Vocal Naps)", 
            icon: "bedtime",
            content: "Al igual que los atletas, las cuerdas vocales necesitan recuperación. Si has cantado mucho, intenta periodos de 15-20 minutos de silencio total para reducir la inflamación.",
            source: "Duke Health Voice Care Center",
            sourceUrl: "https://www.dukehealth.org/blog/9-tips-keep-your-voice-healthy"
          },
          { 
            id: 3, 
            title: "Evita el Carraspeo", 
            icon: "do_not_touch",
            content: "Carraspear golpea violentamente las cuerdas vocales. Si sientes flema, bebe un sorbo de agua, traga con fuerza o realiza un sonido de 'h' suave y aireada para limpiar la zona.",
            source: "Texas Voice Center",
            sourceUrl: "https://www.texasvoicecenter.com/advice.html"
          },
          { 
            id: 4, 
            title: "Calentamiento Obligatorio", 
            icon: "self_improvement",
            content: "Nunca cantes 'en frío'. Realiza ejercicios suaves de labios (lip trills) o sirenas suaves para aumentar el flujo sanguíneo a la laringe antes de exigir potencia.",
            source: "British Voice Association",
            sourceUrl: "https://www.britishvoiceassociation.org.uk/"
          },
          { 
            id: 5, 
            title: "Reflujo y Alimentación", 
            icon: "restaurant",
            content: "El reflujo gastroesofágico puede quemar las cuerdas vocales durante la noche. Evita comer 3 horas antes de dormir y alimentos muy ácidos o picantes si eres propenso.",
            source: "Cleveland Clinic",
            sourceUrl: "https://my.clevelandclinic.org/health/diseases/15024-laryngopharyngeal-reflux-lpr"
          }
        ];

        // --- AUDIO SERVICE ---
        class PianoAudioService {
            constructor() { 
                this.ctx = null;
                this.buffers = {};
                this.activeSources = [];
                this.currentPlaybackId = 0; 
                this.noteMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb" };
                
                const unlockHandler = () => {
                    this.initContext();
                    if (this.ctx && this.ctx.state !== 'running') {
                        this.ctx.resume();
                    }
                    ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => document.removeEventListener(evt, unlockHandler));
                };
                ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => document.addEventListener(evt, unlockHandler));
            }

            initContext() { 
                if (!this.ctx) { 
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) { this.ctx = new AudioContext(); }
                } 
            }

            stop() {
                this.currentPlaybackId++; 
                this.activeSources.forEach(source => {
                    try { source.stop(); source.disconnect(); } catch (e) {}
                });
                this.activeSources = [];
            }

            mapNoteToFileName(note) {
                const match = note.match(/^([A-G][#]?)(-?\d+)$/);
                if (!match) return note;
                let [_, name, octave] = match;
                if (this.noteMap[name]) name = this.noteMap[name];
                return `${name}${octave}`;
            }

            async fetchSample(noteFile) {
                const url = `https://raw.githubusercontent.com/fuhton/piano-mp3/master/piano-mp3/${noteFile}.mp3`;
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                if (this.ctx) return await this.ctx.decodeAudioData(arrayBuffer);
                throw new Error("AudioContext not initialized");
            }

            async preloadNotes(notes) {
                const uniqueNotes = [...new Set(notes)];
                const promises = uniqueNotes.map(async (note) => {
                    const fileName = this.mapNoteToFileName(note);
                    if (!this.buffers[fileName]) {
                        try {
                            const buffer = await this.fetchSample(fileName);
                            this.buffers[fileName] = buffer;
                        } catch (e) { console.warn("Load failed", e); }
                    }
                });
                await Promise.all(promises);
            }

            playBufferAt(buffer, startTime, duration, volume = 2.5) {
                if (!this.ctx) return;
                const source = this.ctx.createBufferSource();
                const gain = this.ctx.createGain();
                source.buffer = buffer;
                source.connect(gain);
                gain.connect(this.ctx.destination);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                gain.gain.setValueAtTime(volume * 0.8, startTime + duration); 
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration + 1.5);

                source.start(startTime);
                source.stop(startTime + duration + 2.0);
                
                this.activeSources.push(source);
                source.onended = () => { this.activeSources = this.activeSources.filter(s => s !== source); };
            }

            playSynthToneAt(freq, startTime, duration) {
                 if (!this.ctx) return;
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 const SYNTH_VOLUME = 0.8;
                 const real = new Float32Array([0, 1, 0.4, 0.2, 0.1]); 
                 const imag = new Float32Array(real.length).fill(0);
                 const wave = this.ctx.createPeriodicWave(real, imag);
                 osc.setPeriodicWave(wave);
                 osc.frequency.setValueAtTime(freq, startTime);
                 gain.gain.setValueAtTime(0, startTime);
                 gain.gain.linearRampToValueAtTime(SYNTH_VOLUME, startTime + 0.01);
                 gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                 osc.connect(gain);
                 gain.connect(this.ctx.destination);
                 osc.start(startTime);
                 osc.stop(startTime + duration + 0.1);
                 this.activeSources.push(osc);
                 osc.onended = () => { this.activeSources = this.activeSources.filter(s => s !== osc); };
            }

            playClickAt(startTime) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(1000, startTime);
                osc.frequency.exponentialRampToValueAtTime(1, startTime + 0.05);
                gain.gain.setValueAtTime(0.7, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.05);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.05);
            }

            wait(seconds) { return new Promise(resolve => setTimeout(resolve, seconds * 1000)); }

            async playNote(note, duration = 0.5) {
                this.initContext();
                if (!this.ctx) return;
                if (typeof note === 'number') { this.playSynthToneAt(note, this.ctx.currentTime, duration); return; }
                const noteName = note;
                const fileName = this.mapNoteToFileName(noteName);
                if (this.buffers[fileName]) {
                    this.playBufferAt(this.buffers[fileName], this.ctx.currentTime, duration);
                } else {
                    try {
                        const buffer = await this.fetchSample(fileName);
                        this.buffers[fileName] = buffer;
                        this.playBufferAt(buffer, this.ctx.currentTime, duration);
                    } catch (e) {
                        const freq = NOTE_FREQUENCIES[noteName] || 440;
                        this.playSynthToneAt(freq, this.ctx.currentTime, duration);
                    }
                }
            }

            getNoteFrequencyFromFullString(fullNote) {
                return NOTE_FREQUENCIES[fullNote] || 440;
            }

            async playChord(rootNoteAbsIndex, scaleId, duration, runId) {
                if (this.currentPlaybackId !== runId) return;
                let intervals = [0, 4, 7];
                const lowerId = scaleId.toLowerCase();
                if (lowerId.includes('menor') || lowerId.includes('dórica') || lowerId.includes('blues')) { intervals = [0, 3, 7]; } 
                else if (lowerId.includes('disminuido')) { intervals = [0, 3, 6]; }

                const notesToPlay = [];
                intervals.forEach(interval => {
                    const abs = rootNoteAbsIndex + interval;
                    const note = NOTES[abs % 12];
                    const octave = Math.floor(abs / 12);
                    notesToPlay.push(`${note}${octave}`);
                });

                const startTime = this.ctx.currentTime;
                notesToPlay.forEach(noteName => {
                    const fileName = this.mapNoteToFileName(noteName);
                    const buffer = this.buffers[fileName];
                    if (buffer) { 
                        this.playBufferAt(buffer, startTime, duration, 1.8); 
                    } 
                    else { const freq = NOTE_FREQUENCIES[noteName] || 440; this.playSynthToneAt(freq, startTime, duration); }
                });
            }

            async playSequence(sequence, bpm = 120, onStep) {
                this.stop(); 
                this.initContext();
                if (!this.ctx) return;
                
                const runId = ++this.currentPlaybackId;

                const beatDuration = 60 / bpm;
                const durMap = { 'whole': beatDuration * 4, 'half': beatDuration * 2, 'quarter': beatDuration, 'eighth': beatDuration * 0.5 };

                const noteNames = sequence.map(s => s.note);
                await this.preloadNotes(noteNames);
                
                for (let i = 0; i < sequence.length; i++) {
                    if (this.currentPlaybackId !== runId) break;
                    const item = sequence[i];
                    const duration = durMap[item.duration];
                    const fileName = this.mapNoteToFileName(item.note);
                    const startTime = this.ctx.currentTime;
                    if (this.buffers[fileName]) { this.playBufferAt(this.buffers[fileName], startTime, duration); } 
                    else { const freq = NOTE_FREQUENCIES[item.note] || 440; this.playSynthToneAt(freq, startTime, duration); }
                    if (onStep) onStep(i);
                    await this.wait(duration);
                }
            }

            async playCustomElasticScale(rootNote, startOctave, endOctave, relativeSequence, bpm = 120) {
                this.stop();
                this.initContext();
                if (!this.ctx) return;

                const runId = ++this.currentPlaybackId;
                
                const beatDuration = 60 / bpm;
                const durMap = { 'whole': beatDuration * 4, 'half': beatDuration * 2, 'quarter': beatDuration, 'eighth': beatDuration * 0.5 };

                const rootIndex = NOTES.indexOf(rootNote);
                
                // Transposición Cromática
                const startAbsolute = (startOctave * 12) + rootIndex;
                const endAbsolute = (endOctave * 12) + rootIndex;

                const preloadList = [];
                for (let i = startAbsolute; i <= endAbsolute + 24; i++) {
                    preloadList.push(`${NOTES[i%12]}${Math.floor(i/12)}`);
                }
                await this.preloadNotes(preloadList);

                let currentRootAbs = startAbsolute;
                const PAUSE_DURATION = 1.0;

                while (currentRootAbs <= endAbsolute) {
                    if (this.currentPlaybackId !== runId) return;

                    for (let i = 0; i < relativeSequence.length; i++) {
                        if (this.currentPlaybackId !== runId) return;

                        const item = relativeSequence[i];
                        const noteAbs = currentRootAbs + item.interval;
                        const noteName = NOTES[noteAbs % 12];
                        const noteOctave = Math.floor(noteAbs / 12);
                        const fullNoteName = `${noteName}${noteOctave}`;
                        const duration = durMap[item.duration];

                        const startTime = this.ctx.currentTime;
                        const fileName = this.mapNoteToFileName(fullNoteName);

                        if (this.buffers[fileName]) {
                            this.playBufferAt(this.buffers[fileName], startTime, duration);
                        } else {
                            const freq = this.getNoteFrequencyFromFullString(fullNoteName);
                            this.playSynthToneAt(freq, startTime, duration);
                        }

                        await this.wait(duration);
                    }

                    if (this.currentPlaybackId !== runId) return;
                    await this.wait(PAUSE_DURATION);
                    currentRootAbs++; 
                }
            }

            async playScale(rootNote, startOctave, endOctave, intervals, bpm = 100, useMetronome = false, scaleId = 'Mayor', onStep) {
                this.stop();
                this.initContext();
                if (!this.ctx) return;

                const runId = ++this.currentPlaybackId;

                const beatDuration = 60 / bpm; 
                const rootIndex = NOTES.indexOf(rootNote);
                
                const startAbsolute = (startOctave * 12) + rootIndex;
                const endAbsolute = (endOctave * 12) + rootIndex;
                const actualStart = Math.min(startAbsolute, endAbsolute);
                const actualEnd = Math.max(startAbsolute, endAbsolute);

                const preloadList = [];
                for (let i = actualStart; i <= actualEnd + 24; i++) { preloadList.push(`${NOTES[i%12]}${Math.floor(i/12)}`); }
                await this.preloadNotes(preloadList);

                let currentRootAbs = actualStart;
                const PAUSE_DURATION = 1.0;

                while (currentRootAbs <= actualEnd) {
                    if (this.currentPlaybackId !== runId) return;
                    
                    let scaleSequence = [];
                    let noteDur = beatDuration * 0.5;

                    if (scaleId === 'Rossini' || scaleId === 'Flamenca 8va Descendente') {
                        noteDur = beatDuration * 0.25; 
                        intervals.forEach(interval => {
                            const noteAbs = currentRootAbs + interval;
                            scaleSequence.push(`${NOTES[noteAbs % 12]}${Math.floor(noteAbs / 12)}`);
                        });
                    } else {
                        const scaleNotes = [];
                        intervals.forEach(interval => {
                            const noteAbs = currentRootAbs + interval;
                            scaleNotes.push(`${NOTES[noteAbs % 12]}${Math.floor(noteAbs / 12)}`);
                        });
                        scaleSequence = [...scaleNotes, ...[...scaleNotes].reverse().slice(1)];
                    }

                    for (let i = 0; i < scaleSequence.length; i++) {
                        if (this.currentPlaybackId !== runId) return;
                        const noteName = scaleSequence[i];
                        const startTime = this.ctx.currentTime;
                        if (useMetronome && i % 4 === 0) this.playClickAt(startTime);
                        const fileName = this.mapNoteToFileName(noteName);
                        if (this.buffers[fileName]) { this.playBufferAt(this.buffers[fileName], startTime, noteDur); } 
                        else { const freq = NOTE_FREQUENCIES[noteName] || 440; this.playSynthToneAt(freq, startTime, noteDur); }
                        if (onStep) onStep(i, scaleSequence.length);
                        await this.wait(noteDur);
                    }

                    if (this.currentPlaybackId !== runId) return;

                    await this.wait(PAUSE_DURATION);

                    if (useMetronome) this.playClickAt(this.ctx.currentTime);
                    await this.playChord(currentRootAbs, scaleId, 1.5, runId);
                    
                    await this.wait(PAUSE_DURATION);

                    if (this.currentPlaybackId !== runId) return;

                    if (currentRootAbs < actualEnd) {
                         const nextRootAbs = currentRootAbs + 1;
                         if (useMetronome) this.playClickAt(this.ctx.currentTime);
                         await this.playChord(nextRootAbs, scaleId, 1.5, runId);
                         await this.wait(PAUSE_DURATION);
                    }
                    currentRootAbs++;
                }
            }
        }
        const audioService = new PianoAudioService();

        // --- COMPONENTS ---
        const NavButton = ({ to, icon, label, active }) => (
            <Link to={to} className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${active ? 'text-primary scale-110' : 'text-slate-400 hover:text-slate-200'}`}>
                <span className={`material-symbols-outlined text-[24px] ${active ? 'fill-1' : ''}`}>{icon}</span>
                <span className="text-[10px] font-bold tracking-tight">{label}</span>
            </Link>
        );
        const BottomNav = ({ activeTab }) => (
            <nav className="fixed bottom-0 left-0 right-0 z-[100] bg-white dark:bg-[#151b26] border-t border-slate-200 dark:border-slate-800 max-w-md mx-auto px-4 shadow-lg backdrop-blur-md bg-opacity-95">
                <div className="flex items-center justify-around h-16">
                    <NavButton to="/" icon="home" label="Inicio" active={activeTab === 'home'} />
                    <NavButton to="/scales" icon="library_music" label="Escalas" active={activeTab === 'scales'} />
                    <NavButton to="/health" icon="health_and_safety" label="Salud" active={activeTab === 'health'} />
                    <NavButton to="/metronome" icon="timer" label="Tempo" active={activeTab === 'metronome'} />
                </div>
                <div className="h-1.5 flex justify-center pb-2">
                    <div className="w-32 h-1 bg-slate-300 dark:bg-slate-700 rounded-full"></div>
                </div>
            </nav>
        );

        // --- SCREENS ---
        const HomeScreen = () => {
          const navigate = useNavigate();
          const [selectedScaleId, setSelectedScaleId] = useState("Mayor");
          const [selectedNote, setSelectedNote] = useState("D");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);
          const [isMetronomeOn, setIsMetronomeOn] = useState(false);
          const [isPlaying, setIsPlaying] = useState(false);
          const [isDarkMode, setIsDarkMode] = useState(true);

          const isProcessingRef = useRef(false);

          useEffect(() => {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') { document.documentElement.classList.add('dark'); setIsDarkMode(true); } 
            else { document.documentElement.classList.remove('dark'); setIsDarkMode(false); }
          }, []);

          const toggleDarkMode = () => {
            const next = !isDarkMode;
            setIsDarkMode(next);
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', next ? 'dark' : 'light');
          };

          const handleStart = async () => {
            if (isPlaying) {
              audioService.stop();
              setIsPlaying(false);
              return;
            }
            if (isProcessingRef.current) return;
            isProcessingRef.current = true;

            try {
              setIsPlaying(true);
              await new Promise(resolve => setTimeout(resolve, 50));
              
              const intervals = SCALE_INTERVALS[selectedScaleId] || SCALE_INTERVALS['Mayor'];
              
              await audioService.playScale(
                selectedNote, 
                startOctave, 
                endOctave, 
                intervals, 
                bpm, 
                isMetronomeOn,
                selectedScaleId
              );
              
              setIsPlaying(false);
            } catch (error) {
              console.error("Error en reproducción:", error);
              setIsPlaying(false);
            } finally {
              isProcessingRef.current = false;
            }
          };

          const ScaleButton = ({ label }) => (
            <button onClick={() => setSelectedScaleId(label)} className={`flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg pl-5 pr-5 transition-all active:scale-95 border whitespace-nowrap ${selectedScaleId === label ? 'bg-primary text-white shadow-lg shadow-primary/20 border-transparent' : 'bg-surface-light dark:bg-surface-dark text-gray-700 dark:text-white border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}`}>
              <span className="text-sm font-semibold leading-normal">{label}</span>
            </button>
          );

          return (
            <div className="relative flex h-full min-h-screen w-full flex-col bg-background-light dark:bg-background-dark overflow-x-hidden transition-colors duration-200">
              <div className="sticky top-0 z-20 flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-200 dark:border-gray-800 transition-colors duration-200">
                <h1 className="text-gray-900 dark:text-white text-xl font-bold leading-tight tracking-[-0.015em] flex-1">Vocalización</h1>
                <div className="flex w-12 items-center justify-end">
                  <button onClick={toggleDarkMode} className="flex max-w-[48px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-transparent text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined">{isDarkMode ? 'light_mode' : 'dark_mode'}</span></button>
                </div>
              </div>

              <div className="flex-1 flex flex-col px-4 pb-48 pt-2">
                <div className="flex flex-col mb-6">
                  <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-3 pt-4">Selecciona una escala</h2>
                  <div className="flex flex-col gap-4">
                    <div><h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Escalas Básicas</h3><div className="flex gap-3 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar"><ScaleButton label="Mayor" /><ScaleButton label="Menor Natural" /><ScaleButton label="Cromática" /></div></div>
                    <div><h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Modales y Variaciones</h3><div className="flex gap-3 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar"><ScaleButton label="Dórica" /><ScaleButton label="Flamenca" /><ScaleButton label="Flamenca 8va Descendente" /><ScaleButton label="Aumentada" /></div></div>
                    <div><h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Arpegios</h3><div className="flex gap-3 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar"><ScaleButton label="Arpegio Mayor" /><ScaleButton label="Arpegio Menor" /><ScaleButton label="Arpegio Disminuido" /></div></div>
                    <div><h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2 ml-1">Estilos y Pentatónicas</h3><div className="flex gap-3 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar"><ScaleButton label="Rossini" /><ScaleButton label="Progresión por Terceras" /><ScaleButton label="Rossini Arpeggio" /><ScaleButton label="Pentatónica Mayor" /><ScaleButton label="Pentatónica Menor" /><ScaleButton label="Blues" /></div></div>
                  </div>
                </div>

                <div className="flex flex-col mb-6">
                  <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-3 pt-2">Elige la nota</h2>
                  <div className="grid grid-cols-4 gap-3 w-full">
                    {NOTES.map((note) => (
                      <button key={note} onClick={() => { setSelectedNote(note); audioService.playNote(`${note}${startOctave}`, 0.3); }} className={`flex cursor-pointer items-center justify-center rounded-xl h-14 text-lg font-bold leading-normal transition-all active:scale-95 ${selectedNote === note ? 'bg-primary text-white shadow-lg shadow-primary/25 ring-2 ring-primary ring-offset-2 ring-offset-background-light dark:ring-offset-background-dark' : 'bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white hover:border-primary/50'}`}>
                        {note}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="flex flex-col mb-6">
                  <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-3 pt-2">Configuración de Escala</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="flex flex-col">
                      <label className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2">Octava Inicial</label>
                      <div className="relative">
                        <select value={startOctave} onChange={(e) => setStartOctave(Number(e.target.value))} className="w-full h-12 rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-base font-bold px-4 appearance-none outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-colors cursor-pointer">
                          {[1, 2, 3, 4, 5, 6].map(num => (<option key={num} value={num}>{num}</option>))}
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 dark:text-gray-400"><span className="material-symbols-outlined">expand_more</span></div>
                      </div>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2">Octava Final</label>
                      <div className="relative">
                        <select value={endOctave} onChange={(e) => setEndOctave(Number(e.target.value))} className="w-full h-12 rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-base font-bold px-4 appearance-none outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-colors cursor-pointer">
                          {[1, 2, 3, 4, 5, 6].map(num => (<option key={num} value={num}>{num}</option>))}
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 dark:text-gray-400"><span className="material-symbols-outlined">expand_more</span></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex flex-col mb-6">
                  <div className="w-full bg-surface-light dark:bg-surface-dark rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                      <div className="flex items-center gap-2">
                        <div className="h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-primary"><span className="material-symbols-outlined text-lg">timer</span></div>
                        <h3 className="text-gray-900 dark:text-white font-bold text-lg">Metrónomo</h3>
                      </div>
                      <label className="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" className="sr-only peer" checked={isMetronomeOn} onChange={() => setIsMetronomeOn(!isMetronomeOn)} />
                        <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-primary/20 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                      </label>
                    </div>
                    <div className="flex flex-col gap-3">
                      <div className="flex justify-between items-center"><span className="text-sm font-medium text-gray-500 dark:text-gray-400">Velocidad</span><div className="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-primary font-bold text-sm font-mono">{bpm} BPM</div></div>
                      <div className="relative w-full h-6 flex items-center">
                        <input type="range" min="40" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-primary focus:outline-none focus:ring-0 z-10" />
                        <div className="absolute w-full flex justify-between px-1 pointer-events-none">{[...Array(5)].map((_, i) => <div key={i} className="h-1 w-0.5 bg-gray-300 dark:bg-gray-600"></div>)}</div>
                      </div>
                      <div className="flex justify-between text-[10px] text-gray-400 font-medium uppercase tracking-wider px-1"><span>Largo</span><span>Allegro</span><span>Presto</span></div>
                    </div>
                  </div>
                </div>

                <div className="mt-auto">
                  <div className="w-full bg-gradient-to-r from-gray-100 to-gray-50 dark:from-gray-800 dark:to-gray-800/50 rounded-xl p-4 flex items-center justify-between border border-gray-200 dark:border-gray-700/50">
                    <div className="flex flex-col">
                      <span className="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase tracking-wider">Configuración actual</span>
                      <span className="text-lg text-gray-900 dark:text-white font-bold">{selectedNote} {selectedScaleId} <span className="text-gray-400 dark:text-gray-500 font-normal mx-1">•</span> {startOctave}-{endOctave} <span className="text-gray-400 dark:text-gray-500 font-normal mx-1">•</span> {bpm}bpm</span>
                    </div>
                    <div className="h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center text-primary"><span className="material-symbols-outlined">music_note</span></div>
                  </div>
                </div>
              </div>

              <div className="fixed bottom-[4.5rem] left-0 right-0 z-50 flex justify-center px-4 pointer-events-none">
                <div className="pointer-events-auto shadow-2xl rounded-full">
                  <button onClick={handleStart} className={`min-w-[200px] px-8 h-14 rounded-full font-bold text-lg flex items-center justify-center gap-3 transition-all active:scale-[0.95] hover:scale-105 border-2 ${isPlaying ? 'bg-red-500 hover:bg-red-600 text-white border-red-400 shadow-[0_0_20px_rgba(239,68,68,0.4)]' : 'bg-primary hover:bg-blue-600 text-white border-blue-400 shadow-[0_0_20px_rgba(19,91,236,0.4)]'}`}>
                    <span className={`material-symbols-outlined text-3xl ${isPlaying ? '' : 'filled'}`}>{isPlaying ? 'stop' : 'play_arrow'}</span>
                    <span className="tracking-wide">{isPlaying ? 'Detener' : 'Comenzar'}</span>
                  </button>
                </div>
              </div>

              <BottomNav activeTab="home" />
            </div>
          );
        };

        const MetronomeScreen = () => {
          const navigate = useNavigate();
          const [bpm, setBpm] = useState(120);
          const [isPlaying, setIsPlaying] = useState(false);
          const [beat, setBeat] = useState(0);
          const [isMuted, setIsMuted] = useState(false);
          const [timeSignature, setTimeSignature] = useState('4/4');
          const [tapTimes, setTapTimes] = useState([]);
          const timerRef = useRef(null);
          const audioCtxRef = useRef(null);

          const getTempoName = (currentBpm) => {
            if (currentBpm <= 60) return 'Largo';
            if (currentBpm <= 76) return 'Adagio';
            if (currentBpm <= 108) return 'Andante';
            if (currentBpm <= 120) return 'Moderato';
            if (currentBpm <= 156) return 'Allegro';
            if (currentBpm <= 176) return 'Vivace';
            return 'Presto';
          };
          const playClick = () => {
            if (isMuted) return;
            if (!audioCtxRef.current) { audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)(); }
            const ctx = audioCtxRef.current;
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            const isFirstBeat = beat === 0;
            osc.frequency.setValueAtTime(isFirstBeat ? 1000 : 500, ctx.currentTime);
            gain.gain.setValueAtTime(0.4, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
          };
          const handleTap = () => {
            const now = Date.now();
            const newTapTimes = [...tapTimes, now].slice(-4);
            setTapTimes(newTapTimes);
            if (newTapTimes.length >= 2) {
              const intervals = [];
              for (let i = 1; i < newTapTimes.length; i++) { intervals.push(newTapTimes[i] - newTapTimes[i - 1]); }
              const averageInterval = intervals.reduce((a, b) => a + b) / intervals.length;
              const newBpm = Math.round(60000 / averageInterval);
              if (newBpm >= 40 && newBpm <= 220) { setBpm(newBpm); }
            }
          };
          useEffect(() => {
            if (isPlaying) {
              const beatsInCompas = timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6;
              const interval = (60 / bpm) * 1000;
              if (timerRef.current) clearInterval(timerRef.current);
              timerRef.current = window.setInterval(() => {
                setBeat(prev => (prev + 1) % beatsInCompas);
                playClick();
              }, interval);
            } else {
              if (timerRef.current) clearInterval(timerRef.current);
              setBeat(0);
            }
            return () => { if (timerRef.current) clearInterval(timerRef.current); };
          }, [isPlaying, bpm, beat, timeSignature, isMuted]);

          return (
            <div className="bg-[#0b0f17] font-display antialiased text-white min-h-screen flex flex-col overflow-hidden relative pb-24 max-w-md mx-auto">
              <div className="absolute top-[-10%] left-[-10%] w-[120%] h-[50%] bg-gradient-to-b from-[#1a2542] to-transparent opacity-30 pointer-events-none"></div>
              <header className="flex items-center justify-between p-6 z-10">
                <button onClick={() => navigate(-1)} className="p-2 rounded-full active:bg-white/10 transition-colors"><span className="material-symbols-outlined text-[28px]">arrow_back</span></button>
                <h2 className="text-xl font-bold tracking-tight">Metrónomo</h2>
                <button onClick={() => setIsMuted(!isMuted)} className="p-2 rounded-full active:bg-white/10 transition-colors"><span className="material-symbols-outlined text-[28px]">{isMuted ? 'volume_off' : 'volume_up'}</span></button>
              </header>
              <main className="flex-1 flex flex-col items-center justify-center w-full px-8 gap-10 relative z-10 mt-[-20px]">
                <div className="relative flex items-center justify-center w-full">
                  <svg className="absolute w-[280px] h-[280px] rotate-[-90deg]">
                    <circle cx="140" cy="140" r="125" fill="transparent" stroke="#1a2333" strokeWidth="8" />
                    <circle cx="140" cy="140" r="125" fill="transparent" stroke="#135bec" strokeWidth="8" strokeDasharray="785" strokeDashoffset={isPlaying ? (785 - (785 * (beat + 1)) / (timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6)) : 785} className="transition-all duration-150 ease-out" strokeLinecap="round" style={{ filter: 'drop-shadow(0 0 8px rgba(19, 91, 236, 0.6))' }} />
                  </svg>
                  <div className="size-60 rounded-full bg-[#111622] border-4 border-[#1a2333] shadow-[0_0_40px_rgba(0,0,0,0.5)] flex flex-col items-center justify-center z-10 relative">
                    <h1 className="text-8xl font-black tracking-tighter leading-none mb-2">{bpm}</h1>
                    <p className="text-[#135bec] font-black text-xs tracking-[0.2em] uppercase">BPM</p>
                    <button onClick={() => setBpm(b => Math.max(40, b - 1))} className="absolute left-[-55px] size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-lg border border-white/5"><span className="material-symbols-outlined text-3xl">remove</span></button>
                    <button onClick={() => setBpm(b => Math.min(220, b + 1))} className="absolute right-[-55px] size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-lg border border-white/5"><span className="material-symbols-outlined text-3xl">add</span></button>
                  </div>
                </div>
                <div className="w-full flex items-center justify-between px-2 mt-4">
                  <span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Tempo</span>
                  <span className="text-sm font-bold text-[#135bec]">{getTempoName(bpm)}</span>
                </div>
                <div className="w-full">
                  <input type="range" min="40" max="220" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-1.5 bg-[#1c2333] rounded-lg appearance-none cursor-pointer accent-[#135bec]" style={{ background: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(220-40)*100}%, #1c2333 ${(bpm-40)/(220-40)*100}%, #1c2333 100%)` }} />
                </div>
                <div className="grid grid-cols-2 gap-4 w-full h-16">
                  <button onClick={handleTap} className="bg-[#111622] border border-white/5 rounded-2xl flex items-center justify-center gap-3 active:bg-[#1a2333] transition-colors shadow-inner"><span className="material-symbols-outlined text-[#135bec]">back_hand</span><span className="text-sm font-black tracking-widest">TAP</span></button>
                  <div className="bg-[#111622] border border-white/5 rounded-2xl flex items-center px-1 py-1 shadow-inner overflow-hidden">
                    {['4/4', '3/4', '6/8'].map((sig) => (
                      <button key={sig} onClick={() => setTimeSignature(sig)} className={`flex-1 h-full rounded-xl text-[11px] font-black transition-all ${timeSignature === sig ? 'bg-[#1c2333] text-[#135bec]' : 'text-gray-500'}`}>{sig}</button>
                    ))}
                  </div>
                </div>
                <button onClick={() => setIsPlaying(!isPlaying)} className={`size-24 rounded-full flex items-center justify-center transition-all active:scale-95 shadow-[0_0_30px_rgba(19,91,236,0.3)] ${isPlaying ? 'bg-white text-black' : 'bg-[#135bec] text-white'}`}><span className="material-symbols-outlined text-[48px] fill-1">{isPlaying ? 'pause' : 'play_arrow'}</span></button>
              </main>
              <BottomNav activeTab="metronome" />
            </div>
          );
        };

        const HealthScreen = () => {
          return (
            <div className="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 antialiased overflow-x-hidden min-h-screen pb-24">
              <header className="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 pt-4 pb-3">
                <div className="flex items-center justify-between mb-4">
                  <Link to="/" className="flex items-center justify-center p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined text-[28px]">arrow_back</span></Link>
                </div>
                <h1 className="text-3xl font-black tracking-tight">Salud Vocal</h1>
                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Consejos expertos y cuidado clínico para tu voz.</p>
              </header>
              <main className="px-4 pt-6 space-y-8">
                <section className="bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-lg">
                  <div className="flex items-start gap-4">
                    <div className="h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-primary shrink-0"><span className="material-symbols-outlined text-2xl">medical_services</span></div>
                    <div><h2 className="text-lg font-bold mb-1">Cuidado Profesional</h2><p className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">Tu voz es un instrumento biológico. Aquí encontrarás pautas basadas en la medicina foniátrica para mantenerla sana y potente.</p></div>
                  </div>
                </section>
                <section className="space-y-6">
                  <div className="flex items-center justify-between"><h2 className="text-xl font-black flex items-center gap-2"><span className="material-symbols-outlined text-green-500">verified</span>Consejos Certificados</h2></div>
                  <div className="grid gap-5">
                    {HEALTH_TIPS.map(tip => (
                      <div key={tip.id} className="bg-white dark:bg-[#1c2333] p-5 rounded-2xl border border-gray-200 dark:border-gray-800 shadow-sm hover:shadow-md transition-all">
                        <div className="flex items-center gap-3 mb-3">
                          <div className="h-8 w-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary"><span className="material-symbols-outlined text-lg">{tip.icon}</span></div>
                          <h3 className="text-base font-bold leading-tight">{tip.title}</h3>
                        </div>
                        <p className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed mb-4">{tip.content}</p>
                        <div className="flex items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-3 mt-2">
                          <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Fuente</span>
                          <a href={tip.sourceUrl} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-[11px] font-bold text-primary hover:underline">{tip.source}<span className="material-symbols-outlined text-[14px]">open_in_new</span></a>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
                <section className="bg-gradient-to-br from-primary/10 to-blue-500/10 rounded-3xl p-6 border border-primary/20">
                  <h2 className="text-lg font-black mb-4 flex items-center gap-2"><span className="material-symbols-outlined text-primary">info</span> Tip Rápido</h2>
                  <p className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed italic">"Si tienes ronquera (disfonía) que dura más de 2 semanas sin un resfriado aparente, consulta inmediatamente a un otorrinolaringólogo."</p>
                </section>
              </main>
              <BottomNav activeTab="health" />
            </div>
          );
        };

        const ScalesScreen = () => {
          const navigate = useNavigate();
          const [customScales, setCustomScales] = useState([]);
          const [playingId, setPlayingId] = useState(null);
          const [scaleToDelete, setScaleToDelete] = useState(null);

          const [selectedNote, setSelectedNote] = useState("C");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);

          const loadScales = () => {
            try {
              const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (Array.isArray(saved)) {
                const formatted = saved.map(s => ({ ...s, id: s.id.toString() }));
                setCustomScales(formatted.sort((a, b) => b.createdAt - a.createdAt));
              }
            } catch (e) { console.error("Error loading scales", e); setCustomScales([]); }
          };
          useEffect(() => { loadScales(); }, []);

          const calculateRelativesFromAbsolute = (notes) => {
            if (!notes || notes.length === 0) return [];
            const getVal = (n) => {
               const m = n.match(/^([A-G][#]?)(-?\d+)$/);
               if (!m) return 0;
               return (parseInt(m[2]) * 12) + NOTES.indexOf(m[1]);
            };
            const rootVal = getVal(notes[0].note);
            return notes.map(n => ({
              interval: getVal(n.note) - rootVal,
              duration: n.duration
            }));
          };

          const playCustom = async (e, scale) => {
            e.preventDefault(); e.stopPropagation();
            if (playingId === scale.id) { audioService.stop(); setPlayingId(null); return; }
            if (playingId) { audioService.stop(); }
            setPlayingId(scale.id);

            if (scale.relativeNotes && scale.relativeNotes.length > 0) {
              await audioService.playCustomElasticScale(selectedNote, startOctave, endOctave, scale.relativeNotes, bpm);
            } else {
              const calculatedRelatives = calculateRelativesFromAbsolute(scale.notes);
              if (calculatedRelatives.length > 0) {
                 await audioService.playCustomElasticScale(selectedNote, startOctave, endOctave, calculatedRelatives, bpm);
              } else {
                await audioService.playSequence(scale.notes, bpm);
              }
            }
            setPlayingId(null);
          };
          const requestDelete = (e, id) => { e.preventDefault(); e.stopPropagation(); setScaleToDelete(id); };
          const confirmDelete = () => {
            if (!scaleToDelete) return;
            try {
              const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              const updated = saved.filter(s => s.id.toString() !== scaleToDelete.toString());
              localStorage.setItem('vocal_scales', JSON.stringify(updated));
              const formattedUpdated = updated.map(s => ({ ...s, id: s.id.toString() }));
              setCustomScales(formattedUpdated.sort((a, b) => b.createdAt - a.createdAt));
              setScaleToDelete(null);
            } catch (err) { console.error("Error al eliminar escala:", err); }
          };
          const editScale = (e, id) => { e.preventDefault(); e.stopPropagation(); navigate(`/edit-scale/${id}`); };

          return (
            <div className="bg-[#0b0f17] text-white min-h-screen pb-32 max-w-md mx-auto relative font-display">
              <header className="px-6 pt-10 pb-6 border-b border-gray-800 relative z-[20]">
                <h1 className="text-3xl font-bold tracking-tight">Biblioteca</h1>
                <p className="text-gray-500 mt-1 italic text-sm">Gestiona tus escalas personalizadas aquí.</p>
              </header>

              <div className="bg-[#111622] border-b border-gray-800 px-6 py-4 sticky top-0 z-[30] shadow-xl">
                <div className="flex flex-col gap-4">
                  <div className="flex items-center justify-between">
                     <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Configuración de Reproducción</h3>
                     <div className="flex gap-2">
                        <span className="text-[10px] bg-primary/20 text-primary px-2 py-1 rounded font-bold">{selectedNote}{startOctave}-{selectedNote}{endOctave}</span>
                        <span className="text-[10px] bg-gray-800 text-gray-300 px-2 py-1 rounded font-bold">{bpm} BPM</span>
                     </div>
                  </div>
                  <div className="grid grid-cols-3 gap-2">
                     <div className="relative">
                        <select value={selectedNote} onChange={(e) => setSelectedNote(e.target.value)} className="w-full h-10 bg-[#1c2333] border border-gray-700 rounded-lg text-xs font-bold px-3 appearance-none outline-none focus:border-primary">
                          {NOTES.map(n => <option key={n} value={n}>{n}</option>)}
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div>
                     </div>
                     <div className="relative">
                        <select value={startOctave} onChange={(e) => setStartOctave(Number(e.target.value))} className="w-full h-10 bg-[#1c2333] border border-gray-700 rounded-lg text-xs font-bold px-3 appearance-none outline-none focus:border-primary">
                          {[2, 3, 4, 5].map(n => <option key={n} value={n}>Oct {n}</option>)}
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div>
                     </div>
                     <div className="relative">
                        <select value={endOctave} onChange={(e) => setEndOctave(Number(e.target.value))} className="w-full h-10 bg-[#1c2333] border border-gray-700 rounded-lg text-xs font-bold px-3 appearance-none outline-none focus:border-primary">
                          {[2, 3, 4, 5, 6].map(n => <option key={n} value={n}>Oct {n}</option>)}
                        </select>
                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div>
                     </div>
                  </div>
                  <div className="flex flex-col gap-1 mt-1">
                    <div className="flex justify-between items-center px-1"><span className="text-[10px] text-gray-500 font-bold uppercase">Velocidad</span></div>
                    <div className="relative w-full h-6 flex items-center">
                        <input type="range" min="40" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-1.5 bg-[#1c2333] rounded-lg appearance-none cursor-pointer accent-primary focus:outline-none z-10" style={{ backgroundImage: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(240-40)*100}%, #1c2333 ${(bpm-40)/(240-40)*100}%, #1c2333 100%)` }} />
                    </div>
                  </div>
                </div>
              </div>

              <main className="px-6 py-8 space-y-6 relative z-[10]">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-bold flex items-center gap-2"><span className="material-symbols-outlined text-primary">auto_stories</span> Mis Escalas</h2>
                  <span className="text-[10px] text-gray-500 font-black uppercase tracking-widest">{customScales.length} escalas</span>
                </div>
                {customScales.length === 0 ? (
                  <div className="py-24 flex flex-col items-center justify-center text-center bg-white/5 rounded-3xl border-2 border-dashed border-gray-800">
                    <span className="material-symbols-outlined text-6xl mb-4 opacity-10">music_note</span>
                    <p className="text-sm font-bold text-gray-500 mb-6">Aún no tienes escalas personalizadas.</p>
                    <button type="button" onClick={() => navigate('/create-scale')} className="h-12 px-8 bg-primary text-white text-xs font-black rounded-xl shadow-glow uppercase tracking-widest active:scale-95">Crear Escala</button>
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {customScales.map(scale => (
                      <div key={scale.id} className={`bg-[#1c2333] p-5 rounded-2xl border transition-all relative group overflow-hidden ${playingId === scale.id ? 'border-primary shadow-glow' : 'border-gray-800'}`}>
                        <div className="flex items-center justify-between relative z-10">
                          <div onClick={(e) => playCustom(e, scale)} className="flex items-center gap-4 flex-1 min-w-0 pr-2 cursor-pointer group/info">
                            <div className={`size-12 rounded-xl flex items-center justify-center transition-all shrink-0 ${playingId === scale.id ? 'bg-red-500 text-white shadow-lg shadow-red-500/40' : 'bg-primary/10 text-primary group-hover/info:bg-primary/20'}`}>
                              <span className="material-symbols-outlined text-2xl pointer-events-none">{playingId === scale.id ? 'stop' : 'play_arrow'}</span>
                            </div>
                            <div className="min-w-0">
                              <h3 className={`font-bold text-base truncate pr-2 ${playingId === scale.id ? 'text-primary' : 'text-white'}`}>{scale.name}</h3>
                              <p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">{scale.notes.length} notas en patrón</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2 shrink-0 relative z-[40]">
                            <button type="button" onClick={(e) => editScale(e, scale.id)} className="size-10 rounded-full bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white flex items-center justify-center transition-all active:scale-90 border border-blue-500/20 cursor-pointer" title="Editar"><span className="material-symbols-outlined text-xl pointer-events-none">edit</span></button>
                            <button type="button" onClick={(e) => requestDelete(e, scale.id)} className="size-10 rounded-full bg-red-500/10 text-red-500 hover:bg-red-600 hover:text-white flex items-center justify-center transition-all active:scale-90 border border-red-500/20 cursor-pointer" title="Eliminar"><span className="material-symbols-outlined text-xl pointer-events-none">delete</span></button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </main>
              <button type="button" onClick={() => navigate('/create-scale')} className="fixed bottom-24 right-6 size-16 rounded-full bg-primary text-white shadow-glow flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-[110]"><span className="material-symbols-outlined text-3xl">add</span></button>
              {scaleToDelete && (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                  <div className="bg-[#161c27] rounded-3xl p-6 shadow-2xl max-w-xs w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200">
                    <div className="flex flex-col items-center text-center gap-4">
                      <div className="size-16 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-1 border border-red-500/20"><span className="material-symbols-outlined text-3xl">delete_forever</span></div>
                      <div><h3 className="text-xl font-bold mb-2 text-white">¿Eliminar Escala?</h3><p className="text-sm text-gray-400 leading-relaxed">¿Estás seguro de que quieres eliminar permanentemente esta escala?</p></div>
                      <div className="flex gap-3 w-full mt-3">
                        <button onClick={() => setScaleToDelete(null)} className="flex-1 h-12 rounded-xl font-bold text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors">Cancelar</button>
                        <button onClick={confirmDelete} className="flex-1 h-12 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 shadow-lg shadow-red-500/30 transition-all active:scale-95">Eliminar</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const CreateScaleScreen = () => {
          const navigate = useNavigate();
          const { id } = useParams();
          const [scaleName, setScaleName] = useState('');
          const [selectedDuration, setSelectedDuration] = useState('quarter');
          const [sequence, setSequence] = useState([]);
          const [showClearModal, setShowClearModal] = useState(false);
          const [currentOctave, setCurrentOctave] = useState(4);

          useEffect(() => {
            if (id) {
              try {
                const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
                const scaleToEdit = savedScales.find(s => s.id.toString() === id.toString());
                if (scaleToEdit) { setScaleName(scaleToEdit.name); setSequence(scaleToEdit.notes); } else { navigate('/scales'); }
              } catch (e) { console.error("Error loading scale to edit", e); navigate('/scales'); }
            }
          }, [id, navigate]);
          const addNote = (note) => {
            const newItem = { note, duration: selectedDuration };
            setSequence([...sequence, newItem]);
            audioService.playNote(note, 0.4);
          };
          const undo = () => { setSequence(prev => prev.slice(0, -1)); };
          const requestClear = (e) => { e.preventDefault(); e.stopPropagation(); setShowClearModal(true); };
          const confirmClear = () => { setSequence([]); setShowClearModal(false); };
          
          const getNoteValue = (noteStr) => {
            const match = noteStr.match(/^([A-G][#]?)(-?\d+)$/);
            if (!match) return 0;
            const [_, name, octaveStr] = match;
            const octave = parseInt(octaveStr, 10);
            const noteIndex = NOTES.indexOf(name);
            return (octave * 12) + noteIndex;
          };

          const handleSave = () => {
            if (!scaleName.trim()) { alert("Por favor, ingresa un nombre para la escala."); return; }
            if (sequence.length === 0) { alert("Por favor, añade al menos una nota."); return; }

            const rootNoteValue = getNoteValue(sequence[0].note);
            const relativeNotes = sequence.map(s => ({
              interval: getNoteValue(s.note) - rootNoteValue,
              duration: s.duration
            }));

            try {
              const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (id) {
                const updatedScales = savedScales.map(s => s.id.toString() === id.toString() ? { ...s, name: scaleName, notes: sequence, relativeNotes: relativeNotes } : s);
                localStorage.setItem('vocal_scales', JSON.stringify(updatedScales));
              } else {
                const newScale = { id: Date.now().toString(), name: scaleName, notes: sequence, relativeNotes: relativeNotes, createdAt: Date.now() };
                localStorage.setItem('vocal_scales', JSON.stringify([...savedScales, newScale]));
              }
              navigate('/scales');
            } catch (e) { console.error("Error saving scale", e); }
          };
          const playSequence = async () => { if (sequence.length === 0) return; await audioService.playSequence(sequence, 120); };
          const durationLabels = { whole: 'Redonda', half: 'Blanca', quarter: 'Negra', eighth: 'Corchea' };
          const baseNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
          const whiteKeys = [
            ...baseNotes.map(n => `${n}${currentOctave}`),
            `C${currentOctave + 1}`
          ];
          const blackKeysConfig = [ { noteBase: 'C#', left: '8.5%' }, { noteBase: 'D#', left: '21%' }, { noteBase: 'F#', left: '46%' }, { noteBase: 'G#', left: '58.5%' }, { noteBase: 'A#', left: '71%' } ];

          return (
            <div className="relative flex h-screen w-full flex-col overflow-hidden max-w-md mx-auto bg-[#0b0f17] shadow-2xl text-white font-display">
              <header className="flex items-center justify-between p-4 shrink-0 relative z-[400] bg-[#0b0f17] border-b border-white/5">
                <button type="button" onClick={() => navigate('/scales')} className="flex items-center justify-center size-12 text-slate-400 hover:text-white transition-colors active:scale-90 cursor-pointer" aria-label="Cerrar"><span className="material-symbols-outlined text-[36px] pointer-events-none">close</span></button>
                <h1 className="text-xl font-bold tracking-tight">{id ? 'Editar Escala' : 'Nueva Escala'}</h1>
                <button type="button" onClick={handleSave} className="bg-primary px-5 h-10 rounded-xl text-white font-black text-xs uppercase tracking-widest active:scale-95 shadow-glow cursor-pointer">{id ? 'Listo' : 'Guardar'}</button>
              </header>
              <main className="flex-1 overflow-y-auto no-scrollbar pb-[340px] px-5 pt-6 relative z-10">
                <div className="mb-6">
                  <label className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Nombre</label>
                  <input value={scaleName} onChange={(e) => setScaleName(e.target.value)} className="w-full bg-[#161c27] border border-gray-800 rounded-2xl px-5 py-4 text-base focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" placeholder="Ej. Mi Escala..." />
                </div>
                <div className="mb-8">
                  <span className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Duración</span>
                  <div className="flex p-1.5 bg-[#1c1f27] rounded-2xl">
                    {['whole', 'half', 'quarter', 'eighth'].map((dur) => (
                      <button key={dur} type="button" onClick={() => setSelectedDuration(dur)} className={`flex-1 h-11 flex items-center justify-center rounded-xl text-[10px] font-black transition-all ${selectedDuration === dur ? 'bg-[#32394a] text-primary shadow-xl ring-1 ring-white/5' : 'text-slate-600'}`}>{durationLabels[dur]}</button>
                    ))}
                  </div>
                </div>
                <div className="mb-2 flex items-center justify-between relative z-[100]">
                  <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest">Secuencia Visual</h3>
                  <div className="flex items-center gap-3">
                    <span className="text-[10px] text-primary font-black uppercase bg-primary/10 px-2 py-0.5 rounded-full">{sequence.length} Notas</span>
                    {sequence.length > 0 && (<button type="button" onClick={requestClear} className="text-[10px] font-black text-red-500 hover:text-red-400 uppercase tracking-widest px-4 py-2 rounded-xl bg-red-500/10 hover:bg-red-500/20 active:scale-90 cursor-pointer pointer-events-auto transition-all">Limpiar</button>)}
                  </div>
                </div>
                <div className="h-44 bg-[#111620] border border-gray-800 rounded-3xl relative overflow-hidden flex items-center px-4 shadow-inner mt-4">
                  <div className="absolute inset-0 flex flex-col justify-center gap-[12px] opacity-10 pointer-events-none px-6">{[1, 2, 3, 4, 5].map(i => <div key={i} className="h-[1.5px] w-full bg-white"></div>)}</div>
                  <div className="flex gap-6 overflow-x-auto no-scrollbar w-full py-6 z-10 items-center">
                    {sequence.length === 0 ? (
                      <div className="w-full text-center flex flex-col items-center gap-2 opacity-30"><span className="material-symbols-outlined text-4xl">music_note</span><span className="text-[10px] font-black uppercase">Toca el piano para añadir notas</span></div>
                    ) : (
                      sequence.map((item, idx) => (
                        <div key={idx} className="flex flex-col items-center gap-3 shrink-0">
                          <div className={`size-14 rounded-full flex items-center justify-center shadow-2xl ring-4 ${idx === sequence.length - 1 ? 'bg-primary ring-primary/20 scale-110' : 'bg-[#32394a] ring-white/5'}`}><span className="text-sm font-black text-white">{item.note}</span></div>
                          <span className="text-[8px] font-black text-slate-500 uppercase">{durationLabels[item.duration].slice(0, 3)}</span>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </main>
              <div className="absolute bottom-0 w-full bg-[#151921] border-t border-gray-800 shadow-[0_-15px_40px_rgba(0,0,0,0.6)] z-[200] flex flex-col pointer-events-auto">
                <div className="flex items-center justify-between px-4 py-4 gap-2">
                  <button type="button" onClick={playSequence} disabled={sequence.length === 0} className={`flex items-center gap-2 active:scale-95 transition-all shrink-0 ${sequence.length === 0 ? 'opacity-20 grayscale' : 'text-primary'}`}><span className="material-symbols-outlined fill-1 text-[36px] pointer-events-none">play_circle</span></button>
                  <div className="flex items-center justify-center gap-1 bg-[#0b0f17] p-1 rounded-xl border border-white/5">
                    {[3, 4, 5].map(oct => (
                      <button key={oct} onClick={() => setCurrentOctave(oct)} className={`h-8 w-10 rounded-lg text-[10px] font-black transition-all ${currentOctave === oct ? 'bg-primary text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>C{oct}</button>
                    ))}
                  </div>
                  <div className="flex items-center gap-3 shrink-0">
                    <button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">undo</span></button>
                    <button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">backspace</span></button>
                  </div>
                </div>
                <div className="relative h-64 w-full select-none bg-[#101622] flex border-t border-white/5">
                  {whiteKeys.map((note) => (
                    <div key={note} onClick={() => addNote(note)} className="relative flex-1 bg-white border-r border-slate-300 rounded-b-2xl active:bg-slate-200 cursor-pointer shadow-inner"><span className="absolute bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-400 uppercase pointer-events-none">{note}</span></div>
                  ))}
                  {blackKeysConfig.map((bk) => {
                    const noteName = `${bk.noteBase}${currentOctave}`;
                    return (<div key={noteName} onClick={() => addNote(noteName)} style={{ left: bk.left }} className="absolute top-0 w-[10%] h-[55%] bg-[#1a1f2b] border border-black rounded-b-xl z-10 active:bg-slate-800 shadow-2xl cursor-pointer"></div>);
                  })}
                </div>
              </div>
              {showClearModal && (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                  <div className="bg-[#161c27] rounded-3xl p-6 shadow-2xl max-w-xs w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200">
                    <div className="flex flex-col items-center text-center gap-4">
                      <div className="size-16 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500 mb-1 border border-orange-500/20"><span className="material-symbols-outlined text-3xl">cleaning_services</span></div>
                      <div><h3 className="text-xl font-bold mb-2 text-white">¿Limpiar Notas?</h3><p className="text-sm text-gray-400 leading-relaxed">¿Deseas borrar toda la secuencia de notas actual?</p></div>
                      <div className="flex gap-3 w-full mt-3">
                        <button onClick={() => setShowClearModal(false)} className="flex-1 h-12 rounded-xl font-bold text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors">Cancelar</button>
                        <button onClick={confirmClear} className="flex-1 h-12 rounded-xl font-bold text-white bg-orange-500 hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all active:scale-95">Borrar Todo</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const App = () => (
            <HashRouter>
                <div className="max-w-md mx-auto bg-background-light dark:bg-background-dark min-h-screen shadow-2xl overflow-hidden relative border-x border-gray-200 dark:border-gray-800">
                    <Routes>
                        <Route path="/" element={<HomeScreen />} />
                        <Route path="/metronome" element={<MetronomeScreen />} />
                        <Route path="/health" element={<HealthScreen />} />
                        <Route path="/scales" element={<ScalesScreen />} />
                        <Route path="/create-scale" element={<CreateScaleScreen />} />
                        <Route path="/edit-scale/:id" element={<CreateScaleScreen />} />
                    </Routes>
                </div>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>