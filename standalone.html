<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VocalTune Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1c2333",
                        "surface-border": "#2e3440",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    boxShadow: {
                        "glow": "0 0 20px rgba(19, 91, 236, 0.4)",
                    }
                },
            },
        }
        
        // Manejador de errores visual
        window.onerror = function(msg, url, line, col, error) {
            console.error(msg, error);
            // No bloquear la UI si es un error menor, pero registrarlo
            return false;
        };
    </script>
    <style>
        body { background-color: #101622; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #135bec; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #3b4354; border-radius: 2px; }
    </style>
</head>
<body class="font-display antialiased text-slate-900 dark:text-white">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // Global Imports
        const { useState, useEffect, useRef } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams } = ReactRouterDOM;

        // --- CONSTANTS ---
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTE_FREQUENCIES = { 
            "C3": 130.81, "C#3": 138.59, "D3": 146.83, "D#3": 155.56, "E3": 164.81, "F3": 174.61, "F#3": 185.00, "G3": 196.00, "G#3": 207.65, "A3": 220.00, "A#3": 233.08, "B3": 246.94,
            "C4": 261.63, "C#4": 277.18, "D4": 293.66, "D#4": 311.13, "E4": 329.63, "F4": 349.23, "F#4": 369.99, "G4": 392.00, "G#4": 415.30, "A4": 440.00, "A#4": 466.16, "B4": 493.88,
            "C5": 523.25, "C#5": 554.37, "D5": 587.33, "D#5": 622.25, "E5": 659.25, "F5": 698.46, "F#5": 739.99, "G5": 783.99, "G#5": 830.61, "A5": 880.00, "A#5": 932.33, "B5": 987.77,
            "C6": 1046.50, "C#6": 1108.73, "D6": 1174.66, "D#6": 1244.51, "E6": 1318.51, "F6": 1396.91, "F#6": 1479.98, "G6": 1567.98, "G#6": 1661.22, "A6": 1760.00, "A#6": 1864.66, "B6": 1975.53 
        };
        const SCALE_INTERVALS = { 'Mayor': [0, 2, 4, 5, 7, 9, 11, 12], 'Menor': [0, 2, 3, 5, 7, 8, 10, 12], 'Pentatónica Mayor': [0, 2, 4, 7, 9, 12], 'Pentatónica Menor': [0, 3, 5, 7, 10, 12], 'Cromática': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'Blues': [0, 3, 5, 6, 7, 10, 12], 'Flamenca': [0, 1, 4, 5, 7, 8, 10, 12] };
        const VIDEOS = [ { id: 1, title: "7 Consejos para cuidar tu VOZ y evitar lesiones", duration: "10:24", channel: "Canto a la Vida", views: "340K", videoId: "i-B71v7lR_w", thumbnail: "https://img.youtube.com/vi/i-B71v7lR_w/0.jpg" }, { id: 2, title: "Alimentos prohibidos para cantantes", duration: "06:15", channel: "Vox Vocal Studio", views: "1.2M", videoId: "GjQ3T200TjE", thumbnail: "https://img.youtube.com/vi/GjQ3T200TjE/0.jpg" }, { id: 3, title: "Cómo calentar la voz correctamente", duration: "12:50", channel: "Vocal Academy", views: "890K", videoId: "zV049X9vDsw", thumbnail: "https://img.youtube.com/vi/zV049X9vDsw/0.jpg" }, { id: 4, title: "Ejercicios de relajación laríngea", duration: "08:33", channel: "Logopedia TV", views: "150K", videoId: "vWz_H-3j04U", thumbnail: "https://img.youtube.com/vi/vWz_H-3j04U/0.jpg" } ];

        // --- AUDIO SERVICE (PRECISE SCHEDULING & VOLUME BOOST) ---
        class PianoAudioService {
            constructor() { 
                this.ctx = null;
                this.unlocked = false;
                this.buffers = {};
                this.noteMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb" };
                
                const unlockHandler = () => {
                    this.initContext();
                    if (this.ctx && this.ctx.state !== 'running') {
                        this.ctx.resume().then(() => {
                            this.unlocked = true;
                            const buffer = this.ctx.createBuffer(1, 1, 22050);
                            const source = this.ctx.createBufferSource();
                            source.buffer = buffer;
                            source.connect(this.ctx.destination);
                            source.start(0);
                            ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => 
                                document.removeEventListener(evt, unlockHandler)
                            );
                        });
                    }
                };
                ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => 
                    document.addEventListener(evt, unlockHandler)
                );
            }

            initContext() { 
                if (!this.ctx) { 
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        this.ctx = new AudioContext(); 
                    }
                } 
            }

            mapNoteToFileName(note) {
                const match = note.match(/^([A-G][#]?)(-?\d+)$/);
                if (!match) return note;
                let [_, name, octave] = match;
                if (this.noteMap[name]) name = this.noteMap[name];
                return `${name}${octave}`;
            }

            async fetchSample(noteFile) {
                const url = `https://raw.githubusercontent.com/fuhton/piano-mp3/master/piano-mp3/${noteFile}.mp3`;
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                if (this.ctx) return await this.ctx.decodeAudioData(arrayBuffer);
                throw new Error("AudioContext not initialized");
            }

            async preloadNotes(notes) {
                const uniqueNotes = [...new Set(notes)];
                const promises = uniqueNotes.map(async (note) => {
                    const fileName = this.mapNoteToFileName(note);
                    if (!this.buffers[fileName]) {
                        try {
                            const buffer = await this.fetchSample(fileName);
                            this.buffers[fileName] = buffer;
                        } catch (e) { console.warn("Load failed", e); }
                    }
                });
                await Promise.all(promises);
            }

            playBufferAt(buffer, startTime, duration) {
                if (!this.ctx) return;
                const source = this.ctx.createBufferSource();
                const gain = this.ctx.createGain();
                
                // Volume Boost
                const VOLUME = 2.5;

                source.buffer = buffer;
                source.connect(gain);
                gain.connect(this.ctx.destination);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(VOLUME, startTime + 0.02);
                gain.gain.setValueAtTime(VOLUME, startTime + duration - 0.05); 
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration + 0.5);

                source.start(startTime);
                source.stop(startTime + duration + 0.6);
            }

            playSynthToneAt(freq, startTime, duration) {
                 if (!this.ctx) return;
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 const SYNTH_VOLUME = 0.8;

                 const real = new Float32Array([0, 1, 0.4, 0.2, 0.1]); 
                 const imag = new Float32Array(real.length).fill(0);
                 const wave = this.ctx.createPeriodicWave(real, imag);
                 osc.setPeriodicWave(wave);
                 
                 osc.frequency.setValueAtTime(freq, startTime);
                 gain.gain.setValueAtTime(0, startTime);
                 gain.gain.linearRampToValueAtTime(SYNTH_VOLUME, startTime + 0.02);
                 gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                 
                 osc.connect(gain);
                 gain.connect(this.ctx.destination);
                 osc.start(startTime);
                 osc.stop(startTime + duration + 0.1);
            }

            async playNote(note, duration = 0.5) {
                this.initContext();
                if (!this.ctx) return;
                const noteName = note;
                const fileName = this.mapNoteToFileName(noteName);

                if (this.buffers[fileName]) {
                    this.playBufferAt(this.buffers[fileName], this.ctx.currentTime, duration);
                } else {
                    try {
                        const buffer = await this.fetchSample(fileName);
                        this.buffers[fileName] = buffer;
                        this.playBufferAt(buffer, this.ctx.currentTime, duration);
                    } catch (e) {
                        const freq = NOTE_FREQUENCIES[noteName] || 440;
                        this.playSynthToneAt(freq, this.ctx.currentTime, duration);
                    }
                }
            }

            async playSequence(sequence, onStep) {
                this.initContext();
                if (!this.ctx) return;

                const noteNames = sequence.map(s => s.note);
                await this.preloadNotes(noteNames);

                const durMap = { 'whole': 1.6, 'half': 0.8, 'quarter': 0.4, 'eighth': 0.2 };
                const startTime = this.ctx.currentTime + 0.1;
                let elapsedTime = 0;

                sequence.forEach((item, index) => {
                    const duration = durMap[item.duration];
                    const fileName = this.mapNoteToFileName(item.note);
                    const buffer = this.buffers[fileName];

                    if (buffer) {
                        this.playBufferAt(buffer, startTime + elapsedTime, duration);
                    } else {
                        const freq = NOTE_FREQUENCIES[item.note] || 440;
                        this.playSynthToneAt(freq, startTime + elapsedTime, duration);
                    }
                    if (onStep) setTimeout(() => onStep(index), elapsedTime * 1000);
                    elapsedTime += duration;
                });

                return new Promise(resolve => setTimeout(resolve, elapsedTime * 1000 + 500));
            }

            async playScale(rootNote, octave, intervals, bpm = 100, onStep) {
                this.initContext();
                if (!this.ctx) return;

                const noteDuration = 60 / bpm;
                const rootIndex = NOTES.indexOf(rootNote);
                const rootOctave = parseInt(octave.replace('C', ''));
                const ascendingNotes = intervals.map(interval => {
                    let currentIdx = rootIndex + interval;
                    let currentOctave = rootOctave + Math.floor(currentIdx / 12);
                    let noteName = NOTES[currentIdx % 12];
                    return `${noteName}${currentOctave}`;
                });
                const fullSequence = [...ascendingNotes, ...ascendingNotes.slice(0, -1).reverse()];

                await this.preloadNotes(fullSequence);

                const startTime = this.ctx.currentTime + 0.1;
                let elapsedTime = 0;

                fullSequence.forEach((noteName, index) => {
                    const duration = noteDuration * 1.5;
                    const stepDuration = noteDuration;
                    const fileName = this.mapNoteToFileName(noteName);
                    const buffer = this.buffers[fileName];

                    if (buffer) {
                        this.playBufferAt(buffer, startTime + elapsedTime, duration);
                    } else {
                        const freq = NOTE_FREQUENCIES[noteName] || 440;
                        this.playSynthToneAt(freq, startTime + elapsedTime, duration);
                    }

                    if (onStep) setTimeout(() => onStep(index, fullSequence.length), elapsedTime * 1000);
                    elapsedTime += stepDuration;
                });

                return new Promise(resolve => setTimeout(resolve, elapsedTime * 1000 + 500));
            }
        }
        const audioService = new PianoAudioService();

        // --- COMPONENTS ---
        const NavButton = ({ to, icon, label, active }) => (
            <Link to={to} className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${active ? 'text-primary scale-110' : 'text-slate-400 hover:text-slate-200'}`}>
                <span className={`material-symbols-outlined text-[24px] ${active ? 'fill-1' : ''}`}>{icon}</span>
                <span className="text-[10px] font-bold tracking-tight">{label}</span>
            </Link>
        );
        const BottomNav = ({ activeTab }) => (
            <nav className="fixed bottom-0 left-0 right-0 z-[100] bg-white dark:bg-[#151b26] border-t border-slate-200 dark:border-slate-800 max-w-md mx-auto px-4 shadow-lg backdrop-blur-md bg-opacity-95">
                <div className="flex items-center justify-around h-16">
                    <NavButton to="/" icon="home" label="Inicio" active={activeTab === 'home'} />
                    <NavButton to="/scales" icon="library_music" label="Escalas" active={activeTab === 'scales'} />
                    <NavButton to="/health" icon="health_and_safety" label="Salud" active={activeTab === 'health'} />
                    <NavButton to="/metronome" icon="timer" label="Tempo" active={activeTab === 'metronome'} />
                </div>
                <div className="h-1.5 flex justify-center pb-2">
                    <div className="w-32 h-1 bg-slate-300 dark:bg-slate-700 rounded-full"></div>
                </div>
            </nav>
        );

        // --- SCREENS ---
        const HomeScreen = () => {
          const navigate = useNavigate();
          const [selectedScaleId, setSelectedScaleId] = useState("Mayor");
          const [selectedNote, setSelectedNote] = useState("C");
          const [selectedOctave, setSelectedOctave] = useState("C4");
          const [isPlaying, setIsPlaying] = useState(false);
          const [userScales, setUserScales] = useState([]);
          const [isDarkMode, setIsDarkMode] = useState(true);

          useEffect(() => {
            const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
            setUserScales(saved);
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') { document.documentElement.classList.add('dark'); setIsDarkMode(true); } 
            else { document.documentElement.classList.remove('dark'); setIsDarkMode(false); }
          }, []);

          const toggleDarkMode = () => {
            const next = !isDarkMode;
            setIsDarkMode(next);
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', next ? 'dark' : 'light');
          };
          const standardScales = ["Mayor", "Menor", "Pentatónica Mayor", "Pentatónica Menor", "Cromática", "Blues", "Flamenca"];
          const handleStart = async () => {
            if (isPlaying) return;
            setIsPlaying(true);
            const customScale = userScales.find(s => s.id === selectedScaleId);
            if (customScale) { await audioService.playSequence(customScale.notes); } 
            else { const intervals = SCALE_INTERVALS[selectedScaleId]; await audioService.playScale(selectedNote, selectedOctave, intervals, 110); }
            setIsPlaying(false);
          };
          const getDisplayScaleName = () => {
            const custom = userScales.find(s => s.id === selectedScaleId);
            return custom ? custom.name : `${selectedNote} ${selectedScaleId}`;
          };
          
          const getOctaveNumber = (oct) => oct.replace('C', '');

          return (
            <div className="relative flex h-screen w-full flex-col bg-background-light dark:bg-[#0b0f17] text-slate-900 dark:text-white overflow-hidden max-w-md mx-auto transition-colors duration-300">
              <header className="flex items-center justify-between px-6 py-5 shrink-0">
                <h1 className="text-xl font-bold tracking-tight">Vocalización</h1>
                <button onClick={toggleDarkMode} className="p-2 rounded-full bg-slate-200 dark:bg-white/5 text-slate-600 dark:text-white hover:scale-110 transition-all">
                  <span className="material-symbols-outlined text-[24px]">{isDarkMode ? 'light_mode' : 'dark_mode'}</span>
                </button>
              </header>
              <main className="flex-1 overflow-y-auto no-scrollbar px-6 pb-[340px] space-y-8">
                <section>
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold">Selecciona una escala</h2>
                    <button onClick={() => navigate('/create-scale')} className="text-primary text-xs font-bold flex items-center gap-1">
                      <span className="material-symbols-outlined text-sm">add</span> NUEVA
                    </button>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    {standardScales.map(scale => (
                      <button key={scale} onClick={() => setSelectedScaleId(scale)} className={`h-11 px-3 rounded-xl text-xs font-bold transition-all border text-center leading-tight ${selectedScaleId === scale ? 'bg-primary border-transparent text-white shadow-glow' : 'bg-white dark:bg-[#1c2333] border-slate-200 dark:border-gray-800 text-slate-500 dark:text-gray-400'}`}>
                        {scale}
                      </button>
                    ))}
                    {userScales.map(scale => (
                      <button key={scale.id} onClick={() => setSelectedScaleId(scale.id)} className={`h-11 px-3 rounded-xl text-xs font-bold transition-all border text-center leading-tight truncate ${selectedScaleId === scale.id ? 'bg-primary border-transparent text-white shadow-glow' : 'bg-white dark:bg-[#1c2333] border-slate-200 dark:border-gray-800 text-slate-500 dark:text-gray-400'}`}>
                        {scale.name}
                      </button>
                    ))}
                  </div>
                </section>
                <section>
                  <h2 className="text-lg font-bold mb-4">Elige la nota</h2>
                  <div className="grid grid-cols-4 gap-3">
                    {NOTES.map(note => (
                      <button key={note} onClick={() => { setSelectedNote(note); audioService.playNote(`${note}${getOctaveNumber(selectedOctave)}`, 0.3); }} className={`h-14 rounded-xl text-base font-bold transition-all flex items-center justify-center border-2 ${selectedNote === note ? 'bg-primary border-primary text-white shadow-glow' : 'bg-white dark:bg-[#1c2333] border-transparent text-slate-700 dark:text-white active:scale-95'}`}>
                        {note}
                      </button>
                    ))}
                  </div>
                </section>
                <section>
                  <h2 className="text-lg font-bold mb-4">Octava del Piano</h2>
                  <div className="bg-slate-200 dark:bg-[#1c2333] p-2 rounded-2xl border border-slate-300 dark:border-gray-800 grid grid-cols-4 gap-2">
                    {['C3', 'C4', 'C5', 'C6'].map(oct => (
                      <button key={oct} onClick={() => { setSelectedOctave(oct); audioService.playNote(`${selectedNote}${getOctaveNumber(oct)}`, 0.3); }} className={`h-14 rounded-xl text-sm font-black transition-all flex items-center justify-center ${selectedOctave === oct ? 'bg-primary text-white shadow-glow scale-[1.02]' : 'bg-white dark:bg-white/5 text-slate-400 dark:text-gray-500 border border-transparent dark:hover:border-gray-700'}`}>
                        {oct}
                      </button>
                    ))}
                  </div>
                </section>
              </main>
              <div className="fixed bottom-16 left-0 right-0 px-5 pt-4 pb-6 bg-gradient-to-t from-background-light dark:from-[#0b0f17] via-background-light dark:via-[#0b0f17] to-transparent z-[60] max-w-md mx-auto">
                <div className="bg-white dark:bg-[#161c27] rounded-2xl p-4 border border-slate-200 dark:border-gray-800 mb-4 flex items-center justify-between shadow-xl">
                  <div>
                    <p className="text-[10px] font-bold text-slate-400 dark:text-gray-500 uppercase tracking-widest mb-1">Configuración Actual</p>
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white">{getDisplayScaleName()} <span className="text-slate-300 dark:text-gray-500 mx-1">•</span> {selectedOctave}</h3>
                  </div>
                  <div className="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary"><span className="material-symbols-outlined fill-1">music_note</span></div>
                </div>
                <button onClick={handleStart} disabled={isPlaying} className={`w-full h-14 rounded-xl bg-primary hover:bg-blue-600 text-white font-bold flex items-center justify-center gap-3 transition-all active:scale-95 shadow-[0_8px_25px_rgba(19,91,236,0.4)] ${isPlaying ? 'opacity-70' : ''}`}>
                  <span className="material-symbols-outlined fill-1">{isPlaying ? 'graphic_eq' : 'play_arrow'}</span>
                  <span className="text-base tracking-wide uppercase">{isPlaying ? 'Tocando...' : 'Comenzar'}</span>
                </button>
              </div>
              <BottomNav activeTab="home" />
            </div>
          );
        };

        const MetronomeScreen = () => {
          const navigate = useNavigate();
          const [bpm, setBpm] = useState(120);
          const [isPlaying, setIsPlaying] = useState(false);
          const [beat, setBeat] = useState(0);
          const [isMuted, setIsMuted] = useState(false);
          const [timeSignature, setTimeSignature] = useState('4/4');
          const [tapTimes, setTapTimes] = useState([]);
          const timerRef = useRef(null);
          const audioCtxRef = useRef(null);

          const getTempoName = (currentBpm) => {
            if (currentBpm <= 60) return 'Largo';
            if (currentBpm <= 76) return 'Adagio';
            if (currentBpm <= 108) return 'Andante';
            if (currentBpm <= 120) return 'Moderato';
            if (currentBpm <= 156) return 'Allegro';
            if (currentBpm <= 176) return 'Vivace';
            return 'Presto';
          };
          const playClick = () => {
            if (isMuted) return;
            if (!audioCtxRef.current) { audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)(); }
            const ctx = audioCtxRef.current;
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            const isFirstBeat = beat === 0;
            osc.frequency.setValueAtTime(isFirstBeat ? 1000 : 500, ctx.currentTime);
            gain.gain.setValueAtTime(0.4, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
          };
          const handleTap = () => {
            const now = Date.now();
            const newTapTimes = [...tapTimes, now].slice(-4);
            setTapTimes(newTapTimes);
            if (newTapTimes.length >= 2) {
              const intervals = [];
              for (let i = 1; i < newTapTimes.length; i++) { intervals.push(newTapTimes[i] - newTapTimes[i - 1]); }
              const averageInterval = intervals.reduce((a, b) => a + b) / intervals.length;
              const newBpm = Math.round(60000 / averageInterval);
              if (newBpm >= 40 && newBpm <= 220) { setBpm(newBpm); }
            }
          };
          useEffect(() => {
            if (isPlaying) {
              const beatsInCompas = timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6;
              const interval = (60 / bpm) * 1000;
              if (timerRef.current) clearInterval(timerRef.current);
              timerRef.current = window.setInterval(() => {
                setBeat(prev => (prev + 1) % beatsInCompas);
                playClick();
              }, interval);
            } else {
              if (timerRef.current) clearInterval(timerRef.current);
              setBeat(0);
            }
            return () => { if (timerRef.current) clearInterval(timerRef.current); };
          }, [isPlaying, bpm, beat, timeSignature, isMuted]);

          return (
            <div className="bg-[#0b0f17] font-display antialiased text-white min-h-screen flex flex-col overflow-hidden relative pb-24 max-w-md mx-auto">
              <div className="absolute top-[-10%] left-[-10%] w-[120%] h-[50%] bg-gradient-to-b from-[#1a2542] to-transparent opacity-30 pointer-events-none"></div>
              <header className="flex items-center justify-between p-6 z-10">
                <button onClick={() => navigate(-1)} className="p-2 rounded-full active:bg-white/10 transition-colors"><span className="material-symbols-outlined text-[28px]">arrow_back</span></button>
                <h2 className="text-xl font-bold tracking-tight">Metrónomo</h2>
                <button onClick={() => setIsMuted(!isMuted)} className="p-2 rounded-full active:bg-white/10 transition-colors"><span className="material-symbols-outlined text-[28px]">{isMuted ? 'volume_off' : 'volume_up'}</span></button>
              </header>
              <main className="flex-1 flex flex-col items-center justify-center w-full px-8 gap-10 relative z-10 mt-[-20px]">
                <div className="relative flex items-center justify-center w-full">
                  <svg className="absolute w-[280px] h-[280px] rotate-[-90deg]">
                    <circle cx="140" cy="140" r="125" fill="transparent" stroke="#1a2333" strokeWidth="8" />
                    <circle cx="140" cy="140" r="125" fill="transparent" stroke="#135bec" strokeWidth="8" strokeDasharray="785" strokeDashoffset={isPlaying ? (785 - (785 * (beat + 1)) / (timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6)) : 785} className="transition-all duration-150 ease-out" strokeLinecap="round" style={{ filter: 'drop-shadow(0 0 8px rgba(19, 91, 236, 0.6))' }} />
                  </svg>
                  <div className="size-60 rounded-full bg-[#111622] border-4 border-[#1a2333] shadow-[0_0_40px_rgba(0,0,0,0.5)] flex flex-col items-center justify-center z-10 relative">
                    <h1 className="text-8xl font-black tracking-tighter leading-none mb-2">{bpm}</h1>
                    <p className="text-[#135bec] font-black text-xs tracking-[0.2em] uppercase">BPM</p>
                    <button onClick={() => setBpm(b => Math.max(40, b - 1))} className="absolute left-[-55px] size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-lg border border-white/5"><span className="material-symbols-outlined text-3xl">remove</span></button>
                    <button onClick={() => setBpm(b => Math.min(220, b + 1))} className="absolute right-[-55px] size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-lg border border-white/5"><span className="material-symbols-outlined text-3xl">add</span></button>
                  </div>
                </div>
                <div className="w-full flex items-center justify-between px-2 mt-4">
                  <span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Tempo</span>
                  <span className="text-sm font-bold text-[#135bec]">{getTempoName(bpm)}</span>
                </div>
                <div className="w-full">
                  <input type="range" min="40" max="220" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-1.5 bg-[#1c2333] rounded-lg appearance-none cursor-pointer accent-[#135bec]" style={{ background: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(220-40)*100}%, #1c2333 ${(bpm-40)/(220-40)*100}%, #1c2333 100%)` }} />
                </div>
                <div className="grid grid-cols-2 gap-4 w-full h-16">
                  <button onClick={handleTap} className="bg-[#111622] border border-white/5 rounded-2xl flex items-center justify-center gap-3 active:bg-[#1a2333] transition-colors shadow-inner"><span className="material-symbols-outlined text-[#135bec]">back_hand</span><span className="text-sm font-black tracking-widest">TAP</span></button>
                  <div className="bg-[#111622] border border-white/5 rounded-2xl flex items-center px-1 py-1 shadow-inner overflow-hidden">
                    {['4/4', '3/4', '6/8'].map((sig) => (
                      <button key={sig} onClick={() => setTimeSignature(sig)} className={`flex-1 h-full rounded-xl text-[11px] font-black transition-all ${timeSignature === sig ? 'bg-[#1c2333] text-[#135bec]' : 'text-gray-500'}`}>{sig}</button>
                    ))}
                  </div>
                </div>
                <button onClick={() => setIsPlaying(!isPlaying)} className={`size-24 rounded-full flex items-center justify-center transition-all active:scale-95 shadow-[0_0_30px_rgba(19,91,236,0.3)] ${isPlaying ? 'bg-white text-black' : 'bg-[#135bec] text-white'}`}><span className="material-symbols-outlined text-[48px] fill-1">{isPlaying ? 'pause' : 'play_arrow'}</span></button>
              </main>
              <BottomNav activeTab="metronome" />
            </div>
          );
        };

        const HealthScreen = () => {
          const [activeVideo, setActiveVideo] = useState(null);
          return (
            <div className="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 antialiased overflow-x-hidden min-h-screen pb-24">
              <header className="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 pt-4 pb-3">
                <div className="flex items-center justify-between mb-4">
                  <Link to="/" className="flex items-center justify-center p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined text-[28px]">arrow_back</span></Link>
                  <div className="flex gap-3">
                    <button className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined">favorite</span></button>
                    <button className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined">share</span></button>
                  </div>
                </div>
                <h1 className="text-3xl font-black tracking-tight">Salud Vocal</h1>
                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Recursos y consejos para el cuidado de tu instrumento.</p>
              </header>
              <main className="px-4 pt-6 space-y-8">
                {activeVideo && (
                  <section className="animate-in fade-in slide-in-from-top-4 duration-500">
                    <div className="aspect-video w-full rounded-2xl overflow-hidden shadow-2xl border border-primary/20 bg-black">
                      <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${activeVideo}?autoplay=1`} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                    </div>
                    <button onClick={() => setActiveVideo(null)} className="mt-3 w-full py-2 text-primary font-bold text-sm bg-primary/10 rounded-xl">Cerrar Video</button>
                  </section>
                )}
                {!activeVideo && (
                   <section>
                    <h2 className="text-xl font-black mb-4 flex items-center gap-2"><span className="material-symbols-outlined text-red-500">local_fire_department</span> Lo más visto</h2>
                    <div onClick={() => setActiveVideo("vWz_H-3j04U")} className="relative group cursor-pointer overflow-hidden rounded-3xl shadow-xl bg-surface-dark">
                      <div className="aspect-video w-full bg-gray-800 relative">
                        <img alt="Featured Health" className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-all duration-500 group-hover:scale-105" src="https://picsum.photos/seed/vocal-health/800/450" />
                        <div className="absolute inset-0 flex items-center justify-center">
                          <div className="h-16 w-16 rounded-full bg-primary flex items-center justify-center shadow-glow group-hover:scale-110 transition-transform"><span className="material-symbols-outlined text-white text-[40px] ml-1">play_arrow</span></div>
                        </div>
                        <div className="absolute bottom-4 left-4 bg-black/60 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-white border border-white/20">Video del Mes</div>
                      </div>
                      <div className="p-5 bg-white dark:bg-surface-dark">
                        <h3 className="text-lg font-black leading-tight mb-2 line-clamp-2">Fundamentos de la Higiene Vocal: Qué hacer y qué evitar</h3>
                        <div className="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400"><img src="https://picsum.photos/seed/doctor/40/40" className="w-8 h-8 rounded-full" alt="channel" /><span>Dr. Voz • 1.2M vistas</span></div>
                      </div>
                    </div>
                  </section>
                )}
                <section className="space-y-6">
                  <h2 className="text-xl font-black">Biblioteca de Salud</h2>
                  <div className="grid gap-6">
                    {VIDEOS.map(video => (
                      <div key={video.id} onClick={() => { setActiveVideo(video.videoId); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="flex items-center gap-4 group cursor-pointer bg-white dark:bg-surface-dark/40 p-3 rounded-2xl border border-transparent hover:border-primary/30 transition-all active:scale-[0.98]">
                        <div className="relative w-32 aspect-video shrink-0 rounded-xl overflow-hidden shadow-md">
                          <img src={video.thumbnail} className="w-full h-full object-cover" alt={video.title} />
                          <div className="absolute bottom-1 right-1 bg-black/80 px-1.5 py-0.5 rounded text-[10px] font-bold text-white">{video.duration}</div>
                          <div className="absolute inset-0 bg-primary/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><span className="material-symbols-outlined text-white">play_circle</span></div>
                        </div>
                        <div className="flex-1 min-w-0">
                          <h3 className="text-sm font-bold leading-tight line-clamp-2 group-hover:text-primary transition-colors">{video.title}</h3>
                          <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-1 uppercase tracking-wider font-bold">{video.channel}</p>
                          <p className="text-[11px] text-slate-400 mt-0.5">{video.views} reproducciones</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
                <section className="bg-gradient-to-br from-primary/10 to-blue-500/10 rounded-3xl p-6 border border-primary/20">
                  <h2 className="text-lg font-black mb-4 flex items-center gap-2"><span className="material-symbols-outlined text-primary">info</span> Tip Rápido</h2>
                  <p className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed italic">"Nunca fuerces la voz si sientes carraspera o fatiga. El silencio es el mejor ejercicio en momentos de cansancio vocal."</p>
                </section>
              </main>
              <BottomNav activeTab="health" />
            </div>
          );
        };

        const ScalesScreen = () => {
          const navigate = useNavigate();
          const [customScales, setCustomScales] = useState([]);
          const [playingId, setPlayingId] = useState(null);
          const [scaleToDelete, setScaleToDelete] = useState(null);

          const loadScales = () => {
            try {
              const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (Array.isArray(saved)) {
                const formatted = saved.map(s => ({ ...s, id: s.id.toString() }));
                setCustomScales(formatted.sort((a, b) => b.createdAt - a.createdAt));
              }
            } catch (e) { console.error("Error loading scales", e); setCustomScales([]); }
          };
          useEffect(() => { loadScales(); }, []);
          const playCustom = async (e, scale) => {
            e.preventDefault(); e.stopPropagation();
            if (playingId) return;
            setPlayingId(scale.id);
            await audioService.playSequence(scale.notes);
            setPlayingId(null);
          };
          const requestDelete = (e, id) => { e.preventDefault(); e.stopPropagation(); setScaleToDelete(id); };
          const confirmDelete = () => {
            if (!scaleToDelete) return;
            try {
              const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              const updated = saved.filter(s => s.id.toString() !== scaleToDelete.toString());
              localStorage.setItem('vocal_scales', JSON.stringify(updated));
              const formattedUpdated = updated.map(s => ({ ...s, id: s.id.toString() }));
              setCustomScales(formattedUpdated.sort((a, b) => b.createdAt - a.createdAt));
              setScaleToDelete(null);
            } catch (err) { console.error("Error al eliminar escala:", err); }
          };
          const editScale = (e, id) => { e.preventDefault(); e.stopPropagation(); navigate(`/edit-scale/${id}`); };

          return (
            <div className="bg-[#0b0f17] text-white min-h-screen pb-32 max-w-md mx-auto relative font-display">
              <header className="px-6 pt-10 pb-6 border-b border-gray-800 relative z-[20]">
                <h1 className="text-3xl font-bold tracking-tight">Biblioteca</h1>
                <p className="text-gray-500 mt-1 italic text-sm">Gestiona tus escalas personalizadas aquí.</p>
              </header>
              <main className="px-6 py-8 space-y-6 relative z-[10]">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-bold flex items-center gap-2"><span className="material-symbols-outlined text-primary">auto_stories</span> Mis Escalas</h2>
                  <span className="text-[10px] text-gray-500 font-black uppercase tracking-widest">{customScales.length} escalas</span>
                </div>
                {customScales.length === 0 ? (
                  <div className="py-24 flex flex-col items-center justify-center text-center bg-white/5 rounded-3xl border-2 border-dashed border-gray-800">
                    <span className="material-symbols-outlined text-6xl mb-4 opacity-10">music_note</span>
                    <p className="text-sm font-bold text-gray-500 mb-6">Aún no tienes escalas personalizadas.</p>
                    <button type="button" onClick={() => navigate('/create-scale')} className="h-12 px-8 bg-primary text-white text-xs font-black rounded-xl shadow-glow uppercase tracking-widest active:scale-95">Crear Escala</button>
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {customScales.map(scale => (
                      <div key={scale.id} className="bg-[#1c2333] p-5 rounded-2xl border border-gray-800 relative group overflow-hidden">
                        <div className="flex items-center justify-between relative z-10">
                          <div onClick={(e) => playCustom(e, scale)} className="flex items-center gap-4 flex-1 min-w-0 pr-2 cursor-pointer group/info">
                            <div className={`size-12 rounded-xl bg-primary/10 flex items-center justify-center text-primary transition-all shrink-0 ${playingId === scale.id ? 'animate-pulse bg-primary text-white shadow-glow' : 'group-hover/info:bg-primary/20'}`}>
                              <span className="material-symbols-outlined text-2xl pointer-events-none">{playingId === scale.id ? 'graphic_eq' : 'play_arrow'}</span>
                            </div>
                            <div className="min-w-0">
                              <h3 className="font-bold text-base truncate pr-2">{scale.name}</h3>
                              <p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">{scale.notes.length} notas musicales</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2 shrink-0 relative z-[40]">
                            <button type="button" onClick={(e) => editScale(e, scale.id)} className="size-10 rounded-full bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white flex items-center justify-center transition-all active:scale-90 border border-blue-500/20 cursor-pointer" title="Editar"><span className="material-symbols-outlined text-xl pointer-events-none">edit</span></button>
                            <button type="button" onClick={(e) => requestDelete(e, scale.id)} className="size-10 rounded-full bg-red-500/10 text-red-500 hover:bg-red-600 hover:text-white flex items-center justify-center transition-all active:scale-90 border border-red-500/20 cursor-pointer" title="Eliminar"><span className="material-symbols-outlined text-xl pointer-events-none">delete</span></button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </main>
              <button type="button" onClick={() => navigate('/create-scale')} className="fixed bottom-24 right-6 size-16 rounded-full bg-primary text-white shadow-glow flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-[110]"><span className="material-symbols-outlined text-3xl">add</span></button>
              {scaleToDelete && (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                  <div className="bg-[#161c27] rounded-3xl p-6 shadow-2xl max-w-xs w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200">
                    <div className="flex flex-col items-center text-center gap-4">
                      <div className="size-16 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-1 border border-red-500/20"><span className="material-symbols-outlined text-3xl">delete_forever</span></div>
                      <div><h3 className="text-xl font-bold mb-2 text-white">¿Eliminar Escala?</h3><p className="text-sm text-gray-400 leading-relaxed">¿Estás seguro de que quieres eliminar permanentemente esta escala?</p></div>
                      <div className="flex gap-3 w-full mt-3">
                        <button onClick={() => setScaleToDelete(null)} className="flex-1 h-12 rounded-xl font-bold text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors">Cancelar</button>
                        <button onClick={confirmDelete} className="flex-1 h-12 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 shadow-lg shadow-red-500/30 transition-all active:scale-95">Eliminar</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              <BottomNav activeTab="scales" />
            </div>
          );
        };

        const CreateScaleScreen = () => {
          const navigate = useNavigate();
          const { id } = useParams();
          const [scaleName, setScaleName] = useState('');
          const [selectedDuration, setSelectedDuration] = useState('quarter');
          const [sequence, setSequence] = useState([]);
          const [showClearModal, setShowClearModal] = useState(false);
          const [currentOctave, setCurrentOctave] = useState(4);

          useEffect(() => {
            if (id) {
              try {
                const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
                const scaleToEdit = savedScales.find(s => s.id.toString() === id.toString());
                if (scaleToEdit) { setScaleName(scaleToEdit.name); setSequence(scaleToEdit.notes); } else { navigate('/scales'); }
              } catch (e) { console.error("Error loading scale to edit", e); navigate('/scales'); }
            }
          }, [id, navigate]);
          const addNote = (note) => {
            const newItem = { note, duration: selectedDuration };
            setSequence([...sequence, newItem]);
            // Sample based audio
            audioService.playNote(note, 0.4);
          };
          const undo = () => { setSequence(prev => prev.slice(0, -1)); };
          const requestClear = (e) => { e.preventDefault(); e.stopPropagation(); setShowClearModal(true); };
          const confirmClear = () => { setSequence([]); setShowClearModal(false); };
          const handleSave = () => {
            if (!scaleName.trim()) { alert("Por favor, ingresa un nombre para la escala."); return; }
            if (sequence.length === 0) { alert("Por favor, añade al menos una nota."); return; }
            try {
              const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (id) {
                const updatedScales = savedScales.map(s => s.id.toString() === id.toString() ? { ...s, name: scaleName, notes: sequence } : s);
                localStorage.setItem('vocal_scales', JSON.stringify(updatedScales));
              } else {
                const newScale = { id: Date.now().toString(), name: scaleName, notes: sequence, createdAt: Date.now() };
                localStorage.setItem('vocal_scales', JSON.stringify([...savedScales, newScale]));
              }
              navigate('/scales');
            } catch (e) { console.error("Error saving scale", e); }
          };
          const playSequence = async () => { if (sequence.length === 0) return; await audioService.playSequence(sequence); };
          const durationLabels = { whole: 'Redonda', half: 'Blanca', quarter: 'Negra', eighth: 'Corchea' };
          const baseNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
          const whiteKeys = [
            ...baseNotes.map(n => `${n}${currentOctave}`),
            `C${currentOctave + 1}`
          ];
          const blackKeysConfig = [ { noteBase: 'C#', left: '8.5%' }, { noteBase: 'D#', left: '21%' }, { noteBase: 'F#', left: '46%' }, { noteBase: 'G#', left: '58.5%' }, { noteBase: 'A#', left: '71%' } ];

          return (
            <div className="relative flex h-screen w-full flex-col overflow-hidden max-w-md mx-auto bg-[#0b0f17] shadow-2xl text-white font-display">
              <header className="flex items-center justify-between p-4 shrink-0 relative z-[400] bg-[#0b0f17] border-b border-white/5">
                <button type="button" onClick={() => navigate('/scales')} className="flex items-center justify-center size-12 text-slate-400 hover:text-white transition-colors active:scale-90 cursor-pointer" aria-label="Cerrar"><span className="material-symbols-outlined text-[36px] pointer-events-none">close</span></button>
                <h1 className="text-xl font-bold tracking-tight">{id ? 'Editar Escala' : 'Nueva Escala'}</h1>
                <button type="button" onClick={handleSave} className="bg-primary px-5 h-10 rounded-xl text-white font-black text-xs uppercase tracking-widest active:scale-95 shadow-glow cursor-pointer">{id ? 'Listo' : 'Guardar'}</button>
              </header>
              <main className="flex-1 overflow-y-auto no-scrollbar pb-[340px] px-5 pt-6 relative z-10">
                <div className="mb-6">
                  <label className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Nombre</label>
                  <input value={scaleName} onChange={(e) => setScaleName(e.target.value)} className="w-full bg-[#161c27] border border-gray-800 rounded-2xl px-5 py-4 text-base focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" placeholder="Ej. Mi Escala..." />
                </div>
                <div className="mb-8">
                  <span className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Duración</span>
                  <div className="flex p-1.5 bg-[#1c1f27] rounded-2xl">
                    {['whole', 'half', 'quarter', 'eighth'].map((dur) => (
                      <button key={dur} type="button" onClick={() => setSelectedDuration(dur)} className={`flex-1 h-11 flex items-center justify-center rounded-xl text-[10px] font-black transition-all ${selectedDuration === dur ? 'bg-[#32394a] text-primary shadow-xl ring-1 ring-white/5' : 'text-slate-600'}`}>{durationLabels[dur]}</button>
                    ))}
                  </div>
                </div>
                <div className="mb-2 flex items-center justify-between relative z-[100]">
                  <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest">Secuencia Visual</h3>
                  <div className="flex items-center gap-3">
                    <span className="text-[10px] text-primary font-black uppercase bg-primary/10 px-2 py-0.5 rounded-full">{sequence.length} Notas</span>
                    {sequence.length > 0 && (<button type="button" onClick={requestClear} className="text-[10px] font-black text-red-500 hover:text-red-400 uppercase tracking-widest px-4 py-2 rounded-xl bg-red-500/10 hover:bg-red-500/20 active:scale-90 cursor-pointer pointer-events-auto transition-all">Limpiar</button>)}
                  </div>
                </div>
                <div className="h-44 bg-[#111620] border border-gray-800 rounded-3xl relative overflow-hidden flex items-center px-4 shadow-inner mt-4">
                  <div className="absolute inset-0 flex flex-col justify-center gap-[12px] opacity-10 pointer-events-none px-6">{[1, 2, 3, 4, 5].map(i => <div key={i} className="h-[1.5px] w-full bg-white"></div>)}</div>
                  <div className="flex gap-6 overflow-x-auto no-scrollbar w-full py-6 z-10 items-center">
                    {sequence.length === 0 ? (
                      <div className="w-full text-center flex flex-col items-center gap-2 opacity-30"><span className="material-symbols-outlined text-4xl">music_note</span><span className="text-[10px] font-black uppercase">Toca el piano para añadir notas</span></div>
                    ) : (
                      sequence.map((item, idx) => (
                        <div key={idx} className="flex flex-col items-center gap-3 shrink-0">
                          <div className={`size-14 rounded-full flex items-center justify-center shadow-2xl ring-4 ${idx === sequence.length - 1 ? 'bg-primary ring-primary/20 scale-110' : 'bg-[#32394a] ring-white/5'}`}><span className="text-sm font-black text-white">{item.note}</span></div>
                          <span className="text-[8px] font-black text-slate-500 uppercase">{durationLabels[item.duration].slice(0, 3)}</span>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </main>
              <div className="absolute bottom-0 w-full bg-[#151921] border-t border-gray-800 shadow-[0_-15px_40px_rgba(0,0,0,0.6)] z-[200] flex flex-col pointer-events-auto">
                <div className="flex items-center justify-between px-4 py-4 gap-2">
                  <button type="button" onClick={playSequence} disabled={sequence.length === 0} className={`flex items-center gap-2 active:scale-95 transition-all shrink-0 ${sequence.length === 0 ? 'opacity-20 grayscale' : 'text-primary'}`}><span className="material-symbols-outlined fill-1 text-[36px] pointer-events-none">play_circle</span></button>
                  <div className="flex items-center justify-center gap-1 bg-[#0b0f17] p-1 rounded-xl border border-white/5">
                    {[3, 4, 5].map(oct => (
                      <button key={oct} onClick={() => setCurrentOctave(oct)} className={`h-8 w-10 rounded-lg text-[10px] font-black transition-all ${currentOctave === oct ? 'bg-primary text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>C{oct}</button>
                    ))}
                  </div>
                  <div className="flex items-center gap-3 shrink-0">
                    <button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">undo</span></button>
                    <button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">backspace</span></button>
                  </div>
                </div>
                <div className="relative h-64 w-full select-none bg-[#101622] flex border-t border-white/5">
                  {whiteKeys.map((note) => (
                    <div key={note} onClick={() => addNote(note)} className="relative flex-1 bg-white border-r border-slate-300 rounded-b-2xl active:bg-slate-200 cursor-pointer shadow-inner"><span className="absolute bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-400 uppercase pointer-events-none">{note}</span></div>
                  ))}
                  {blackKeysConfig.map((bk) => {
                    const noteName = `${bk.noteBase}${currentOctave}`;
                    return (<div key={noteName} onClick={() => addNote(noteName)} style={{ left: bk.left }} className="absolute top-0 w-[10%] h-[55%] bg-[#1a1f2b] border border-black rounded-b-xl z-10 active:bg-slate-800 shadow-2xl cursor-pointer"></div>);
                  })}
                </div>
              </div>
              {showClearModal && (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                  <div className="bg-[#161c27] rounded-3xl p-6 shadow-2xl max-w-xs w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200">
                    <div className="flex flex-col items-center text-center gap-4">
                      <div className="size-16 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500 mb-1 border border-orange-500/20"><span className="material-symbols-outlined text-3xl">cleaning_services</span></div>
                      <div><h3 className="text-xl font-bold mb-2 text-white">¿Limpiar Notas?</h3><p className="text-sm text-gray-400 leading-relaxed">¿Deseas borrar toda la secuencia de notas actual?</p></div>
                      <div className="flex gap-3 w-full mt-3">
                        <button onClick={() => setShowClearModal(false)} className="flex-1 h-12 rounded-xl font-bold text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors">Cancelar</button>
                        <button onClick={confirmClear} className="flex-1 h-12 rounded-xl font-bold text-white bg-orange-500 hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all active:scale-95">Borrar Todo</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const App = () => (
            <HashRouter>
                <div className="max-w-md mx-auto bg-background-light dark:bg-background-dark min-h-screen shadow-2xl overflow-hidden relative border-x border-gray-200 dark:border-gray-800">
                    <Routes>
                        <Route path="/" element={<HomeScreen />} />
                        <Route path="/metronome" element={<MetronomeScreen />} />
                        <Route path="/health" element={<HealthScreen />} />
                        <Route path="/scales" element={<ScalesScreen />} />
                        <Route path="/create-scale" element={<CreateScaleScreen />} />
                        <Route path="/edit-scale/:id" element={<CreateScaleScreen />} />
                    </Routes>
                </div>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>--- END OF FILE standalone.html ---