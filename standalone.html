<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>VocalTune Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React & Libraries (UMD Version - Robust for Standalone) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1c2333",
                        "surface-border": "#2e3440",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    boxShadow: {
                        "glow": "0 0 20px rgba(19, 91, 236, 0.4)",
                    }
                },
            },
        }
    </script>
    <style>
        body { background-color: #101622; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Desktop Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b4354;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #135bec;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar-h {
            scrollbar-width: thin;
            scrollbar-color: #3b4354 transparent;
        }

        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; border: 2px solid #135bec; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #3b4354; border-radius: 2px; }
    </style>
</head>
<body class="font-display antialiased text-slate-900 dark:text-white">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams } = ReactRouterDOM;

        // --- CONSTANTS ---
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTE_FREQUENCIES = { "C1": 32.7, "C#1": 34.65, "D1": 36.71, "D#1": 38.89, "E1": 41.2, "F1": 43.65, "F#1": 46.25, "G1": 49, "G#1": 51.91, "A1": 55, "A#1": 58.27, "B1": 61.74, "C2": 65.41, "C#2": 69.3, "D2": 73.42, "D#2": 77.78, "E2": 82.41, "F2": 87.31, "F#2": 92.5, "G2": 98, "G#2": 103.83, "A2": 110, "A#2": 116.54, "B2": 123.47, "C3": 130.81, "C#3": 138.59, "D3": 146.83, "D#3": 155.56, "E3": 164.81, "F3": 174.61, "F#3": 185, "G3": 196, "G#3": 207.65, "A3": 220, "A#3": 233.08, "B3": 246.94, "C4": 261.63, "C#4": 277.18, "D4": 293.66, "D#4": 311.13, "E4": 329.63, "F4": 349.23, "F#4": 369.99, "G4": 392, "G#4": 415.3, "A4": 440, "A#4": 466.16, "B4": 493.88, "C5": 523.25, "C#5": 554.37, "D5": 587.33, "D#5": 622.25, "E5": 659.25, "F5": 698.46, "F#5": 739.99, "G5": 783.99, "G#5": 830.61, "A5": 880, "A#5": 932.33, "B5": 987.77, "C6": 1046.5, "C#6": 1108.73, "D6": 1174.66, "D#6": 1244.51, "E6": 1318.51, "F6": 1396.91, "F#6": 1479.98, "G6": 1567.98, "G#6": 1661.22, "A6": 1760, "A#6": 1864.66, "B6": 1975.53 };
        const SCALE_INTERVALS = { 'Mayor': [0, 2, 4, 5, 7, 9, 11, 12], 'Menor Natural': [0, 2, 3, 5, 7, 8, 10, 12], 'Menor': [0, 2, 3, 5, 7, 8, 10, 12], 'Cromática': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'Dórica': [0, 2, 3, 5, 7, 9, 10, 12], 'Flamenca': [0, 2, 3, 5, 7, 8, 11, 12], 'Flamenca 8va Descendente': [0, 12, 11, 8, 7, 5, 3, 2, 0], 'Aumentada': [0, 3, 4, 7, 8, 11, 12], 'Arpegio Mayor': [0, 4, 7, 12], 'Arpegio Menor': [0, 3, 7, 12], 'Arpegio Disminuido': [0, 3, 6, 9, 12], 'Rossini': [0, 4, 7, 12, 16, 19, 17, 14, 11, 7, 5, 2, 0], 'Progresión por Terceras': [0, 4, 2, 5, 4, 7, 5, 9, 7, 11, 9, 12, 11, 14, 12], 'Rossini Arpeggio': [0, 4, 7, 11, 12], 'Pentatónica Mayor': [0, 2, 4, 7, 9, 12], 'Pentatónica Menor': [0, 3, 5, 7, 10, 12], 'Blues': [0, 3, 5, 6, 7, 10, 12] };
        const HEALTH_TIPS = [{ id: 1, title: "Hidratación Inteligente", icon: "water_drop", content: "Las cuerdas vocales vibran mejor cuando están bien lubricadas. Bebe agua a lo largo del día...", source: "NIDCD", sourceUrl: "https://www.nidcd.nih.gov/" }, { id: 2, title: "Descanso Vocal", icon: "bedtime", content: "Si has cantado mucho, intenta periodos de 15-20 minutos de silencio...", source: "Duke Health", sourceUrl: "https://www.dukehealth.org/" }, { id: 3, title: "Evita el Carraspeo", icon: "do_not_touch", content: "Carraspear golpea violentamente las cuerdas vocales...", source: "Texas Voice Center", sourceUrl: "https://www.texasvoicecenter.com/" }, { id: 4, title: "Calentamiento", icon: "self_improvement", content: "Nunca cantes 'en frío'...", source: "British Voice Association", sourceUrl: "https://www.britishvoiceassociation.org.uk/" }, { id: 5, title: "Reflujo", icon: "restaurant", content: "El reflujo gastroesofágico puede quemar las cuerdas vocales...", source: "Cleveland Clinic", sourceUrl: "https://my.clevelandclinic.org/" }];
        
        // --- AUDIO SERVICE ---
        class PianoAudioService {
            constructor() { this.ctx = null; this.buffers = {}; this.activeSources = []; this.currentPlaybackId = 0; this.noteMap = { "C#": "Db", "D#": "Eb", "F#": "Gb", "G#": "Ab", "A#": "Bb" }; ['click', 'touchstart', 'touchend', 'keydown'].forEach(evt => document.addEventListener(evt, () => { this.initContext(); if (this.ctx && this.ctx.state !== 'running') this.ctx.resume(); }, { once: true })); }
            initContext() { if (!this.ctx) { const AudioContext = window.AudioContext || window.webkitAudioContext; if (AudioContext) { this.ctx = new AudioContext(); } } }
            stop() { this.currentPlaybackId++; this.activeSources.forEach(s => { try { s.stop(); s.disconnect(); } catch (e) {} }); this.activeSources = []; }
            mapNoteToFileName(note) { const match = note.match(/^([A-G][#]?)(-?\d+)$/); if (!match) return note; let [_, name, octave] = match; if (this.noteMap[name]) name = this.noteMap[name]; return `${name}${octave}`; }
            async fetchSample(noteFile) { const response = await fetch(`https://raw.githubusercontent.com/fuhton/piano-mp3/master/piano-mp3/${noteFile}.mp3`); const ab = await response.arrayBuffer(); if (this.ctx) return await this.ctx.decodeAudioData(ab); throw new Error("No ctx"); }
            async preloadNotes(notes) { const unique = [...new Set(notes)]; await Promise.all(unique.map(async (n) => { const f = this.mapNoteToFileName(n); if (!this.buffers[f]) { try { this.buffers[f] = await this.fetchSample(f); } catch (e) {} } })); }
            playBufferAt(buffer, startTime, duration, volume = 2.5) { if (!this.ctx) return; const s = this.ctx.createBufferSource(); const g = this.ctx.createGain(); s.buffer = buffer; s.connect(g); g.connect(this.ctx.destination); g.gain.setValueAtTime(0, startTime); g.gain.linearRampToValueAtTime(volume, startTime + 0.02); g.gain.setValueAtTime(volume * 0.8, startTime + duration); g.gain.exponentialRampToValueAtTime(0.001, startTime + duration + 1.5); s.start(startTime); s.stop(startTime + duration + 2.0); this.activeSources.push(s); s.onended = () => { this.activeSources = this.activeSources.filter(x => x !== s); }; }
            playSynthToneAt(freq, startTime, duration) { if (!this.ctx) return; const osc = this.ctx.createOscillator(); const g = this.ctx.createGain(); const real = new Float32Array([0, 1, 0.4, 0.2, 0.1]); const imag = new Float32Array(real.length).fill(0); const wave = this.ctx.createPeriodicWave(real, imag); osc.setPeriodicWave(wave); osc.frequency.setValueAtTime(freq, startTime); g.gain.setValueAtTime(0, startTime); g.gain.linearRampToValueAtTime(0.8, startTime + 0.01); g.gain.exponentialRampToValueAtTime(0.001, startTime + duration); osc.connect(g); g.connect(this.ctx.destination); osc.start(startTime); osc.stop(startTime + duration + 0.1); this.activeSources.push(osc); osc.onended = () => { this.activeSources = this.activeSources.filter(x => x !== osc); }; }
            playClickAt(startTime) { if (!this.ctx) return; const osc = this.ctx.createOscillator(); const g = this.ctx.createGain(); osc.frequency.setValueAtTime(1000, startTime); osc.frequency.exponentialRampToValueAtTime(1, startTime + 0.05); g.gain.setValueAtTime(0.7, startTime); g.gain.exponentialRampToValueAtTime(0.001, startTime + 0.05); osc.connect(g); g.connect(this.ctx.destination); osc.start(startTime); osc.stop(startTime + 0.05); }
            wait(s) { return new Promise(r => setTimeout(r, s * 1000)); }
            async playNote(note, duration = 0.5) { this.initContext(); if (!this.ctx) return; if (typeof note === 'number') { this.playSynthToneAt(note, this.ctx.currentTime, duration); return; } const f = this.mapNoteToFileName(note); if (this.buffers[f]) { this.playBufferAt(this.buffers[f], this.ctx.currentTime, duration); } else { try { const b = await this.fetchSample(f); this.buffers[f] = b; this.playBufferAt(b, this.ctx.currentTime, duration); } catch (e) { const freq = NOTE_FREQUENCIES[note] || 440; this.playSynthToneAt(freq, this.ctx.currentTime, duration); } } }
            getNoteFrequencyFromFullString(n) { return NOTE_FREQUENCIES[n] || 440; }
            async playChord(rootAbs, scaleId, dur, runId) { if (this.currentPlaybackId !== runId) return; let intervals = [0, 4, 7]; const lid = scaleId.toLowerCase(); if (lid.includes('menor') || lid.includes('dórica') || lid.includes('blues')) intervals = [0, 3, 7]; else if (lid.includes('disminuido')) intervals = [0, 3, 6]; const notes = intervals.map(i => { const a = rootAbs + i; return `${NOTES[a % 12]}${Math.floor(a / 12)}`; }); const st = this.ctx.currentTime; notes.forEach(n => { const f = this.mapNoteToFileName(n); if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur, 1.8); else this.playSynthToneAt(NOTE_FREQUENCIES[n] || 440, st, dur); }); }
            async playSequence(seq, bpm = 120, onStep) { this.stop(); this.initContext(); if (!this.ctx) return; const runId = ++this.currentPlaybackId; const beat = 60 / bpm; const durMap = { 'whole': beat * 4, 'half': beat * 2, 'quarter': beat, 'eighth': beat * 0.5 }; await this.preloadNotes(seq.map(s => s.note)); for (let i = 0; i < seq.length; i++) { if (this.currentPlaybackId !== runId) break; const item = seq[i]; const dur = durMap[item.duration]; const f = this.mapNoteToFileName(item.note); const st = this.ctx.currentTime; if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur); else this.playSynthToneAt(NOTE_FREQUENCIES[item.note] || 440, st, dur); if (onStep) onStep(i); await this.wait(dur); } }
            async playCustomElasticScale(root, startOct, endOct, relSeq, bpm = 120) { this.stop(); this.initContext(); if (!this.ctx) return; const runId = ++this.currentPlaybackId; const beat = 60 / bpm; const durMap = { 'whole': beat * 4, 'half': beat * 2, 'quarter': beat, 'eighth': beat * 0.5 }; const rootIdx = NOTES.indexOf(root); const startAbs = (startOct * 12) + rootIdx; const endAbs = (endOct * 12) + rootIdx; const preload = []; for (let i = startAbs; i <= endAbs + 24; i++) preload.push(`${NOTES[i % 12]}${Math.floor(i / 12)}`); await this.preloadNotes(preload); let curr = startAbs; while (curr <= endAbs) { if (this.currentPlaybackId !== runId) return; for (let i = 0; i < relSeq.length; i++) { if (this.currentPlaybackId !== runId) return; const item = relSeq[i]; const abs = curr + item.interval; const full = `${NOTES[abs % 12]}${Math.floor(abs / 12)}`; const dur = durMap[item.duration]; const f = this.mapNoteToFileName(full); const st = this.ctx.currentTime; if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, dur); else this.playSynthToneAt(NOTE_FREQUENCIES[full] || 440, st, dur); await this.wait(dur); } if (this.currentPlaybackId !== runId) return; await this.wait(1.0); curr++; } }
            async playScale(root, startOct, endOct, intervals, bpm = 100, useMetro = false, scaleId = 'Mayor', onStep) { this.stop(); this.initContext(); if (!this.ctx) return; const runId = ++this.currentPlaybackId; const beat = 60 / bpm; const rootIdx = NOTES.indexOf(root); const startAbs = (startOct * 12) + rootIdx; const endAbs = (endOct * 12) + rootIdx; const actStart = Math.min(startAbs, endAbs); const actEnd = Math.max(startAbs, endAbs); const preload = []; for (let i = actStart; i <= actEnd + 24; i++) preload.push(`${NOTES[i % 12]}${Math.floor(i / 12)}`); await this.preloadNotes(preload); let curr = actStart; while (curr <= actEnd) { if (this.currentPlaybackId !== runId) return; let seq = []; let noteDur = beat * 0.5; if (scaleId === 'Rossini' || scaleId === 'Flamenca 8va Descendente') { noteDur = beat * 0.25; intervals.forEach(i => seq.push(`${NOTES[(curr + i) % 12]}${Math.floor((curr + i) / 12)}`)); } else { const notes = intervals.map(i => `${NOTES[(curr + i) % 12]}${Math.floor((curr + i) / 12)}`); seq = [...notes, ...[...notes].reverse().slice(1)]; } for (let i = 0; i < seq.length; i++) { if (this.currentPlaybackId !== runId) return; const n = seq[i]; const st = this.ctx.currentTime; if (useMetro && i % 4 === 0) this.playClickAt(st); const f = this.mapNoteToFileName(n); if (this.buffers[f]) this.playBufferAt(this.buffers[f], st, noteDur); else this.playSynthToneAt(NOTE_FREQUENCIES[n] || 440, st, noteDur); if (onStep) onStep(i, seq.length); await this.wait(noteDur); } if (this.currentPlaybackId !== runId) return; await this.wait(1.0); if (useMetro) this.playClickAt(this.ctx.currentTime); await this.playChord(curr, scaleId, 1.5, runId); await this.wait(1.0); if (this.currentPlaybackId !== runId) return; if (curr < actEnd) { const next = curr + 1; if (useMetro) this.playClickAt(this.ctx.currentTime); await this.playChord(next, scaleId, 1.5, runId); await this.wait(1.0); } curr++; } }
        }
        const audioService = new PianoAudioService();

        // --- COMPONENTS ---
        const NavButton = ({ to, icon, label, active }) => (
            <Link to={to} className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${active ? 'text-primary scale-110' : 'text-slate-400 hover:text-slate-200'}`}>
                <span className={`material-symbols-outlined text-[24px] ${active ? 'fill-1' : ''}`}>{icon}</span>
                <span className="text-[10px] font-bold tracking-tight">{label}</span>
            </Link>
        );

        const BottomNav = ({ activeTab }) => (
          <nav className="fixed bottom-0 left-0 right-0 z-[100] bg-white dark:bg-[#151b26] border-t border-slate-200 dark:border-slate-800 shadow-lg backdrop-blur-md bg-opacity-95">
            <div className="max-w-screen-2xl mx-auto px-4">
              <div className="flex items-center justify-around h-16 max-w-2xl mx-auto">
                <NavButton to="/" icon="home" label="Inicio" active={activeTab === 'home'} />
                <NavButton to="/scales" icon="library_music" label="Escalas" active={activeTab === 'scales'} />
                <NavButton to="/health" icon="health_and_safety" label="Salud" active={activeTab === 'health'} />
                <NavButton to="/metronome" icon="timer" label="Tempo" active={activeTab === 'metronome'} />
              </div>
              <div className="h-1.5 flex justify-center pb-2">
                <div className="w-32 h-1 bg-slate-300 dark:bg-slate-700 rounded-full"></div>
              </div>
            </div>
          </nav>
        );

        // --- SCREENS ---

        const HomeScreen = () => {
          const navigate = useNavigate();
          const [selectedScaleId, setSelectedScaleId] = useState("Mayor");
          const [selectedNote, setSelectedNote] = useState("D");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);
          const [isMetronomeOn, setIsMetronomeOn] = useState(false);
          const [isPlaying, setIsPlaying] = useState(false);
          const [isDarkMode, setIsDarkMode] = useState(true);
          const isProcessingRef = useRef(false);

          useEffect(() => {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') { document.documentElement.classList.add('dark'); setIsDarkMode(true); } 
            else { document.documentElement.classList.remove('dark'); setIsDarkMode(false); }
          }, []);

          const toggleDarkMode = () => {
            const next = !isDarkMode;
            setIsDarkMode(next);
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', next ? 'dark' : 'light');
          };

          const handleStart = async () => {
            if (isPlaying) { audioService.stop(); setIsPlaying(false); return; }
            if (isProcessingRef.current) return;
            isProcessingRef.current = true;
            try {
              setIsPlaying(true);
              await new Promise(resolve => setTimeout(resolve, 50));
              const intervals = SCALE_INTERVALS[selectedScaleId] || SCALE_INTERVALS['Mayor'];
              await audioService.playScale(selectedNote, startOctave, endOctave, intervals, bpm, isMetronomeOn, selectedScaleId);
              setIsPlaying(false);
            } catch (error) { console.error("Error en reproducción:", error); setIsPlaying(false); } finally { isProcessingRef.current = false; }
          };

          const ScaleButton = ({ label }) => (
            <button onClick={() => setSelectedScaleId(label)} className={`flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg px-4 transition-all active:scale-95 border whitespace-nowrap ${selectedScaleId === label ? 'bg-primary text-white shadow-lg shadow-primary/20 border-transparent' : 'bg-surface-light dark:bg-surface-dark text-gray-700 dark:text-white border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}`}>
              <span className="text-sm font-semibold leading-normal">{label}</span>
            </button>
          );

          return (
            <div className="relative flex h-full min-h-screen w-full flex-col bg-background-light dark:bg-background-dark overflow-x-hidden transition-colors duration-200">
              <div className="sticky top-0 z-20 flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-200 dark:border-gray-800 transition-colors duration-200">
                <h1 className="text-gray-900 dark:text-white text-xl font-bold leading-tight tracking-[-0.015em] flex-1">Vocalización</h1>
                <div className="flex w-12 items-center justify-end">
                  <button onClick={toggleDarkMode} className="flex max-w-[48px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-transparent text-gray-900 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined">{isDarkMode ? 'light_mode' : 'dark_mode'}</span></button>
                </div>
              </div>

              <div className="flex-1 px-4 lg:px-8 pb-48 pt-4">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-screen-xl mx-auto">
                  <div className="flex flex-col gap-6">
                    <div className="flex flex-col">
                      <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-4">Selecciona una escala</h2>
                      <div className="flex flex-col gap-6">
                        {[{ title: "Escalas Básicas", list: ["Mayor", "Menor Natural", "Cromática"] }, { title: "Modales y Variaciones", list: ["Dórica", "Flamenca", "Flamenca 8va Descendente", "Aumentada"] }, { title: "Arpegios", list: ["Arpegio Mayor", "Arpegio Menor", "Arpegio Disminuido"] }, { title: "Estilos y Pentatónicas", list: ["Rossini", "Progresión por Terceras", "Rossini Arpeggio", "Pentatónica Mayor", "Pentatónica Menor", "Blues"] }].map((group) => (
                          <div key={group.title} className="space-y-3">
                            <h3 className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider ml-1 border-l-2 border-primary pl-2">{group.title}</h3>
                            <div className="flex flex-wrap gap-2 md:gap-3 custom-scrollbar-h overflow-x-auto md:overflow-visible pb-2">
                              {group.list.map(label => <ScaleButton key={label} label={label} />)}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="flex flex-col">
                      <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-4">Elige la nota</h2>
                      <div className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-12 lg:grid-cols-6 gap-3 w-full">
                        {NOTES.map((note) => (
                          <button key={note} onClick={() => { setSelectedNote(note); audioService.playNote(`${note}${startOctave}`, 0.3); }} className={`flex cursor-pointer items-center justify-center rounded-xl h-14 text-lg font-bold leading-normal transition-all active:scale-95 ${selectedNote === note ? 'bg-primary text-white shadow-lg shadow-primary/25 ring-2 ring-primary ring-offset-2 ring-offset-background-light dark:ring-offset-background-dark' : 'bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white hover:border-primary/50'}`}>
                            {note}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col gap-8">
                    <div className="flex flex-col">
                      <h2 className="text-gray-900 dark:text-white tracking-light text-[22px] font-bold leading-tight text-left pb-4">Configuración de Escala</h2>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="flex flex-col">
                          <label className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2">Octava Inicial</label>
                          <div className="relative">
                            <select value={startOctave} onChange={(e) => setStartOctave(Number(e.target.value))} className="w-full h-12 rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-base font-bold px-4 appearance-none outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-colors cursor-pointer">
                              {[1, 2, 3, 4, 5, 6].map(num => (<option key={num} value={num}>{num}</option>))}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 dark:text-gray-400"><span className="material-symbols-outlined">expand_more</span></div>
                          </div>
                        </div>
                        <div className="flex flex-col">
                          <label className="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider mb-2">Octava Final</label>
                          <div className="relative">
                            <select value={endOctave} onChange={(e) => setEndOctave(Number(e.target.value))} className="w-full h-12 rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white text-base font-bold px-4 appearance-none outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-colors cursor-pointer">
                              {[1, 2, 3, 4, 5, 6].map(num => (<option key={num} value={num}>{num}</option>))}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500 dark:text-gray-400"><span className="material-symbols-outlined">expand_more</span></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="w-full bg-surface-light dark:bg-surface-dark rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                      <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                          <div className="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-primary"><span className="material-symbols-outlined text-xl">timer</span></div>
                          <h3 className="text-gray-900 dark:text-white font-bold text-xl">Metrónomo</h3>
                        </div>
                        <label className="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" className="sr-only peer" checked={isMetronomeOn} onChange={() => setIsMetronomeOn(!isMetronomeOn)} />
                          <div className="w-14 h-7 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-primary/20 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                      </div>
                      <div className="flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                          <span className="text-base font-medium text-gray-500 dark:text-gray-400">Velocidad de Ensayo</span>
                          <div className="bg-gray-100 dark:bg-gray-800 px-3 py-1.5 rounded-lg text-primary font-bold text-lg font-mono tracking-wider border border-primary/20">{bpm} BPM</div>
                        </div>
                        <div className="relative w-full h-8 flex items-center">
                          <input type="range" min="40" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-2.5 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-primary focus:outline-none focus:ring-0 z-10" />
                        </div>
                        <div className="flex justify-between text-[11px] text-gray-400 font-bold uppercase tracking-widest px-1"><span>Lento</span><span>Moderato</span><span>Rápido</span></div>
                      </div>
                    </div>
                    <div className="w-full bg-gradient-to-br from-primary/10 to-blue-500/5 dark:from-primary/20 dark:to-transparent rounded-2xl p-6 border border-primary/20 flex items-center justify-between shadow-sm">
                      <div className="flex flex-col gap-1">
                        <span className="text-xs text-gray-500 dark:text-slate-400 font-bold uppercase tracking-[0.2em]">Configuración Actual</span>
                        <span className="text-xl text-gray-900 dark:text-white font-black tracking-tight">{selectedNote} {selectedScaleId} <span className="text-primary font-normal mx-2">|</span> {startOctave}-{endOctave} Oct<span className="text-primary font-normal mx-2">|</span> {bpm} BPM</span>
                      </div>
                      <div className="h-12 w-12 rounded-2xl bg-primary text-white flex items-center justify-center shadow-lg shadow-primary/30"><span className="material-symbols-outlined text-2xl">music_note</span></div>
                    </div>
                  </div>
                </div>
              </div>
              <div className="fixed bottom-[4.5rem] left-0 right-0 z-50 flex justify-center px-4 pointer-events-none">
                <div className="pointer-events-auto shadow-2xl rounded-full overflow-hidden max-w-sm w-full mx-auto">
                  <button onClick={handleStart} className={`w-full h-16 font-black text-xl flex items-center justify-center gap-4 transition-all active:scale-[0.97] hover:brightness-110 border-2 ${isPlaying ? 'bg-red-500 text-white border-red-400 shadow-[0_0_30px_rgba(239,68,68,0.5)]' : 'bg-primary text-white border-blue-400 shadow-[0_0_30px_rgba(19,91,236,0.5)]'}`}>
                    <span className={`material-symbols-outlined text-4xl ${isPlaying ? '' : 'filled'}`}>{isPlaying ? 'stop' : 'play_circle'}</span>
                    <span className="tracking-tight">{isPlaying ? 'Detener' : 'Comenzar Ensayo'}</span>
                  </button>
                </div>
              </div>
              <BottomNav activeTab="home" />
            </div>
          );
        };

        const MetronomeScreen = () => {
          const navigate = useNavigate();
          const [bpm, setBpm] = useState(120);
          const [isPlaying, setIsPlaying] = useState(false);
          const [beat, setBeat] = useState(0);
          const [isMuted, setIsMuted] = useState(false);
          const [timeSignature, setTimeSignature] = useState('4/4');
          const [tapTimes, setTapTimes] = useState([]);
          const timerRef = useRef(null);
          const audioCtxRef = useRef(null);
          const getTempoName = (currentBpm) => { if (currentBpm <= 60) return 'Largo'; if (currentBpm <= 76) return 'Adagio'; if (currentBpm <= 108) return 'Andante'; if (currentBpm <= 120) return 'Moderato'; if (currentBpm <= 156) return 'Allegro'; if (currentBpm <= 176) return 'Vivace'; return 'Presto'; };
          const playClick = () => { if (isMuted) return; if (!audioCtxRef.current) { audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)(); } const ctx = audioCtxRef.current; if (ctx.state === 'suspended') ctx.resume(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.type = 'sine'; const isFirstBeat = beat === 0; osc.frequency.setValueAtTime(isFirstBeat ? 1000 : 500, ctx.currentTime); gain.gain.setValueAtTime(0.4, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1); osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1); };
          const handleTap = () => { const now = Date.now(); const newTapTimes = [...tapTimes, now].slice(-4); setTapTimes(newTapTimes); if (newTapTimes.length >= 2) { const intervals = []; for (let i = 1; i < newTapTimes.length; i++) { intervals.push(newTapTimes[i] - newTapTimes[i - 1]); } const averageInterval = intervals.reduce((a, b) => a + b) / intervals.length; const newBpm = Math.round(60000 / averageInterval); if (newBpm >= 40 && newBpm <= 220) { setBpm(newBpm); } } };
          useEffect(() => { if (isPlaying) { const beatsInCompas = timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6; const interval = (60 / bpm) * 1000; if (timerRef.current) clearInterval(timerRef.current); timerRef.current = window.setInterval(() => { setBeat(prev => (prev + 1) % beatsInCompas); playClick(); }, interval); } else { if (timerRef.current) clearInterval(timerRef.current); setBeat(0); } return () => { if (timerRef.current) clearInterval(timerRef.current); }; }, [isPlaying, bpm, beat, timeSignature, isMuted]);
          return (
            <div className="bg-[#0b0f17] font-display antialiased text-white h-screen flex flex-col relative w-full overflow-hidden">
              <div className="absolute top-[-10%] left-0 right-0 h-[50%] bg-gradient-to-b from-[#1a2542] to-transparent opacity-30 pointer-events-none"></div>
              <header className="flex items-center justify-between p-4 z-10 max-w-screen-2xl mx-auto w-full shrink-0 h-[70px]">
                <button onClick={() => navigate(-1)} className="p-2 rounded-2xl active:bg-white/10 transition-colors hover:bg-white/5"><span className="material-symbols-outlined text-[28px]">arrow_back</span></button>
                <h2 className="text-lg font-black tracking-tight uppercase">METRONOMO</h2>
                <button onClick={() => setIsMuted(!isMuted)} className="p-2 rounded-2xl active:bg-white/10 transition-colors hover:bg-white/5"><span className="material-symbols-outlined text-[28px]">{isMuted ? 'volume_off' : 'volume_up'}</span></button>
              </header>
              <main className="flex-1 w-full px-6 max-w-screen-2xl mx-auto pb-24 landscape:pb-4 md:pb-4 relative z-10 overflow-y-auto scrollbar-hide">
                <div className="flex flex-col landscape:flex-row md:flex-row items-center justify-around landscape:justify-center md:justify-center gap-8 landscape:gap-12 md:gap-16 w-full min-h-full py-2">
                  <div className="relative flex items-center justify-center shrink-0">
                    <svg className="rotate-[-90deg] w-[70vw] h-[70vw] max-w-[280px] max-h-[280px] landscape:w-[35vh] landscape:h-[35vh] landscape:max-w-[280px] landscape:max-h-[280px] md:w-[340px] md:h-[340px] lg:w-[420px] lg:h-[420px] transition-all duration-300">
                      <circle cx="50%" cy="50%" r="46%" fill="transparent" stroke="#1a2333" strokeWidth="8" />
                      <circle cx="50%" cy="50%" r="46%" fill="transparent" stroke="#135bec" strokeWidth="8" strokeDasharray="1000" strokeDashoffset={isPlaying ? (1000 - (1000 * (beat + 1)) / (timeSignature === '4/4' ? 4 : timeSignature === '3/4' ? 3 : 6)) : 1000} className="transition-all duration-150 ease-out" strokeLinecap="round" style={{ filter: 'drop-shadow(0 0 12px rgba(19, 91, 236, 0.8))' }} />
                    </svg>
                    <div className="absolute inset-0 m-auto rounded-full bg-[#111622] border-[4px] border-[#1a2333] shadow-[0_0_60px_rgba(0,0,0,0.7)] flex flex-col items-center justify-center z-10 w-[62vw] h-[62vw] max-w-[250px] max-h-[250px] landscape:w-[30vh] landscape:h-[30vh] landscape:max-w-[240px] landscape:max-h-[240px] md:w-[300px] md:h-[300px] lg:w-[370px] lg:h-[370px]">
                      <h1 className="text-6xl landscape:text-5xl md:text-8xl lg:text-9xl font-black tracking-tighter leading-none mb-1 drop-shadow-lg transition-all">{bpm}</h1>
                      <p className="text-primary font-black text-[9px] landscape:text-[9px] md:text-xs tracking-[0.3em] uppercase opacity-90 text-center px-4">Beats Per Minute</p>
                      <button onClick={() => setBpm(b => Math.max(40, b - 1))} className="absolute left-[-15px] md:left-[-25px] size-10 md:size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-2xl border-2 border-white/5 hover:bg-[#252c3c]"><span className="material-symbols-outlined text-xl md:text-3xl">remove</span></button>
                      <button onClick={() => setBpm(b => Math.min(220, b + 1))} className="absolute right-[-15px] md:right-[-25px] size-10 md:size-14 rounded-full bg-[#1c2333] flex items-center justify-center active:scale-90 transition-transform shadow-2xl border-2 border-white/5 hover:bg-[#252c3c]"><span className="material-symbols-outlined text-xl md:text-3xl">add</span></button>
                    </div>
                  </div>
                  <div className="flex flex-col w-full max-w-md gap-6 landscape:gap-3 md:gap-8 justify-center landscape:items-stretch">
                    <div className="space-y-4 bg-[#111622]/50 p-4 rounded-3xl border border-white/5 landscape:border-0 landscape:bg-transparent landscape:p-0">
                      <div className="flex items-center justify-between px-2">
                        <span className="text-xs font-black text-gray-500 uppercase tracking-[0.2em]">Tempo</span>
                        <span className="text-lg md:text-xl font-black text-primary uppercase tracking-widest drop-shadow-sm">{getTempoName(bpm)}</span>
                      </div>
                      <div className="w-full px-1">
                        <input type="range" min="40" max="220" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-3 bg-[#1c2333] rounded-full appearance-none cursor-pointer accent-primary" style={{ background: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(220-40)*100}%, #1c2333 ${(bpm-40)/(220-40)*100}%, #1c2333 100%)` }} />
                        <div className="flex justify-between mt-2 text-[9px] font-black text-gray-600 tracking-[0.2em] uppercase"><span>Adagio</span><span>Andante</span><span>Presto</span></div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 w-full h-14 md:h-16">
                      <button onClick={handleTap} className="bg-[#111622] border-2 border-white/5 rounded-2xl flex items-center justify-center gap-2 active:bg-[#1a2333] transition-all shadow-lg hover:border-primary/20 hover:shadow-primary/5"><span className="material-symbols-outlined text-primary text-2xl">back_hand</span><span className="text-xs font-black tracking-[0.2em]">TAP</span></button>
                      <div className="bg-[#111622] border-2 border-white/5 rounded-2xl flex items-center p-1 shadow-lg">
                        {['4/4', '3/4', '6/8'].map((sig) => (<button key={sig} onClick={() => setTimeSignature(sig)} className={`flex-1 h-full rounded-xl text-[10px] md:text-xs font-black transition-all ${timeSignature === sig ? 'bg-primary text-white shadow-md' : 'text-gray-500 hover:text-gray-300'}`}>{sig}</button>))}
                      </div>
                    </div>
                    <div className="flex justify-center pt-2"><button onClick={() => setIsPlaying(!isPlaying)} className={`size-20 landscape:size-14 md:size-24 rounded-full flex items-center justify-center transition-all active:scale-95 shadow-2xl ${isPlaying ? 'bg-white text-black' : 'bg-primary text-white shadow-primary/40'}`}><span className="material-symbols-outlined text-[40px] landscape:text-[28px] md:text-[48px] filled">{isPlaying ? 'pause' : 'play_arrow'}</span></button></div>
                  </div>
                </div>
              </main>
              <BottomNav activeTab="metronome" />
            </div>
          );
        };

        const HealthScreen = () => {
          return (
            <div className="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 antialiased overflow-x-hidden min-h-screen pb-24">
              <header className="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-4 pt-4 pb-3">
                <div className="max-w-screen-2xl mx-auto flex flex-col">
                  <div className="flex items-center justify-between mb-4">
                    <Link to="/" className="flex items-center justify-center p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><span className="material-symbols-outlined text-[28px]">arrow_back</span></Link>
                  </div>
                  <h1 className="text-3xl font-black tracking-tight">Salud Vocal</h1>
                  <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">Guía profesional para el cuidado de tu instrumento biológico.</p>
                </div>
              </header>
              <main className="max-w-screen-2xl mx-auto px-6 lg:px-12 pt-8 space-y-12">
                <section className="bg-surface-light dark:bg-surface-dark p-8 rounded-[40px] border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden relative">
                  <div className="flex flex-col lg:flex-row items-center gap-8 relative z-10">
                    <div className="h-20 w-20 rounded-3xl bg-primary/10 flex items-center justify-center text-primary shrink-0 rotate-3 border-2 border-primary/20"><span className="material-symbols-outlined text-4xl">medical_services</span></div>
                    <div className="text-center lg:text-left"><h2 className="text-2xl font-black mb-3">Cuidado Clínico & Profesional</h2><p className="text-base text-slate-600 dark:text-slate-300 leading-relaxed max-w-2xl">Estas recomendaciones están basadas en prácticas de medicina foniátrica. Mantener hábitos saludables es tan importante como la técnica vocal para una carrera longeva.</p></div>
                  </div>
                  <div className="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full blur-3xl -mr-16 -mt-16"></div>
                </section>
                <section className="space-y-8">
                  <div className="flex items-center justify-between border-b border-gray-200 dark:border-gray-800 pb-4"><h2 className="text-2xl font-black flex items-center gap-3"><span className="material-symbols-outlined text-green-500 filled">verified</span>Pautas de Oro</h2></div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {HEALTH_TIPS.map(tip => (
                      <div key={tip.id} className="bg-white dark:bg-[#1c2333] p-8 rounded-[32px] border border-gray-200 dark:border-gray-800 shadow-lg hover:shadow-2xl transition-all hover:-translate-y-1 flex flex-col h-full">
                        <div className="flex items-center gap-4 mb-6"><div className="h-12 w-12 rounded-2xl bg-primary text-white flex items-center justify-center shadow-lg shadow-primary/20"><span className="material-symbols-outlined text-2xl">{tip.icon}</span></div><h3 className="text-xl font-black leading-tight tracking-tight">{tip.title}</h3></div>
                        <p className="text-base text-slate-600 dark:text-slate-300 leading-relaxed mb-8 flex-1">{tip.content}</p>
                        <div className="flex items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-6 mt-auto"><span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Fuente Médica</span><a href={tip.sourceUrl} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs font-black text-primary hover:underline hover:brightness-125 transition-all">{tip.source}<span className="material-symbols-outlined text-sm">open_in_new</span></a></div>
                      </div>
                    ))}
                  </div>
                </section>
                <section className="bg-gradient-to-br from-primary/10 to-blue-600/10 rounded-[40px] p-8 border-2 border-primary/20 mb-12">
                  <div className="flex items-start gap-6"><div className="p-3 bg-white dark:bg-slate-900 rounded-2xl shadow-md"><span className="material-symbols-outlined text-primary text-3xl filled">info</span></div><div className="space-y-2"><h2 className="text-xl font-black tracking-tight">Dato Crucial</h2><p className="text-lg text-slate-700 dark:text-slate-200 leading-relaxed italic font-medium">"La disfonía persistente por más de 15 días requiere revisión diagnóstica por un otorrinolaringólogo especialista en laringe."</p></div></div>
                </section>
              </main>
              <BottomNav activeTab="health" />
            </div>
          );
        };

        const ScalesScreen = () => {
          const navigate = useNavigate();
          const [customScales, setCustomScales] = useState([]);
          const [playingId, setPlayingId] = useState(null);
          const [scaleToDelete, setScaleToDelete] = useState(null);
          const [selectedNote, setSelectedNote] = useState("C");
          const [startOctave, setStartOctave] = useState(3);
          const [endOctave, setEndOctave] = useState(4);
          const [bpm, setBpm] = useState(120);
          const loadScales = () => { try { const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]'); if (Array.isArray(saved)) { const formatted = saved.map(s => ({ ...s, id: s.id.toString() })); setCustomScales(formatted.sort((a, b) => b.createdAt - a.createdAt)); } } catch (e) { console.error("Error loading scales", e); setCustomScales([]); } };
          useEffect(() => { loadScales(); }, []);
          const calculateRelativesFromAbsolute = (notes) => { if (!notes || notes.length === 0) return []; const getVal = (n) => { const m = n.match(/^([A-G][#]?)(-?\d+)$/); if (!m) return 0; return (parseInt(m[2]) * 12) + NOTES.indexOf(m[1]); }; const rootVal = getVal(notes[0].note); return notes.map(n => ({ interval: getVal(n.note) - rootVal, duration: n.duration })); };
          const playCustom = async (e, scale) => { e.preventDefault(); e.stopPropagation(); if (playingId === scale.id) { audioService.stop(); setPlayingId(null); return; } if (playingId) { audioService.stop(); } setPlayingId(scale.id); if (scale.relativeNotes && scale.relativeNotes.length > 0) { await audioService.playCustomElasticScale(selectedNote, startOctave, endOctave, scale.relativeNotes, bpm); } else { const calculatedRelatives = calculateRelativesFromAbsolute(scale.notes); if (calculatedRelatives.length > 0) { await audioService.playCustomElasticScale(selectedNote, startOctave, endOctave, calculatedRelatives, bpm); } else { await audioService.playSequence(scale.notes, bpm); } } setPlayingId(null); };
          const requestDelete = (e, id) => { e.preventDefault(); e.stopPropagation(); setScaleToDelete(id); };
          const confirmDelete = () => { if (!scaleToDelete) return; try { const saved = JSON.parse(localStorage.getItem('vocal_scales') || '[]'); const updated = saved.filter(s => s.id.toString() !== scaleToDelete.toString()); localStorage.setItem('vocal_scales', JSON.stringify(updated)); const formattedUpdated = updated.map(s => ({ ...s, id: s.id.toString() })); setCustomScales(formattedUpdated.sort((a, b) => b.createdAt - a.createdAt)); setScaleToDelete(null); } catch (err) { console.error("Error al eliminar escala:", err); } };
          const editScale = (e, id) => { e.preventDefault(); e.stopPropagation(); navigate(`/edit-scale/${id}`); };
          return (
            <div className="bg-[#0b0f17] text-white min-h-screen pb-32 w-full relative font-display">
              <header className="max-w-screen-2xl mx-auto px-6 lg:px-12 pt-10 pb-6 border-b border-gray-800 relative z-[20]">
                <h1 className="text-3xl font-black tracking-tight">Biblioteca Vocal</h1>
                <p className="text-gray-500 mt-2 font-medium">Gestiona y entrena con tus escalas personalizadas.</p>
              </header>
              <div className="bg-[#111622] border-b border-gray-800 px-6 lg:px-12 py-6 sticky top-0 z-[30] shadow-2xl">
                <div className="flex flex-col lg:flex-row gap-6 max-w-screen-2xl mx-auto items-center">
                  <div className="flex flex-col gap-1 w-full lg:w-1/4">
                     <h3 className="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">Configuración Maestro</h3>
                     <div className="flex gap-3"><span className="text-xs bg-primary/20 text-primary px-3 py-1.5 rounded-lg font-black border border-primary/30 uppercase tracking-tighter">{selectedNote} {startOctave}-{endOctave} Oct</span><span className="text-xs bg-gray-800 text-gray-300 px-3 py-1.5 rounded-lg font-black border border-gray-700 uppercase tracking-tighter">{bpm} BPM</span></div>
                  </div>
                  <div className="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 w-full lg:flex-1">
                     <div className="relative"><select value={selectedNote} onChange={(e) => setSelectedNote(e.target.value)} className="w-full h-11 bg-[#1c2333] border border-gray-700 rounded-xl text-sm font-bold px-4 appearance-none outline-none focus:border-primary transition-all">{NOTES.map(n => <option key={n} value={n}>{n}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div></div>
                     <div className="relative"><select value={startOctave} onChange={(e) => setStartOctave(Number(e.target.value))} className="w-full h-11 bg-[#1c2333] border border-gray-700 rounded-xl text-sm font-bold px-4 appearance-none outline-none focus:border-primary transition-all">{[2, 3, 4, 5].map(n => <option key={n} value={n}>Octava {n}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div></div>
                     <div className="relative"><select value={endOctave} onChange={(e) => setEndOctave(Number(e.target.value))} className="w-full h-11 bg-[#1c2333] border border-gray-700 rounded-xl text-sm font-bold px-4 appearance-none outline-none focus:border-primary transition-all">{[2, 3, 4, 5, 6].map(n => <option key={n} value={n}>Octava {n}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><span className="material-symbols-outlined text-sm">expand_more</span></div></div>
                     <div className="col-span-3 lg:col-span-1 flex items-center px-2"><input type="range" min="40" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className="w-full h-2 bg-[#1c2333] rounded-lg appearance-none cursor-pointer accent-primary focus:outline-none z-10" style={{ backgroundImage: `linear-gradient(to right, #135bec 0%, #135bec ${(bpm-40)/(240-40)*100}%, #1c2333 ${(bpm-40)/(240-40)*100}%, #1c2333 100%)` }} /></div>
                  </div>
                </div>
              </div>
              <main className="px-6 lg:px-12 py-10 space-y-8 relative z-[10] max-w-screen-2xl mx-auto">
                <div className="flex items-center justify-between"><h2 className="text-xl font-black flex items-center gap-3"><span className="material-symbols-outlined text-primary text-3xl">auto_stories</span>Mis Escalas Personalizadas</h2><span className="text-xs text-gray-500 font-black uppercase tracking-[0.2em] bg-gray-800/50 px-3 py-1 rounded-full">{customScales.length} Ítems</span></div>
                {customScales.length === 0 ? (<div className="py-32 flex flex-col items-center justify-center text-center bg-white/[0.02] rounded-[40px] border-2 border-dashed border-gray-800"><span className="material-symbols-outlined text-7xl mb-6 opacity-20">music_off</span><p className="text-lg font-bold text-gray-400 mb-8 max-w-xs">Tu biblioteca está vacía. Comienza creando tu primera rutina vocal.</p><button type="button" onClick={() => navigate('/create-scale')} className="h-14 px-10 bg-primary text-white text-sm font-black rounded-2xl shadow-glow uppercase tracking-widest active:scale-95 transition-all hover:scale-105">Crear Nueva Escala</button></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">{customScales.map(scale => (<div key={scale.id} className={`bg-[#1c2333] p-6 rounded-[32px] border-2 transition-all relative group overflow-hidden ${playingId === scale.id ? 'border-primary shadow-glow ring-4 ring-primary/10' : 'border-gray-800 hover:border-gray-700'}`}><div className="flex flex-col gap-5 relative z-10"><div onClick={(e) => playCustom(e, scale)} className="flex items-center gap-4 cursor-pointer group/info"><div className={`size-14 rounded-2xl flex items-center justify-center transition-all shrink-0 ${playingId === scale.id ? 'bg-red-500 text-white shadow-xl shadow-red-500/30 rotate-3' : 'bg-primary/10 text-primary group-hover/info:bg-primary/20'}`}><span className="material-symbols-outlined text-3xl pointer-events-none">{playingId === scale.id ? 'stop' : 'play_arrow'}</span></div><div className="min-w-0"><h3 className={`font-black text-lg truncate leading-tight ${playingId === scale.id ? 'text-primary' : 'text-white'}`}>{scale.name}</h3><p className="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1">{scale.notes.length} Pasos • Patrón Vocal</p></div></div><div className="flex items-center gap-3 pt-2 border-t border-white/[0.05]"><button type="button" onClick={(e) => editScale(e, scale.id)} className="flex-1 h-11 rounded-xl bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white flex items-center justify-center gap-2 transition-all active:scale-90 font-bold text-sm border border-blue-500/20"><span className="material-symbols-outlined text-lg">edit</span>Editar</button><button type="button" onClick={(e) => requestDelete(e, scale.id)} className="size-11 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-600 hover:text-white flex items-center justify-center transition-all active:scale-90 border border-red-500/20"><span className="material-symbols-outlined text-xl">delete</span></button></div></div></div>))}</div>)}
              </main>
              <button type="button" onClick={() => navigate('/create-scale')} className="fixed bottom-24 right-8 size-16 rounded-3xl bg-primary text-white shadow-glow flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-[110] border-2 border-white/20"><span className="material-symbols-outlined text-4xl">add</span></button>
              {scaleToDelete && (<div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in duration-300"><div className="bg-[#161c27] rounded-[40px] p-10 shadow-2xl max-w-sm w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200"><div className="flex flex-col items-center text-center gap-6"><div className="size-24 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-2 border-2 border-red-500/20"><span className="material-symbols-outlined text-5xl">delete_forever</span></div><div><h3 className="text-2xl font-black mb-3 text-white tracking-tight">¿Eliminar Escala?</h3><p className="text-gray-400 font-medium leading-relaxed">Esta acción es permanente. Perderás la secuencia configurada para este entrenamiento.</p></div><div className="flex flex-col gap-3 w-full mt-2"><button onClick={confirmDelete} className="w-full h-14 rounded-2xl font-black text-white bg-red-500 hover:bg-red-600 shadow-xl shadow-red-500/30 transition-all active:scale-95 uppercase tracking-widest text-xs">Confirmar Eliminación</button><button onClick={() => setScaleToDelete(null)} className="w-full h-14 rounded-2xl font-bold text-gray-400 hover:text-white transition-colors">Cancelar</button></div></div></div></div>)}
            </div>
          );
        };

        const CreateScaleScreen = () => {
          const navigate = useNavigate();
          const { id } = useParams();
          const [scaleName, setScaleName] = useState('');
          const [selectedDuration, setSelectedDuration] = useState('quarter');
          const [sequence, setSequence] = useState([]);
          const [showClearModal, setShowClearModal] = useState(false);
          const [currentOctave, setCurrentOctave] = useState(4);
          useEffect(() => {
            if (id) {
              try {
                const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
                const scaleToEdit = savedScales.find(s => s.id.toString() === id.toString());
                if (scaleToEdit) { setScaleName(scaleToEdit.name); setSequence(scaleToEdit.notes); } else { navigate('/scales'); }
              } catch (e) { console.error("Error loading scale to edit", e); navigate('/scales'); }
            }
          }, [id, navigate]);
          const addNote = (note) => { const newItem = { note, duration: selectedDuration }; setSequence([...sequence, newItem]); audioService.playNote(note, 0.4); };
          const undo = () => { setSequence(prev => prev.slice(0, -1)); };
          const requestClear = (e) => { e.preventDefault(); e.stopPropagation(); setShowClearModal(true); };
          const confirmClear = () => { setSequence([]); setShowClearModal(false); };
          const getNoteValue = (noteStr) => { const match = noteStr.match(/^([A-G][#]?)(-?\d+)$/); if (!match) return 0; const [_, name, octaveStr] = match; const octave = parseInt(octaveStr, 10); const noteIndex = NOTES.indexOf(name); return (octave * 12) + noteIndex; };
          const handleSave = () => {
            if (!scaleName.trim()) { alert("Por favor, ingresa un nombre para la escala."); return; }
            if (sequence.length === 0) { alert("Por favor, añade al menos una nota."); return; }
            const rootNoteValue = getNoteValue(sequence[0].note);
            const relativeNotes = sequence.map(s => ({ interval: getNoteValue(s.note) - rootNoteValue, duration: s.duration }));
            try {
              const savedScales = JSON.parse(localStorage.getItem('vocal_scales') || '[]');
              if (id) {
                const updatedScales = savedScales.map(s => s.id.toString() === id.toString() ? { ...s, name: scaleName, notes: sequence, relativeNotes: relativeNotes } : s);
                localStorage.setItem('vocal_scales', JSON.stringify(updatedScales));
              } else {
                const newScale = { id: Date.now().toString(), name: scaleName, notes: sequence, relativeNotes: relativeNotes, createdAt: Date.now() };
                localStorage.setItem('vocal_scales', JSON.stringify([...savedScales, newScale]));
              }
              navigate('/scales');
            } catch (e) { console.error("Error saving scale", e); }
          };
          const playSequence = async () => { if (sequence.length === 0) return; await audioService.playSequence(sequence, 120); };
          const durationLabels = { whole: 'Redonda', half: 'Blanca', quarter: 'Negra', eighth: 'Corchea' };
          const baseNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
          const whiteKeys = [ ...baseNotes.map(n => `${n}${currentOctave}`), `C${currentOctave + 1}` ];
          const blackKeysConfig = [ { noteBase: 'C#', left: '8.5%' }, { noteBase: 'D#', left: '21%' }, { noteBase: 'F#', left: '46%' }, { noteBase: 'G#', left: '58.5%' }, { noteBase: 'A#', left: '71%' } ];
          return (
            <div className="relative flex h-[100dvh] w-full flex-col md:flex-row overflow-hidden bg-[#0b0f17] shadow-2xl text-white font-display">
              <div className="flex-1 flex flex-col h-full order-1 md:order-2 overflow-hidden relative z-10 md:border-l md:border-gray-800">
                <header className="flex items-center justify-between p-4 shrink-0 bg-[#0b0f17] border-b border-white/5"><button type="button" onClick={() => navigate('/scales')} className="flex items-center justify-center size-12 text-slate-400 hover:text-white transition-colors active:scale-90 cursor-pointer" aria-label="Cerrar"><span className="material-symbols-outlined text-[36px] pointer-events-none">close</span></button><h1 className="text-xl font-bold tracking-tight">{id ? 'Editar Escala' : 'Nueva Escala'}</h1><button type="button" onClick={handleSave} className="bg-primary px-5 h-10 rounded-xl text-white font-black text-xs uppercase tracking-widest active:scale-95 shadow-glow cursor-pointer">{id ? 'Listo' : 'Guardar'}</button></header>
                <main className="flex-1 overflow-y-auto no-scrollbar pb-[450px] md:pb-24 px-5 pt-6">
                    <div className="mb-6"><label className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Nombre</label><input value={scaleName} onChange={(e) => setScaleName(e.target.value)} className="w-full bg-[#161c27] border border-gray-800 rounded-2xl px-5 py-4 text-base focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" placeholder="Ej. Mi Escala..." /></div>
                    <div className="mb-8"><span className="block text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-3">Duración</span><div className="flex p-1.5 bg-[#1c1f27] rounded-2xl">{['whole', 'half', 'quarter', 'eighth'].map((dur) => (<button key={dur} type="button" onClick={() => setSelectedDuration(dur)} className={`flex-1 h-11 flex items-center justify-center rounded-xl text-[10px] font-black transition-all ${selectedDuration === dur ? 'bg-[#32394a] text-primary shadow-xl ring-1 ring-white/5' : 'text-slate-600'}`}>{durationLabels[dur]}</button>))}</div></div>
                    <div className="mb-2 flex items-center justify-between relative z-[100]"><h3 className="text-sm font-black text-slate-400 uppercase tracking-widest">Secuencia Visual</h3><div className="flex items-center gap-3"><span className="text-[10px] text-primary font-black uppercase bg-primary/10 px-2 py-0.5 rounded-full">{sequence.length} Notas</span>{sequence.length > 0 && (<button type="button" onClick={requestClear} className="text-[10px] font-black text-red-500 hover:text-red-400 uppercase tracking-widest px-4 py-2 rounded-xl bg-red-500/10 hover:bg-red-500/20 active:scale-90 cursor-pointer pointer-events-auto transition-all">Limpiar</button>)}</div></div>
                    <div className="h-44 bg-[#111620] border border-gray-800 rounded-3xl relative overflow-hidden flex items-center px-4 shadow-inner mt-4"><div className="absolute inset-0 flex flex-col justify-center gap-[12px] opacity-10 pointer-events-none px-6">{[1, 2, 3, 4, 5].map(i => <div key={i} className="h-[1.5px] w-full bg-white"></div>)}</div><div className="flex gap-6 overflow-x-auto no-scrollbar w-full py-6 z-10 items-center">{sequence.length === 0 ? (<div className="w-full text-center flex flex-col items-center gap-2 opacity-30"><span className="material-symbols-outlined text-4xl">music_note</span><span className="text-[10px] font-black uppercase">Toca el piano para añadir notas</span></div>) : (sequence.map((item, idx) => (<div key={idx} className="flex flex-col items-center gap-3 shrink-0"><div className={`size-14 rounded-full flex items-center justify-center shadow-2xl ring-4 ${idx === sequence.length - 1 ? 'bg-primary ring-primary/20 scale-110' : 'bg-[#32394a] ring-white/5'}`}><span className="text-sm font-black text-white">{item.note}</span></div><span className="text-[8px] font-black text-slate-500 uppercase">{durationLabels[item.duration].slice(0, 3)}</span></div>)))}</div></div>
                </main>
              </div>
              <div className="absolute bottom-16 w-full md:static md:w-5/12 lg:w-4/12 md:bottom-auto md:h-full bg-[#151921] border-t md:border-t-0 md:border-r border-gray-800 shadow-[0_-15px_40px_rgba(0,0,0,0.6)] md:shadow-none z-30 flex flex-col order-2 md:order-1 pointer-events-auto justify-end md:justify-center">
                <div className="flex items-center justify-between px-4 py-4 gap-2 md:mb-4"><button type="button" onClick={playSequence} disabled={sequence.length === 0} className={`flex items-center gap-2 active:scale-95 transition-all shrink-0 ${sequence.length === 0 ? 'opacity-20 grayscale' : 'text-primary'}`}><span className="material-symbols-outlined fill-1 text-[36px] pointer-events-none">play_circle</span></button><div className="flex items-center justify-center gap-1 bg-[#0b0f17] p-1 rounded-xl border border-white/5">{[3, 4, 5].map(oct => (<button key={oct} onClick={() => setCurrentOctave(oct)} className={`h-8 w-10 rounded-lg text-[10px] font-black transition-all ${currentOctave === oct ? 'bg-primary text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>C{oct}</button>))}</div><div className="flex items-center gap-3 shrink-0"><button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">undo</span></button><button type="button" onClick={undo} disabled={sequence.length === 0} className={`text-slate-500 active:text-white transition-all ${sequence.length === 0 ? 'opacity-20' : 'active:scale-90'} cursor-pointer`}><span className="material-symbols-outlined text-[28px] pointer-events-none">backspace</span></button></div></div>
                <div className="relative h-64 md:h-80 w-full select-none bg-[#101622] flex border-t border-white/5">{whiteKeys.map((note) => (<div key={note} onClick={() => addNote(note)} className="relative flex-1 bg-white border-r border-slate-300 rounded-b-2xl active:bg-slate-200 cursor-pointer shadow-inner"><span className="absolute bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-black text-slate-400 uppercase pointer-events-none">{note}</span></div>))}{blackKeysConfig.map((bk) => { const noteName = `${bk.noteBase}${currentOctave}`; return (<div key={noteName} onClick={() => addNote(noteName)} style={{ left: bk.left }} className="absolute top-0 w-[10%] h-[55%] bg-[#1a1f2b] border border-black rounded-b-xl z-10 active:bg-slate-800 shadow-2xl cursor-pointer"></div>); })}</div>
              </div>
              <div className="relative z-[1000]"><BottomNav activeTab="scales" /></div>
              {showClearModal && (<div className="fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-[#161c27] rounded-3xl p-6 shadow-2xl max-w-xs w-full border border-gray-700 transform scale-100 animate-in zoom-in-95 duration-200"><div className="flex flex-col items-center text-center gap-4"><div className="size-16 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500 mb-1 border border-orange-500/20"><span className="material-symbols-outlined text-3xl">cleaning_services</span></div><div><h3 className="text-xl font-bold mb-2 text-white">¿Limpiar Notas?</h3><p className="text-sm text-gray-400 leading-relaxed">¿Deseas borrar toda la secuencia de notas actual?</p></div><div className="flex gap-3 w-full mt-3"><button onClick={() => setShowClearModal(false)} className="flex-1 h-12 rounded-xl font-bold text-gray-300 bg-gray-800 hover:bg-gray-700 transition-colors">Cancelar</button><button onClick={confirmClear} className="flex-1 h-12 rounded-xl font-bold text-white bg-orange-500 hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all active:scale-95">Borrar Todo</button></div></div></div></div>)}
            </div>
          );
        };

        const App = () => (
            <HashRouter>
                <div className="max-w-md md:max-w-4xl mx-auto bg-background-light dark:bg-background-dark min-h-screen shadow-2xl overflow-hidden relative border-x border-gray-200 dark:border-gray-800">
                    <Routes>
                        <Route path="/" element={<HomeScreen />} />
                        <Route path="/metronome" element={<MetronomeScreen />} />
                        <Route path="/health" element={<HealthScreen />} />
                        <Route path="/scales" element={<ScalesScreen />} />
                        <Route path="/create-scale" element={<CreateScaleScreen />} />
                        <Route path="/edit-scale/:id" element={<CreateScaleScreen />} />
                    </Routes>
                </div>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>